# 多渠道与多模态集成落地方案

## 1. 目标与范围
- 接入多渠道（例如 Telegram/企业 IM/Webhook/Web 前端），实现统一消息入口与路由绑定。
- 引入多模态能力（语音/摄像/位置/TTS），在统一消息管线中完成解析与投递。
- 保持 wunder 现有 /wunder 调度与工作区体系，新增“渠道接入层 + 绑定路由器 + 多模态处理节点”。

## 2. 核心概念
- Channel Adapter：各渠道适配器，负责鉴权、收发消息、格式转换。
- Binding：规则化路由，将消息映射到 agent_id/session_id。
- Channel Session：渠道会话视角的会话标识，映射到 chat_sessions。
- Media Pipeline：多模态预处理（ASR/图像/位置解析）与结果回写。
- Outbox：统一出站投递队列，保证可重试与可追踪。

## 3. 总体流程
1) 渠道适配器收到消息 → 统一转换为 ChannelMessage。
2) Binding Router 计算目标 agent_id + session_id。
3) 保存 channel_sessions/channel_messages，落库并写监控事件。
4) 多模态预处理：ASR/图像/位置解析 → 生成可用于 LLM 的 attachments/metadata。
5) 调用现有 orchestrator（/wunder 内部调用），产出回复。
6) 进入 channel_outbox → 适配器投递 → 写回 delivery 状态。

## 4. 统一消息模型（ChannelMessage）
```json
{
  "channel": "telegram",
  "account_id": "main",
  "peer": { "kind": "dm|group", "id": "<peer_id>", "name": "optional" },
  "thread": { "id": "optional", "topic": "optional" },
  "message_id": "<source_msg_id>",
  "sender": { "id": "<source_user_id>", "name": "optional" },
  "type": "text|image|audio|video|location|file|mixed",
  "text": "optional",
  "attachments": [
    { "kind": "image|audio|video|file", "url": "...", "mime": "...", "size": 0 }
  ],
  "location": { "lat": 0.0, "lng": 0.0, "address": "optional" },
  "ts": 0
}
```

## 5. Binding 路由规则
- 规则字段：channel/account_id/peer.kind/peer.id/agent_id/priority。
- 规则优先级：peer 精确匹配 > account 匹配 > channel 级默认 > 全局默认。
- 默认策略：无匹配时路由到系统默认 agent。
- 输出：resolved_agent_id + session_id + tool_overrides（可选）。

## 6. 会话映射策略
- channel_sessions 表维护渠道维度到 chat_sessions 的映射。
- user_id 仍可保留“虚拟用户”语义，建议格式：`chan:{channel}:{account}:{peer}`。
- chat_sessions 新增字段（或扩展 channel_sessions）记录：channel/account_id/peer/thread。
- 迁移策略：先写新表，后续按需在 API 中提供查询。

## 7. 多模态处理
### 7.1 语音/音频
- 入站音频先落 media_assets，再提交 ASR 服务生成文本。
- ASR 结果写入 attachments + metadata，并合并为 LLM 输入。
- 保留原音频 URL 便于回放。

### 7.2 图像/摄像
- 图片作为附件传入；若模型支持 vision，直接随 attachments 发送。
- 不支持 vision 时触发 OCR/图像描述服务（可选），转为文本补充。

### 7.3 位置
- 位置消息转为结构化字段，同时生成可读文本描述。
- 可选接入地理编码服务，补充地址与 POI。

### 7.4 TTS 输出
- 规则：当渠道支持语音回传且会话启用 TTS，最终回复后调用 TTS。
- 结果作为语音附件进入 outbox；不支持 TTS 的渠道回退到文本。

## 8. 数据表建议（Postgres）
- channel_accounts：渠道账号配置（channel/account_id/config/status）。
- channel_bindings：路由规则（match/priority/agent_id/overrides）。
- channel_sessions：映射表（channel/account/peer/thread → session_id/agent_id）。
- channel_messages：入站消息日志（raw_payload/normalized）。
- channel_outbox：出站消息队列（payload/status/retry_at）。
- media_assets：媒体文件索引（kind/url/mime/size/hash）。
- speech_jobs（可选）：ASR/TTS 任务队列与状态。

## 9. API 与管理面
- 管理端接口：
  - /wunder/admin/channels/accounts（增删改查）
  - /wunder/admin/channels/bindings（规则管理）
  - /wunder/admin/channels/sessions（映射查询）
- 渠道 Webhook：
  - /wunder/channel/{provider}/webhook
- 调试接口：
  - /wunder/admin/channels/test（发送测试消息）

## 10. 安全与治理
- 渠道级白名单/黑名单（账号、群组、用户）。
- per-agent 工具权限与沙盒策略（避免高风险渠道触发高权限工具）。
- 限流：按 channel/account 设定 QPS 上限与并发上限。

## 11. 可观测性
- 事件类型：channel_inbound/channel_bound/asr_done/tts_done/channel_outbound。
- 核心指标：入站量、路由命中率、投递成功率、ASR/TTS 成本与耗时。
- 可回放：channel_messages + channel_outbox 支持完整链路追踪。

## 12. 性能与稳定性
- 适配器与 outbox 解耦，支持重试与指数退避。
- ASR/TTS 使用独立队列与并发上限，避免阻塞主请求。
- 附件与媒体缓存短期存储，按 retention 清理。

## 13. 里程碑
- 阶段 A：统一消息模型 + channel_sessions + bindings（先接入一个渠道）。
- 阶段 B：outbox 投递 + 重试链路 + 管理端规则配置。
- 阶段 C：多模态处理（ASR/TTS/图像/位置），接入 1~2 个模型/服务。
- 阶段 D：多渠道扩展与可观测性完善。

## 14. 兼容与回滚
- Web 前端作为默认 channel，确保现有 /wunder 逻辑可继续使用。
- 新渠道接入按开关启用，binding 规则可回退到默认 agent。

---
该方案优先复用 wunder 现有调度与存储能力，在入口侧新增“渠道接入层 + binding 路由 + 多模态处理节点”，实现多渠道与多模态能力的可控落地。
