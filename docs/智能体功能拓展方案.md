# 智能体功能拓展方案

## 1. 目标与范围
- 将聊天页的“自建工具 / 共享工具 / 额外提示词”配置迁移到功能广场，集中到“工具管理”页面。
- 在工具管理页面中清晰展示“管理员开放给该用户的工具”与“用户自建工具”，并作为智能体组装的基础。
- 新增“智能体创建/管理”能力：可选择工具/技能、编辑系统提示词，创建后出现在功能广场并可一键进入聊天。
- 所有聊天页面新增“调整工具”入口，支持在会话维度挂载/取消工具或技能。
- 后端补齐智能体实体与工具挂载/提示词叠加能力，保证权限/性能/缓存策略一致。
- 工具与智能体引入 ABC 等级，A 级用户可见 ABC，B 级用户可见 BC，C 级用户仅可见 C；管理员可对单用户做覆盖控制。

## 2. 现状分析（关键代码路径）
### 2.1 前端
- 聊天页工具入口：`frontend/src/views/ChatView.vue` 顶部按钮打开 `UserToolsModal / UserSharedToolsModal / UserExtraPromptModal`。
- 共享工具勾选保存于本地：`frontend/src/utils/toolSelection.js`，聊天请求会携带 `selected_shared_tools`。
- 工具与技能汇总用于能力提示/系统提示词预览：`fetchUserToolsSummary()` -> `/wunder/user_tools/tools`。
- 功能广场：`frontend/src/views/PortalView.vue` + `frontend/src/config/portal.js` 仅配置静态入口。

### 2.2 后端
- 用户工具配置：`src/services/user_tools.rs` 读写 `data/user_tools/<user_id>/config.json`，含 MCP/技能/知识库/额外提示词。
- 工具权限：`src/services/user_access.rs` 以用户权限等级 + 管理员白名单计算 `allowed tool names`。
- 共享工具选择：`/wunder/chat` 请求带 `selected_shared_tools`，仅在请求阶段做过滤。
- 系统提示词：`src/services/prompting.rs` 追加 `extra_prompt`；缓存 key 未包含智能体维度。
- 会话存储：`ChatSessionRecord` 目前没有 `agent_id`/工具覆盖字段。

## 3. 目标状态与方案设计
### 3.1 信息架构（前端）
- 功能广场增加两类入口：
  - 工具管理（页面化承载自建/共享/额外提示词）。
  - 智能体广场（列表+新建入口，动态渲染用户智能体卡片）。
- 工具管理页结构：
  - 管理员开放工具：仅展示、可被智能体挂载。
  - 用户自建工具：MCP/技能/知识库配置与共享开关（复用现有 Pane 组件）。
  - 共享工具：从他人共享列表中选择并纳入可挂载范围。
  - 额外提示词：保留“全局附加提示词”作为用户级默认附加层。
- 智能体广场：
  - 新建/编辑智能体：选择工具/技能、编辑系统提示词、设置显示信息（标题/描述/图标）。
  - 卡片展示：挂载工具数量、最近更新、所属标签。
- 聊天页：
  - 增加“调整工具”按钮，打开会话工具面板：展示可用工具/技能并支持会话级挂载/取消。
  - 清晰展示当前智能体信息（名称/提示词摘要/能力范围）。

### 3.2 数据模型与权限
- 新增 `user_agents`（建议落库，不新增 data 目录文件）：
  - 字段建议：`id / user_id / name / description / system_prompt / tool_names(json) / access_level / status / created_at / updated_at`。
- 会话扩展：`chat_sessions` 增加 `agent_id`、`tool_overrides(json)`（或 `selected_tool_names`）。
- 工具/智能体等级：
  - 工具目录返回 `access_level`（A/B/C），智能体记录自带 `access_level`。
  - 可见规则：A 可见 ABC、B 可见 BC、C 仅可见 C（前端过滤 + 后端兜底）。
- 权限覆盖（管理员可针对单用户控制）：
  - 工具：沿用 `user_tool_access.allowed_tools` 作为“强制允许清单”，同时新增 `blocked_tools` 以覆盖默认规则（防止越权）。
  - 智能体：新增 `user_agent_access`（或在现有表扩展字段）存储 `allowed_agent_ids / blocked_agent_ids`。
  - 计算顺序建议：等级可见集 -> 管理员允许/禁止覆盖 -> 智能体工具选择与会话覆盖取交集。

### 3.3 系统提示词叠加策略
确认采用分层追加（从上到下追加）：
1) 基础系统提示词（`prompts/system.txt` + 工具/技能块）。
2) 用户级 `extra_prompt`（全局追加）。
3) 智能体 `system_prompt`（该智能体独有追加）。
4) 会话级临时提示（如果允许即时调整）。

缓存 key 必须引入智能体版本/提示词哈希与会话工具覆盖，避免不同智能体复用同一 prompt 缓存。

### 3.4 API 设计（新增/调整建议）
- 智能体管理：
  - `GET /wunder/agents` 列表（当前用户）。
  - `POST /wunder/agents` 创建。
  - `GET /wunder/agents/{id}` 详情。
  - `PUT /wunder/agents/{id}` 更新。
  - `DELETE /wunder/agents/{id}` 删除。
- 工具管理：
  - 扩展 `/wunder/user_tools/tools` 返回结构，明确 `source`（builtin/mcp/a2a/skill/knowledge/user/shared）、`access_level`、`allowed` 标记；或新增 `/wunder/user_tools/catalog`。
- 会话与聊天：
  - `POST /wunder/chat/sessions` 支持 `agent_id`。
  - `POST /wunder/chat/sessions/{id}/tools` 设置会话级工具覆盖。
  - `POST /wunder/chat/system-prompt` 与 `/wunder/chat/sessions/{id}/system-prompt` 支持基于 `agent_id`/会话覆盖生成提示词。
- 管理员覆盖：
  - 扩展 `/wunder/admin/user_accounts/{user_id}/tool_access` 支持 `blocked_tools`。
  - 新增 `/wunder/admin/user_accounts/{user_id}/agent_access`（或合并到现有接口）管理 `allowed_agent_ids / blocked_agent_ids`。

### 3.5 关键实现点（后端）
- 新增智能体存储模块（`src/services/user_agents.rs`）与对应 API（`src/api/user_agents.rs`）。
- 扩展 `ChatSessionRecord` 与存储层（SQLite/Postgres schema + CRUD）。
- 调整 `build_user_tool_context / compute_allowed_tool_names`：加入“等级过滤 + 管理员覆盖 + 智能体工具选择 + 会话覆盖”。
- Prompt 构建加入智能体提示词与会话覆盖，并更新缓存 key 维度。
- 共享工具选择从本地存储迁移到后端可持久化字段（避免跨设备丢失）。

### 3.6 关键实现点（前端）
- 新增 `ToolManagerView` 与 `AgentSquareView / AgentEditorView`，路由挂载在 `/app/*`。
- Portal 动态拉取智能体列表并渲染卡片；保留静态入口。
- 迁移 `UserToolsModal / UserSharedToolsModal / UserExtraPromptModal` 为页面组件（保留逻辑、去掉弹窗壳）。
- 聊天页增加“调整工具”入口并与会话 `agent_id` 绑定；工具勾选变化后同步后端。
- 工具/智能体列表展示 `A/B/C` 级别徽标，默认仅展示可见级别（仍保留搜索/筛选）。

## 4. 落地节点（可执行）
1) **后端数据与 API 骨架**
   - 新增 `user_agents` 表 + CRUD API。
   - `chat_sessions` 增加 `agent_id`/工具覆盖字段。
2) **等级与覆盖策略**
   - 工具/智能体模型加入 `access_level`，补齐管理员覆盖表结构。
   - 统一实现“等级 + 覆盖 + 选择”的权限计算函数。
3) **工具目录与权限过滤**
   - 工具目录接口支持分组与来源标记。
   - 计算 `allowed` 时加入等级/管理员覆盖/智能体/会话覆盖。
4) **提示词与缓存扩展**
   - Prompt 拼接引入智能体与会话提示。
   - 缓存 key 增加 `agent_version`/`agent_prompt_hash`。
5) **前端工具管理页**
   - 功能广场新增工具管理入口，移除聊天页工具入口按钮。
   - 页面化展示管理员开放工具 + 用户自建工具 + 共享工具 + 额外提示词。
6) **智能体广场与聊天联动**
   - 新建/编辑智能体页面。
   - 功能广场渲染智能体卡片并进入聊天页；聊天页展示智能体信息。
7) **会话工具调整能力**
   - 聊天页“调整工具”面板，支持会话级挂载/取消并刷新提示词预览。
8) **文档同步**
   - 实施后同步更新 `docs/设计方案.md`、`docs/API文档.md`、`docs/系统介绍.md`。

## 5. 风险与控制点
- 工具名称规范：建议统一使用 canonical 名称存储，UI 展示别名以避免语言切换导致不匹配。
- 缓存与一致性：智能体提示词/工具集变化需主动刷新缓存或引入版本号。
- 权限越界：所有智能体工具选择必须二次过滤（等级规则 + 管理员覆盖）。
- 共享工具管理：由本地存储迁移至后端后需提供降级逻辑，避免旧数据丢失。
- Token 占用：提示词层级增加后需评估上下文占用变化并在前端统计展示中保持一致。
- 等级理解成本：UI 需提供 A/B/C 说明与筛选，避免用户误解工具可见范围。

## 6. 默认交互策略（便于用户体验）
- 智能体提示词采用“追加模式”，不会覆盖基础系统提示词。
- 会话级“调整工具”默认只作用于当前会话，提供“保存为智能体默认”可选按钮。
- 共享工具需显式勾选才可挂载到智能体，避免意外暴露共享能力。
