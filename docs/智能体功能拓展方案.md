# 智能体功能拓展方案

## 1. 目标与范围
- 将聊天页“自建工具 / 共享工具 / 额外提示词”迁移至功能广场的“工具管理”页面，统一配置入口。
- 功能广场新增“智能体广场”，支持创建/编辑/删除智能体并挂载工具。
- 聊天页新增“调整工具”面板，用于会话级工具覆盖。
- 工具与智能体均按 ABC 等级控制可见性，管理员可对单用户做允许/禁用覆盖。
- 智能体提示词以“追加模式”叠加到基础系统提示词之上。

## 2. 已落地能力总览
- 工具管理页整合：系统工具目录 + 用户自建工具（MCP/技能/知识库）+ 共享工具选择 + 额外提示词。
- 智能体广场：卡片列表 + 新建/编辑弹窗（工具选择、系统提示词、描述与图标）。
- 聊天页：顶部显示当前智能体信息与“调整工具”入口；会话级工具覆盖实时生效。
- 后端：新增 `user_agents` 与 `user_agent_access`，会话记录新增 `agent_id`/`tool_overrides`。
- 共享工具选择由后端 `user_tools` 持久化，不再依赖本地存储。

## 3. 信息架构与交互流程
### 3.1 工具管理
- “管理员开放工具”：来自 `/wunder/user_tools/catalog` 的内置/系统工具目录，用于选择挂载。
- “用户自建工具”：复用 MCP/技能/知识库管理面板，所有工具同步进入可挂载集合。
- “共享工具选择”：在工具目录中勾选可用的共享工具，保存到后端。
- “额外提示词”：作为用户级追加提示词，影响默认系统提示词与智能体。

### 3.2 智能体广场
- 智能体列表：展示名称/描述/挂载工具数量/更新时间。
- 新建/编辑：选择工具、填写系统提示词、描述、图标。
- 创建后在广场展示，可直接进入聊天并携带 `agent_id`。

### 3.3 聊天页工具调整
- 每个会话提供“调整工具”入口，展示可用工具并支持会话级覆盖。
- 默认工具集合来自当前智能体的挂载工具；会话覆盖仅作用当前会话。
- 支持“禁用所有工具”（写入 `__no_tools__`）。

## 4. 数据模型与权限策略
### 4.1 数据模型
- `user_agents`：
  - `agent_id / user_id / name / description / system_prompt / tool_names / access_level / status / icon / created_at / updated_at`
- `chat_sessions`：
  - 新增 `agent_id` 与 `tool_overrides`。
- `user_tool_access`：
  - `allowed_tools`（可选白名单）+ `blocked_tools`（强制禁用）。
- `user_agent_access`：
  - `allowed_agent_ids`（可选白名单）+ `blocked_agent_ids`（强制禁用）。

### 4.2 权限规则
- 等级规则：A >= B >= C，用户只能看到等级不高于自己的工具/智能体。
- 管理员覆盖：
  - 工具：先按等级过滤，再做 `allowed_tools` 白名单收敛，最后移除 `blocked_tools`。
  - 智能体：先按等级过滤，再按 `allowed_agent_ids`/`blocked_agent_ids` 过滤。
- 工具最终集合 = 可见集合 ∩ 智能体挂载集合 ∩ 会话覆盖集合（若覆盖为空则使用智能体默认）。

## 5. 提示词叠加与缓存
提示词层级顺序：
1) 基础系统提示词（含工具/技能协议块）。
2) 用户级 `extra_prompt`。
3) 智能体 `system_prompt`。
4) 运行期附加块（如 a2ui、计划/问询面板等）。

缓存 key 已引入：工具集合、用户工具版本、共享工具版本、智能体提示词哈希、工作区版本。

## 6. API 变更摘要
- 智能体管理：
  - `GET/POST /wunder/agents`
  - `GET/PUT/DELETE /wunder/agents/{id}`
- 工具管理：
  - `GET /wunder/user_tools/catalog` 完整目录
  - `POST /wunder/user_tools/shared_tools` 保存共享工具选择
  - `GET /wunder/user_tools/tools` 返回可用工具 + 共享选择 + extra_prompt
- 会话工具调整：
  - `POST /wunder/chat/sessions/{id}/tools` 更新 `tool_overrides`
- 管理员覆盖：
  - `GET/PUT /wunder/admin/user_accounts/{user_id}/tool_access`
  - `GET/PUT /wunder/admin/user_accounts/{user_id}/agent_access`
- 提示词：
  - `/wunder/chat/system-prompt` 支持 `agent_id` + `tool_overrides`
  - 请求体含 `agent_prompt`（内部传递给 orchestrator）

## 7. 落地节点与验收
1) 工具管理迁移
   - 验收：工具配置统一集中入口，聊天页不再出现工具/提示词弹窗。
2) 智能体广场
   - 验收：可创建/编辑/删除智能体，进入聊天后能力生效。
3) 会话级工具调整
   - 验收：会话覆盖立即影响工具调用与提示词预览。
4) 等级与覆盖策略
   - 验收：A/B/C 用户可见范围正确，管理员白名单/黑名单生效。
5) 提示词叠加
   - 验收：基础 + 用户 + 智能体提示词按顺序追加，缓存可区分不同智能体。

## 8. 体验默认策略
- 智能体提示词为“追加”，不覆盖基础系统提示词。
- 会话覆盖默认仅影响当前会话，避免影响其他智能体。
- 共享工具必须显式勾选后才进入可挂载范围。

