# 用户前端落地方案

## 目标
- 新增用户侧 Vue3 前端（使用 `frontend` 现有设计），支持注册/登录/聊天/工作区/用户工具。
- Wunder Rust 后端补齐用户认证、会话管理、用户工具与工作区接口。
- 管理员侧 Web：原“用户管理”更名为“线程管理”，新增“用户管理”面板用于实际用户管理（删除用户/重置密码/权限控制），参考 `C:\Users\32138\Desktop\wille`。

## 节点与范围
1) 账号与认证
- 注册/登录/演示登录/获取当前用户。
- 账号状态（active/disabled）、访问级别（A/B/C）、角色（user/admin/super_admin）。
- 额度治理：A/B/C 默认每日额度（10000/1000/100），0 点重置；每次模型调用计入额度，超额提示并阻止继续请求。
- Token 鉴权：Bearer Token（用户端），API Key（管理员端）。

2) 会话与聊天
- 会话创建/列表/详情/删除。
- 发送消息（SSE 流式），取消会话。
- 系统提示词预览、附件解析。
- 回复完成后在消息统计中展示工具调用次数与额度消耗，便于用户理解成本与剩余额度。
- 附件解析通过 `/wunder/chat/attachments/convert`，支持 doc/docx/pdf/pptx/xlsx/ods/odt/odp/wps/dps/et 与常见文本/代码格式。

3) 工作区与用户工具
- 用户工作区文件列表/搜索/上传/下载/编辑/批量操作。
- 用户 MCP/技能/知识库管理。
- 工具汇总接口用于“共享工具选择/能力提示”。
- 非 Markdown 文件可先调用 `/wunder/doc2md/convert` 转换后再写入知识库或附件内容。

4) 管理员 Web 调整
- 原“用户管理”面板更名为“线程管理”（会话统计）。
- 新增“用户管理”面板（实际账号 CRUD/重置密码/工具权限）。
- 用户管理支持配置每日额度、查看消耗与剩余额度，并提供超额提示。
- 内部状态/线程详情：`/wunder/admin/monitor`、`/wunder/admin/monitor/tool_usage`、`/wunder/admin/monitor/{session_id}`。
- 线程管理：`/wunder/admin/users`、`/wunder/admin/users/{user_id}/sessions`、`/wunder/admin/users/{user_id}`。
- 用户管理：`/wunder/admin/user_accounts`、`/wunder/admin/user_accounts/{user_id}`、`/wunder/admin/user_accounts/{user_id}/password`、`/wunder/admin/user_accounts/{user_id}/tool_access`、`/wunder/admin/user_accounts/{user_id}/agent_access`。
- 记忆管理：`/wunder/admin/memory/*`。
- 模型/系统设置：`/wunder/admin/llm`、`/wunder/admin/llm/context_window`、`/wunder/admin/server`、`/wunder/i18n`。
- MCP/技能/知识库/A2A：`/wunder/admin/mcp`、`/wunder/admin/mcp/tools`、`/wunder/admin/a2a`、`/wunder/admin/skills`、`/wunder/admin/knowledge/*`。
- 吞吐量/性能/评估：`/wunder/admin/throughput/*`、`/wunder/admin/performance/sample`、`/wunder/admin/evaluation/*`。
- 调试面板接口：`/wunder`、`/wunder/system_prompt`、`/wunder/tools`、`/wunder/attachments/convert`、`/wunder/workspace/*`、`/wunder/user_tools/*`。

5) 文档与配置
- 更新 `docs/设计方案.md`、`docs/API文档.md`、`docs/系统介绍.md`。
- 运行 `python scripts/update_feature_log.py --type 变更 --scope frontend ...` 写入分类化功能迭代记录。

## 实现路径
### 后端（Rust）
- 新增用户存储与认证模块（`src/services/user_store.rs`）。
- 扩展 `StorageBackend`，在 SQLite/Postgres 中增加用户/Token/会话表。
- 新增 API：
  - `POST /wunder/auth/register|login|demo`、`GET /wunder/auth/me`。
  - `GET/POST/DELETE /wunder/chat/sessions`、`POST /wunder/chat/sessions/{id}/messages`、`POST /wunder/chat/sessions/{id}/cancel`、`POST /wunder/chat/system-prompt`、`POST /wunder/chat/attachments/convert`。
  - `POST /wunder/doc2md/convert`（文档转 Markdown）、`POST /wunder/attachments/convert`（管理端附件解析）。
- 用户工具与工作区接口支持用户 Token（无 user_id 参数）与管理员 API Key（带 user_id）。
- 工具权限策略：
  - A：默认全量工具。
  - B：隐藏技能。
  - C：隐藏技能 + 知识库。
  - 管理员可配置白名单覆盖默认策略。

### 前端（用户侧 Vue）
- `frontend` 维持原 UI，仅调整接口与端口：
  - API 基址：`http://localhost:18000/wunder`。
  - Vite dev 端口：18001。
  - `/auth/*`、`/chat/*`、`/workspace/*`、`/user-tools/*` 路径对齐新后端。

### 管理端 Web
- `web/index.html` 导航：
  - “用户管理”改名“线程管理”。
  - 新增“用户管理”入口与面板。
- 新增 `web/modules/user-accounts.js` 处理账号列表、创建、删除、重置密码、权限控制。

### 文档
- 更新系统设计/API/介绍文档，说明用户端前后端结构与鉴权策略。
- 运行 `python scripts/update_feature_log.py --type 变更 --scope frontend ...` 记录本次变更。

## 当前进度
- 后端用户鉴权/会话/用户工具/工作区接口已补齐，新增管理员账号管理接口。
- 管理端已将原用户管理改为线程管理，并新增账号管理面板。
- 用户侧 Vue3 前端已对齐 `/wunder` 接口与 18001 端口。
- 文档解析接口（`/wunder/doc2md/convert`、`/wunder/chat/attachments/convert`、`/wunder/attachments/convert`）已落地并在前端接入。
