<svg width="1200" height="720" viewBox="0 0 1200 720" fill="none" xmlns="http://www.w3.org/2000/svg">
<defs>
<linearGradient id="gconcurrency-thread-queue" x1="0" y1="0" x2="1200" y2="720" gradientUnits="userSpaceOnUse">
<stop offset="0" stop-color="#F7F9FF"/>
<stop offset="1" stop-color="#EEF2FF"/>
</linearGradient>
<filter id="shadowconcurrency-thread-queue" x="-20%" y="-20%" width="140%" height="140%">
<feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="#0F1C33" flood-opacity="0.12"/>
</filter>
<marker id="arrowconcurrency-thread-queue" markerWidth="10" markerHeight="10" refX="7" refY="3" orient="auto">
<path d="M0,0 L0,6 L8,3 z" fill="#5A7CF8"/>
</marker>
<style>
.ttl { font: 700 34px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #1C2840; }
.sub { font: 500 19px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #556681; }
.h3 { font: 700 22px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #1F2A44; }
.body { font: 500 17px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #5C6F8F; }
.cap { font: 600 16px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #2A3F66; }
.small { font: 500 14px 'Microsoft YaHei','PingFang SC','Noto Sans SC',sans-serif; fill: #6A7A95; }
</style>
</defs>
<rect x="18" y="18" width="1164" height="684" rx="28" fill="url(#gconcurrency-thread-queue)" stroke="#DCE6F5"/>
<text x="600" y="86" text-anchor="middle" class="ttl">
<tspan x="600" dy="0">并发控制模型</tspan>
</text>
<text x="600" y="124" text-anchor="middle" class="sub">
<tspan x="600" dy="0">主线程 + 队列 + 轮次统计保证稳定执行</tspan>
</text>
<g filter="url(#shadowconcurrency-thread-queue)"><rect x="80" y="210" width="188" height="150" rx="18" fill="#FFFFFF" stroke="#D6E2F3"/></g>
<rect x="94" y="224" width="34" height="22" rx="11" fill="#5A7CF8" fill-opacity="0.18"/>
<text x="111" y="240" text-anchor="middle" class="cap">
<tspan x="111" dy="0">1</tspan>
</text>
<text x="174.0" y="288" text-anchor="middle" class="h3">
<tspan x="174.0" dy="0">主线程</tspan>
</text>
<text x="174.0" y="326" text-anchor="middle" class="body">
<tspan x="174.0" dy="0">user_id +</tspan>
<tspan x="174.0" dy="24">agent_id 维度</tspan>
</text>
<line x1="268" y1="285.0" x2="286" y2="285.0" stroke="#5A7CF8" stroke-width="3" marker-end="url(#arrowconcurrency-thread-queue)"/>
<g filter="url(#shadowconcurrency-thread-queue)"><rect x="292" y="210" width="188" height="150" rx="18" fill="#FDFEFF" stroke="#D6E2F3"/></g>
<rect x="306" y="224" width="34" height="22" rx="11" fill="#5A7CF8" fill-opacity="0.18"/>
<text x="323" y="240" text-anchor="middle" class="cap">
<tspan x="323" dy="0">2</tspan>
</text>
<text x="386.0" y="288" text-anchor="middle" class="h3">
<tspan x="386.0" dy="0">忙闲判断</tspan>
</text>
<text x="386.0" y="326" text-anchor="middle" class="body">
<tspan x="386.0" dy="0">session_locks</tspan>
<tspan x="386.0" dy="24">+ monitor</tspan>
</text>
<line x1="480" y1="285.0" x2="498" y2="285.0" stroke="#5A7CF8" stroke-width="3" marker-end="url(#arrowconcurrency-thread-queue)"/>
<g filter="url(#shadowconcurrency-thread-queue)"><rect x="504" y="210" width="188" height="150" rx="18" fill="#F7FBFF" stroke="#D6E2F3"/></g>
<rect x="518" y="224" width="34" height="22" rx="11" fill="#5A7CF8" fill-opacity="0.18"/>
<text x="535" y="240" text-anchor="middle" class="cap">
<tspan x="535" dy="0">3</tspan>
</text>
<text x="598.0" y="288" text-anchor="middle" class="h3">
<tspan x="598.0" dy="0">任务入队</tspan>
</text>
<text x="598.0" y="326" text-anchor="middle" class="body">
<tspan x="598.0" dy="0">agent_tasks</tspan>
<tspan x="598.0" dy="24">waiting</tspan>
</text>
<line x1="692" y1="285.0" x2="710" y2="285.0" stroke="#5A7CF8" stroke-width="3" marker-end="url(#arrowconcurrency-thread-queue)"/>
<g filter="url(#shadowconcurrency-thread-queue)"><rect x="716" y="210" width="188" height="150" rx="18" fill="#FFFFFF" stroke="#D6E2F3"/></g>
<rect x="730" y="224" width="34" height="22" rx="11" fill="#5A7CF8" fill-opacity="0.18"/>
<text x="747" y="240" text-anchor="middle" class="cap">
<tspan x="747" dy="0">4</tspan>
</text>
<text x="810.0" y="288" text-anchor="middle" class="h3">
<tspan x="810.0" dy="0">异步执行</tspan>
</text>
<text x="810.0" y="326" text-anchor="middle" class="body">
<tspan x="810.0" dy="0">AgentRuntime</tspan>
<tspan x="810.0" dy="24">消费任务</tspan>
</text>
<line x1="904" y1="285.0" x2="922" y2="285.0" stroke="#5A7CF8" stroke-width="3" marker-end="url(#arrowconcurrency-thread-queue)"/>
<g filter="url(#shadowconcurrency-thread-queue)"><rect x="928" y="210" width="188" height="150" rx="18" fill="#F9FCFF" stroke="#D6E2F3"/></g>
<rect x="942" y="224" width="34" height="22" rx="11" fill="#5A7CF8" fill-opacity="0.18"/>
<text x="959" y="240" text-anchor="middle" class="cap">
<tspan x="959" dy="0">5</tspan>
</text>
<text x="1022.0" y="288" text-anchor="middle" class="h3">
<tspan x="1022.0" dy="0">状态回写</tspan>
</text>
<text x="1022.0" y="326" text-anchor="middle" class="body">
<tspan x="1022.0" dy="0">轮次与事件统一更新</tspan>
</text>
<rect x="80" y="432" width="336" height="38" rx="19" fill="#FFFFFF" stroke="#D6E2F3"/>
<circle cx="98" cy="451" r="4" fill="#5A7CF8"/>
<text x="114" y="457" text-anchor="start" class="small">
<tspan x="114" dy="0">忙时排队避免冲突</tspan>
</text>
<rect x="432" y="432" width="336" height="38" rx="19" fill="#FFFFFF" stroke="#D6E2F3"/>
<circle cx="450" cy="451" r="4" fill="#5A7CF8"/>
<text x="466" y="457" text-anchor="start" class="small">
<tspan x="466" dy="0">用户轮次/模型轮次分离统计</tspan>
</text>
<rect x="784" y="432" width="336" height="38" rx="19" fill="#FFFFFF" stroke="#D6E2F3"/>
<circle cx="802" cy="451" r="4" fill="#5A7CF8"/>
<text x="818" y="457" text-anchor="start" class="small">
<tspan x="818" dy="0">token 记录上下文占用量</tspan>
</text>
</svg>
