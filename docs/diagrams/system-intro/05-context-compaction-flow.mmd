flowchart LR
  subgraph Row1[" "]
    direction LR
    A["压缩检查<br/>读取配置/估算 tokens/预算"] --> B{"触发压缩？"} -->|否| Z["跳过压缩"]
  end

  subgraph Row2[" "]
    direction LR
    C["准备压缩输入<br/>compact_prompt + 历史合并"] --> D["裁剪输入<br/>移除 reasoning/限长"] --> E["生成摘要<br/>max_output<=1024"] --> F{"摘要成功？"}
    F -- "是" --> H["写入摘要 + 标记边界"] --> I["重建上下文<br/>补裁剪/重置 usage/发送事件"] --> Z
  end

  B -- "是" --> C
  F -- "否" --> G["占位摘要<br/>继续裁剪"] --> H
