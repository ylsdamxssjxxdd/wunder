flowchart LR
  A["估算 context_tokens 与历史阈值"] --> B{"触发压缩?"}
  B -- 否 --> K["保持原上下文"]
  B -- 是 --> C["构建压缩输入
compact_prompt + 历史候选"]
  C --> D["裁剪过长内容
移除 reasoning 与冗余字段"]
  D --> E["调用摘要模型
max_output <= 1024"]
  E --> F{"摘要成功?"}
  F -- 是 --> G["写入 compaction 摘要
记录 compacted_until 与 reset_mode"]
  F -- 否 --> H["写入占位摘要并继续"]
  G --> I["重建上下文并发送 compaction 事件"]
  H --> I
  I --> J["继续后续 model_round"]
