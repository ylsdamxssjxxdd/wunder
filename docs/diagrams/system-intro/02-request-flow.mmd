sequenceDiagram
  participant U as 用户/前端
  participant API as API层
  participant O as Orchestrator
  participant P as Prompt Builder
  participant L as LLM
  participant T as 工具执行层
  participant S as 存储/监控

  U->>API: POST /wunder (user_id, question, tool_names, stream)
  API->>O: 转交请求
  O->>S: 获取会话锁/注册监控
  O->>P: 构建系统提示词(含工具/技能/工作区/记忆)
  O->>S: 读取历史/工作区/工具配置
  O->>O: 追加用户消息
  opt 触发历史压缩
    O->>S: 校验额度/扣减(注册用户)
    O->>L: 调用摘要模型生成上下文摘要
    L-->>O: 摘要结果
    O->>S: 写入摘要与压缩事件
  end
  loop 每轮
    O->>S: 校验额度/扣减(注册用户)
    O->>L: 调用模型(可流式)
    L-->>O: 生成工具调用或答案
    alt 有工具调用
      O->>T: 执行工具(内置/MCP/Skills/知识库/自建)
      T-->>O: 工具结果
      O->>S: 写入对话/工具/产物/监控事件
    else 无工具调用
      O->>S: 写入对话/监控事件
    end
  end
  O-->>U: SSE事件(过程/最终)或非流式回复
  O->>S: 入队长期记忆总结
  O->>S: 释放会话锁/更新监控状态
