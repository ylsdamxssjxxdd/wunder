flowchart LR
  Client["用户前端与 API 调用方"] --> API["Axum API 路由层"]
  ChannelIn["渠道 Webhook"] --> ChannelHub["ChannelHub"]
  GatewayIn["Gateway WebSocket 客户端"] --> GatewayHub["GatewayHub"]

  API --> AgentRuntime["AgentRuntime 主线程与队列"]
  ChannelHub --> AgentRuntime
  AgentRuntime --> Orchestrator["Orchestrator 调度引擎"]

  Orchestrator --> Prompt["Prompt Builder"]
  Orchestrator --> LLM["LLM 适配层"]
  Orchestrator --> Tooling["工具执行层"]
  Orchestrator --> Monitor["MonitorState 事件监控"]
  Orchestrator --> Storage["StorageBackend"]

  Tooling --> Builtin["内置工具"]
  Tooling --> MCPA2A["MCP 与 A2A 工具"]
  Tooling --> Skills["Skills"]
  Tooling --> Knowledge["字面与向量知识库工具"]
  Tooling --> UserTools["用户自建与共享工具"]
  Builtin --> Sandbox["sandbox 模式服务"]

  Storage --> PG["Postgres"]
  Storage --> SQLite["SQLite 测试后端"]
  Storage --> Workspace["多用户工作区"]
  Orchestrator --> Weaviate["Weaviate 向量库"]

  API <-->|"WebSocket 优先 / SSE 兜底"| Client
