# 性能优化

## 2026-01-24 工具路径根目录缓存

### 背景
- 管理端性能面板的 file_ops 在高并发（300）场景出现明显延迟，影响文件相关工具的用户体验。

### 问题定位
- 文件工具会在每次调用时收集 allow_paths 与技能目录并做路径去重/归一化。
- 这一步包含 fs::canonicalize 与路径比较，在高并发下重复执行，会放大路径解析与 I/O 开销。
- 由于允许路径和技能根目录在单次请求内基本不变，重复计算属于非必要开销。

### 优化方案
- 新增 ToolRoots 缓存，将 allow_roots/read_roots 预先计算并挂载到 ToolContext。
- collect_allow_roots/collect_read_roots 优先复用缓存，缺失时回退到旧逻辑，保证兼容性。
- 在 orchestrator 与性能采样入口统一构建并复用缓存，减少每次工具调用的路径归一化成本。

### 效果（本地 Docker 实测）
- file_ops（300 并发）平均耗时从约 1.6s 降至约 28ms。
- 实际收益与机器负载、文件系统类型相关，但对高并发文件工具场景有明显改善。

### 相关改动
- 缓存定义与构建：src/tools.rs:75
- 缓存接入工具上下文：src/orchestrator/execute.rs:82
- 性能采样复用缓存：src/performance.rs:7

### 指导与注意事项
- 新增创建 ToolContext 的入口时，应通过 build_tool_roots 注入 allow_roots/read_roots，避免退化到每次调用重复计算。
- 配置层面尽量收敛 security.allow_paths，避免无用路径触发多余的 canonicalize。
- 性能回归验证建议使用管理端性能面板或接口：/wunder/admin/performance/sample。
- 如需扩展新的根路径来源，优先在 build_tool_roots 内统一处理，保持单点缓存逻辑。
