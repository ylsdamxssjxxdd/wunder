# 强化智能体落地方案

## 1. 背景与目标
- 以 **user_id + agent_id** 为稳定隔离维度，突出“智能体应用”的长期执行能力。
- 每个智能体应用拥有**常驻主线程（默认会话）**，对话请求优先派发给该主线程。
- 主线程忙碌时改为**异步排队**，在空闲后顺序执行，避免并发打断与上下文污染。
- 用户侧前端将历史记录升级为“时间线”，主线程可视化并支持手动指定。

## 2. 核心概念
- **智能体应用（agent_id）**：用户可配置的应用实例，决定提示词与工具范围。
- **主线程（Main Session）**：每个 user_id + agent_id 仅有一个主会话，用于默认派发。
- **异步队列（Agent Tasks）**：主线程忙碌时进入队列，按 FIFO 执行。

## 3. 数据模型
### 3.1 agent_threads
- `thread_id` / `user_id` / `agent_id` / `session_id`
- `status`: idle | busy | waiting
- `created_at` / `updated_at`

### 3.2 agent_tasks
- `task_id` / `thread_id` / `user_id` / `agent_id` / `session_id`
- `status`: pending | running | retry | success | failed | dead | cancelled
- `request_payload`（完整 WunderRequest）
- `retry_count` / `retry_at` / `started_at` / `finished_at` / `last_error`

## 4. 运行机制
- **AgentRuntime**（`src/services/agent_runtime.rs`）负责：
  - 解析主线程会话（不存在则自动创建）。
  - 设置/切换主线程（新建会话、发送消息、手动设置）。
  - 主线程忙时进入队列，空闲后执行。
- **空闲判断**：基于 `session_locks` + `monitor.status`（running/waiting/cancelling）。
- **执行方式**：队列任务使用 `orchestrator.stream` 执行并持久化事件。
- **事件记录**：`queue_enter/queue_start/queue_finish/queue_fail` 写入监控。

## 5. API 变化
- `/wunder`：
  - 无 `session_id` 时自动指向主线程。
  - 忙时返回 `queued` 事件（SSE）或 202（JSON）。
- `/wunder/chat/sessions`：
  - 创建会话默认设为主线程，返回 `is_main`。
  - 列表返回 `is_main` 标记。
- `/wunder/chat/sessions/{id}/messages`：
  - 忙时进入队列，返回 `queued` 事件或 202。
- `/wunder/agents/{agent_id}/default-session`：
  - `GET` 获取主线程会话；`POST` 设置主线程会话。
  - 默认入口使用 `agent_id=__default__`。

## 6. 前端落地
- 历史记录重命名为**时间线**。
- 时间线列表展示：
  - 主线程 **高亮 + 徽标**。
  - 悬停出现“设为主线程”和“删除”按钮。
- 切换逻辑：
  - 新建会话、发送消息、手动设置时更新主线程。
  - 初次进入优先打开 `is_main` 会话。

## 7. 兼容性与注意事项
- 定时任务始终回写原始 session_id，不受主线程切换影响。
- WS 通道在排队时发送 `queued` + `final(queued=true)`，保证请求闭合。
- 未配置 agent_id 的默认会话仍按 user_id 维度独立管理。

## 8. 实现节点与路径
### 8.1 后端
- 运行时：`src/services/agent_runtime.rs`
- 状态注入：`src/core/state.rs`
- API：`src/api/core.rs`、`src/api/chat.rs`、`src/api/chat_ws.rs`、`src/api/user_agents.rs`
- 存储：`src/storage/mod.rs`、`src/storage/sqlite.rs`、`src/storage/postgres.rs`
- 配置：`src/core/config.rs`

### 8.2 前端
- 视图：`frontend/src/views/ChatView.vue`
- 样式：`frontend/src/styles/chat/history.css`
- Store：`frontend/src/stores/chat.js`
- API：`frontend/src/api/agents.js`
- 文案：`frontend/src/i18n/messages/zh-CN.js`、`frontend/src/i18n/messages/en-US.js`

## 9. 状态核验清单
- 列表接口返回 `is_main`，时间线正确高亮。
- 设置主线程后列表与主会话正确更新。
- 忙时请求进入队列，`queued` 事件可见，空闲后自动执行。
- WS/SSE 队列行为一致，前端不会卡死。
