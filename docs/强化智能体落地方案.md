# 强化智能体落地方案

> 目标：将“智能体应用（agent_id）”从对话配置强化为“**常驻线程 + 串行队列**”的运行单元，默认会话跨 `/wunder` 与 `/wunder/chat` 复用；当线程忙碌时异步排队，线程空闲后自动执行。

## 1. 背景与现状
当前系统以“会话（session_id）”为执行单元，`agent_id`主要用于提示词叠加与工作区隔离；`session_id`未传时会自动生成新会话，并且同一 `user_id + agent_id` 并发时直接返回 USER_BUSY（429）。这使“智能体”更像**对话配置**，而不是“**常驻线程**”。

**现状关键点（代码层）**
- `/wunder` 或 `/wunder/chat` 未传 `session_id` 时会生成新会话。
- 并发控制依赖 `session_locks`，同一 `user_id + agent_id` 忙时立即拒绝（429），无排队。
- “agent_loop”仅为单次请求内的多轮模型循环，不是常驻线程。

## 2. 目标与非目标
### 2.1 目标
- 每个 **user_id + agent_id** 有且仅有一个“常驻默认会话（default session）”。
- `/wunder` 与 `/wunder/chat` 在 **未显式传 session_id** 时统一路由到默认会话。
- 当默认会话忙碌时，**异步排队**，会话空闲后自动执行。
- 管理员侧“终止智能体线程”语义更清晰：终止默认会话 + 释放锁 + 队列可继续。
- 线程与队列的状态可在监控与管理接口中追踪。

### 2.2 非目标
- 不改变现有显式 session_id 的调用语义（仍可并行、仍受锁限制）。
- 不改变工具与模型调用方式。

## 3. 关键概念定义
- **智能体应用（agent_id）**：用户定义的“应用配置”。
- **默认会话（default session）**：`user_id + agent_id` 对应的唯一常驻会话，也是该智能体的**主线程指针**。
- **主线程（main thread）**：用户侧“时间线”中被标记为主线程的会话；默认会话映射即主线程指针，可随用户操作更新。
- **智能体任务（agent task）**：提交给默认会话的待执行请求（排队单元）。
- **空闲状态（idle）**：会话无锁、且监控状态非 running/waiting/cancelling。

## 4. 目标流程（摘要）
```
用户请求(/wunder 或 /wunder/chat) 
  └─ 若未传 session_id：解析/创建默认会话
      └─ 检查会话锁
          ├─ 空闲：直接执行
          └─ 忙碌：入队 -> 返回 accepted + queue_id + session_id
               └─ 线程空闲后自动出队执行
```

## 5. 方案设计
### 5.1 默认会话映射
为 `user_id + agent_id` 建立长期映射：
- **首次访问**：创建会话并写入映射表
- **后续访问**：直接复用映射的 `session_id`
- **主线程可变**：当用户创建新会话、向历史会话发送消息或手动设置主线程时，更新该映射。

> 适用于 `/wunder` 与 `/wunder/chat` 两个入口。

### 5.2 异步队列
当默认会话忙时：
- 写入 `agent_tasks` 队列表（状态：pending）
- 返回 `202 Accepted`（或正常 JSON）包含 `queue_id + session_id`
- 客户端可通过会话流式事件或 `resume`/`watch` 订阅结果

队列出队逻辑：
- **事件驱动优先**：会话结束/释放锁后触发检查
- **后台兜底轮询**：防止异常情况下的遗漏

### 5.3 Idle 判断
判定默认会话“空闲”需同时满足：
1) `session_locks` 中不存在该 `session_id` 锁
2) `monitor` 状态不在 `running/waiting/cancelling`

> `question_panel` 等“等待用户选择”的状态应视作 busy，避免混入新任务。

### 5.4 队列执行模型
- 任务以 **串行** 方式进入默认会话执行。
- 执行时仍走原 Orchestrator 流程（正常写入历史、监控事件、工具日志）。
- 任务执行完成后发出 `queue_finish` 事件，并尝试继续消费队列。

### 5.5 幂等与去重
建议为入队请求提供 `request_id`：
- 若同一 `request_id` 已入队或已执行，返回已存在的 `queue_id`。
- 防止网络重试导致重复执行。

### 5.6 失败与重试
- 单任务失败记录 `last_error`，状态置为 `failed`。
- 可配置重试次数与指数退避。
- 超过重试次数进入 `dead` 状态，需人工处理或管理端清理。

### 5.7 管理端终止语义强化
管理员终止默认会话时：
- 立即取消当前执行
- 释放会话锁
- 触发队列继续消费（或留在 waiting）
- 管理端可选择是否清空队列

### 5.8 用户侧主线程与时间线交互
- **时间线命名**：前端将“历史记录”统一更名为“时间线”。  
- **主线程规则**：每个智能体应用默认以**最近一次对话**的会话作为主线程。  
- **自动更新**：用户创建新会话或在某条历史会话中发送消息时，该会话自动成为主线程。  
- **手动设置**：时间线条目 hover 时显示两个操作：删除、设为主线程。  
- **视觉强化**：主线程条目样式突出（高亮、标识图标或角标）。  
- **定时任务例外**：cron/定时任务回复必须写入其记录的会话，不影响主线程指针。

## 6. 数据模型（新增/变更）
### 6.1 agent_threads（默认会话映射）
- `thread_id` TEXT (PK)
- `user_id` TEXT
- `agent_id` TEXT
- `session_id` TEXT
- `status` TEXT (idle/busy/waiting/error)
- `created_at` DOUBLE
- `updated_at` DOUBLE
- UNIQUE(`user_id`,`agent_id`)

### 6.2 agent_tasks（智能体队列）
- `task_id` TEXT (PK)
- `thread_id` TEXT
- `user_id` TEXT
- `agent_id` TEXT
- `session_id` TEXT
- `status` TEXT (pending/running/success/failed/cancelled/dead)
- `request_payload` JSON
- `request_id` TEXT (可选, 唯一)
- `retry_count` INT
- `retry_at` DOUBLE
- `created_at` DOUBLE
- `updated_at` DOUBLE
- INDEX(`thread_id`,`status`,`retry_at`)

### 6.3 兼容说明
- 默认会话映射与队列只影响“未传 session_id”的请求。
- 现有 `session_locks` 不变。

## 7. API 行为调整
### 7.1 `/wunder`
- **未传 session_id**：自动绑定默认会话。
- **若默认会话忙**：返回 `202 Accepted` + `queue_id` + `session_id`。
- 兼容 `stream=true`：返回 `queued` 事件后关闭（不阻塞等待）。

### 7.2 `/wunder/chat`
- `POST /wunder/chat/sessions`：新增 `use_default`（默认 true）与 `agent_id`，返回默认会话或新会话。
- `POST /wunder/chat/sessions/{session_id}/messages`：若 session_id 为默认会话且忙，则入队；同时将该会话更新为主线程。
- `GET /wunder/chat/sessions`：增加 `is_main` 字段，标识当前主线程。

### 7.3 新增建议接口（可选）
- `GET /wunder/agents/{agent_id}/default-session`
- `POST /wunder/agents/{agent_id}/default-session`（设置主线程/默认会话）
- `GET /wunder/agents/{agent_id}/queue`
- `POST /wunder/agents/queue/{task_id}/cancel`

> 管理端可提供队列清理与强制出队能力。

## 8. 事件与监控
新增事件类型（写入 monitor & SSE/WS）：
- `queue_enter`：任务入队
- `queue_start`：任务出队开始
- `queue_finish`：任务完成
- `queue_fail`：任务失败
- `main_thread_changed`：主线程变更（会话 id、触发来源）

监控面板新增：
- 默认会话状态（idle/busy/waiting）
- 队列长度、平均等待时间

## 9. 配置项建议
- `agent_queue.enabled` (bool, default true)
- `agent_queue.max_retries` (int)
- `agent_queue.poll_interval_ms` (int)
- `agent_queue.task_ttl_s` (int)

## 10. 实现节点与路径（建议）
### 10.1 新增模块
- `src/services/agent_runtime.rs`  
  - 默认会话解析、队列入队、出队调度
- `src/services/agent_queue.rs`（可拆分）
  - 后台队列 worker

### 10.2 现有模块调整
- `src/orchestrator/request.rs`  
  - 支持“默认会话解析”逻辑
- `src/api/core.rs`  
  - `/wunder` 入口未传 session_id 的处理
- `src/api/chat.rs`  
  - `build_chat_request` 默认会话逻辑
  - `create_session` 增加 `use_default`
- `src/storage/mod.rs`  
  - 新增 agent_threads / agent_tasks 的接口定义
- `src/storage/sqlite.rs` / `src/storage/postgres.rs`  
  - 表结构与 CRUD 实现
- `src/ops/monitor.rs`  
  - 队列事件写入监控
- `frontend/`（用户侧）  
  - 时间线改名、主线程样式强化、hover 操作（删除/设为主线程）
  - 与主线程接口联动，刷新 `is_main` 状态
- `docs/API文档.md` / `docs/系统介绍.md`  
  - 文档同步

## 11. 里程碑拆解（实施顺序）
1) **基础数据层**：新增表结构 + CRUD（sqlite/postgres）
2) **默认会话映射**：`resolve_default_session()` + `/wunder` 接入
3) **队列入队**：默认会话 busy 时入队 + 返回 202
4) **队列出队**：worker loop + 事件驱动 + 执行调度
5) **chat 接入**：`/wunder/chat/sessions` 默认会话、消息入队
6) **用户侧前端**：时间线 UI、主线程标记与切换
7) **监控与管理**：新增队列事件、管理端队列清理接口

## 12. 测试计划
- **单元测试**：
  - 默认会话映射创建/复用
  - 队列入队/出队/重试
- **集成测试**：
  - `/wunder` 未传 session_id 自动复用
  - 多请求并发时入队顺序正确
  - 会话取消后队列继续执行
- **性能测试**：
  - 高并发排队场景下的吞吐与平均等待时间

## 13. 风险与回滚
- 风险：队列任务堆积导致延迟；需监控 + TTL 清理。
- 回滚：关闭 `agent_queue.enabled` 后恢复为“忙则 429”。

---

该方案将“智能体”从“对话配置”提升为“常驻线程 + 串行队列”的执行单元，强化管理端“终止线程”的语义，并保证 `/wunder` 与 `/wunder/chat` 的一致体验。
