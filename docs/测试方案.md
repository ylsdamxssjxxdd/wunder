# wunder API 测试方案（可落地）

## 1. 目标与覆盖范围
- 功能性：/wunder 入口、SSE 流式协议、工具清单、系统提示词、临时工作区、监控接口等。
- 稳定性：长时间 Soak、错误率、资源泄露趋势（CPU/内存/句柄）。
- 性能：P50/P95/P99 延迟、吞吐、错误率、峰值恢复时间。

## 2. 环境准备
1) 启动后端服务：
```
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

2) 安装依赖：
```
pip install -r requirements.txt
```
说明：如有额外开发依赖，可自行补充 requirements-dev.txt 后安装。

3) 安装 k6（性能/稳定性测试）：
- Windows 建议使用官方包或安装脚本（可参考 k6 官方文档）。

## 3. 功能性测试（pytest）
### 3.1 用例范围
- /wunder 非流式响应：字段与返回内容正确。
- /wunder SSE：progress/llm_output/final 事件完整，最终 answer 可解析。
- 用户并发拒绝：同一 user_id 返回 429。
- /wunder/system_prompt：提示词可返回。
- /wunder/tools：结构完整，返回工具列表。
- /wunder/workspace：上传/列表/下载/删除闭环验证。
- /wunder/admin/monitor：系统资源字段返回。

### 3.2 执行命令
```
pytest
```

说明：功能测试已通过 FakeLLMClient 隔离真实模型，避免外部依赖与联网。

## 4. 性能测试（k6 负载）
### 4.1 负载脚本
- `tests/performance/k6_wunder.js`：统一脚本，通过 `WUNDER_PROFILE` 选择 quick/load/spike/soak。
- quick：单 VU、10 秒，可选固定 user_id 以减少工作区残留
- load：阶梯式升压 5→20→0，支持 WUNDER_STREAM，非流式校验 answer
- spike：短时间冲高并发（最高 80 VU），观察突发与恢复
- soak：固定 VU + duration 长时间施压，阈值更宽关注稳定性

### 4.2 执行命令
```
k6 run -e WUNDER_PROFILE=load tests/performance/k6_wunder.js
k6 run -e WUNDER_PROFILE=spike tests/performance/k6_wunder.js
k6 run -e WUNDER_PROFILE=quick tests/performance/k6_wunder.js
```

Docker 运行（无需本地安装 k6）：
```
docker run --rm -i -e WUNDER_API_KEY=你的密钥 -v "${PWD}:/work" -w /work grafana/k6 run -e WUNDER_PROFILE=load -e WUNDER_BASE_URL=http://192.168.0.2:8000/wunder tests/performance/k6_wunder.js
```

### 4.3 可选参数（环境变量）
- `WUNDER_PROFILE`：压测档位，`quick/load/spike/soak`，默认 `load`
- `WUNDER_BASE_URL`：默认 `http://127.0.0.1:8000/wunder`
- `WUNDER_API_KEY`：API Key（若启用 `security.api_key`，需要提供）
- `WUNDER_USER_PREFIX`：用户前缀（模拟多用户）
- `WUNDER_QUESTION`：压测问题文本
- `WUNDER_STREAM`：是否开启流式（仅 load 使用，默认 false）
- `WUNDER_USER_ID`：固定 user_id（仅 quick 使用，减少工作区残留）
- `WUNDER_SOAK_VUS`：稳定压测 VU 数（仅 soak 使用）
- `WUNDER_SOAK_DURATION`：稳定压测时长（仅 soak 使用）

示例：
```
$env:WUNDER_API_KEY="你的密钥"; $env:WUNDER_BASE_URL="http://127.0.0.1:8000/wunder"; $env:WUNDER_PROFILE="load"; k6 run tests/performance/k6_wunder.js
```

## 5. 稳定性测试（k6 Soak）
### 5.1 Soak 脚本
- `tests/performance/k6_wunder.js`（`WUNDER_PROFILE=soak`）

### 5.2 执行命令
```
$env:WUNDER_PROFILE="soak"; $env:WUNDER_SOAK_VUS="10"; $env:WUNDER_SOAK_DURATION="30m"; k6 run tests/performance/k6_wunder.js
```

### 5.3 观测要点
- 错误率（http_req_failed）是否持续升高。
- 延迟分位（p95/p99）是否随时间漂移。
- 服务端 CPU/内存曲线是否持续上升。

## 6. 指标采集建议
- 服务端：`/wunder/admin/monitor` 可获取进程 CPU/内存数据。
- 日志：`data/wunder.db`（system_logs 表）。
- 操作系统监控：建议配合 Grafana/Prometheus（如已有）。

## 7. 回归与验收建议
- 设定 SLO 目标（如 P95 延迟 < 2s、错误率 < 1%）。
- 每日夜间定时运行 Soak；每次核心改动后跑功能测试与基线压测。

## 8. 评估测试（用例集）
### 8.1 用例说明
- `tests/evaluation/cases/basic.yaml`：基础评估用例，覆盖非流式与流式 SSE 结构校验。
- 评估脚本会自动生成 user_id，避免与真实用户冲突。

### 8.2 执行命令
```
python scripts/run_evaluation.py --base-url http://127.0.0.1:8000/wunder
```

### 8.3 输出说明
- 默认输出到 `data/eval_reports/eval_report_YYYYMMDD_HHMMSS.json`。
- 可通过 `--output` 指定报告路径。

## 9. 清理测试残留
### 9.1 清理工作区与历史数据
```
python scripts/cleanup_test_data.py
```

### 9.2 仅本地清理或删除评估报告
```
python scripts/cleanup_test_data.py --no-api --remove-reports
```
