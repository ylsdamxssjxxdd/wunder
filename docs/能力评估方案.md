# wunder 能力评估方案（仅能力维度）

## 1. 目标与范围
- 目标：构建“能力评估”页面与后端评估能力，用结构化用例验证智能体在工具调用、逻辑推理、常识问答、复杂任务四类能力上的表现，并支持持久化、历史回溯与报告导出。
- 范围：只做能力维度评估，不纳入 TTFB/生成速度等性能指标；评估结果以可判定规则为准，避免主观评分。
- 原则：用例可重复、评分可解释、工具覆盖尽量全、结果可追溯。

## 2. 评估维度与评分口径
### 2.1 工具调用（权重可配置）
- 目的：验证模型是否能在给定任务中正确选择工具，并输出合规的 `<tool_call>` JSON。
- 评分：按用例计算（0/0.5/1）；满足“命中工具 + 基本参数满足 + 输出格式合规”计分。
- 判定依据：SSE 的 `tool_call` 事件 + `<tool_call>` 输出解析；工具名需通过别名映射统一为 canonical（参考 `resolve_tool_name`）。

### 2.2 逻辑推理
- 目的：验证逻辑推断与规则推理能力。
- 评分：单选题（A-D）或简答题；按规则精确匹配或正则匹配。
- 判定依据：最终输出文本（剥离 tool_call 与无关前缀）。

### 2.3 常识问答
- 目的：验证基础常识正确性与稳定性。
- 评分：单选题或短答案；按 exact/choice/regex/contains 规则判定。

### 2.4 复杂任务
- 目的：验证多步操作与工具链组合能力。
- 评分：以“可验证产物”判定（文件存在、内容匹配、目录结构、JSON schema 等）。
- 判定依据：评估运行时工作区与接口返回产物（避免主观打分）。

### 2.5 总分计算
- 每个维度按用例加权平均，维度权重可配置（默认建议：工具 35%、逻辑 25%、常识 20%、复杂 20%）。
- 对不可用/未配置的用例（如缺失 MCP 或技能）标记为 `skipped`，不计入分母，但在报告中显式展示。

## 3. 用例体系与规则
### 3.1 用例存储
- 路径建议：`config/evaluation/cases/*.json`（按维度或语言拆分）；支持版本号与标签。
- 用例字段建议：
  - `id`：唯一标识
  - `dimension`：tool/logic/common/complex
  - `language`：zh-CN/en-US
  - `prompt`：用户问题
  - `weight`：该题权重
  - `timeout_s`：单题超时
  - `checker`：判定规则（choice/exact/regex/contains/tool_called/tool_args/file_exists/file_contains/json_schema）
  - `expected`：期望答案或期望工具调用参数
  - `prerequisites`：所需工具或能力（工具名列表）
  - `tags`：分类标签（如 builtin/mcp/skill/knowledge/user/shared）

### 3.2 工具覆盖策略（尽量覆盖）
- 内置工具：read/write/edit/replace/search/list/execute_command/ptc/最终回复。
- MCP：优先覆盖已启用的 server@tool；若无 MCP 服务则自动跳过该子集。
- Skills：至少覆盖 1-2 个已启用技能；若无技能则跳过。
- 知识库：覆盖系统知识库与用户知识库（存在即用）。
- 自建/共享工具：若存在则加入评估用例，确保从工具清单快照中可发现。
- 判定统一使用 canonical 工具名，避免中英文别名差异导致误判。

### 3.3 复杂任务用例设计
- 以“有产物 + 可验证”为原则，例如：
  - 写入工作区固定路径文件，验证文件存在与内容片段。
  - 生成 JSON 文件并通过 schema 验证字段。
  - 多步任务：搜索 → 读取 → 替换 → 写回，验证前后差异。
- 运行时隔离：每次评估运行使用 `eval/<run_id>` 子目录，避免污染真实用户工作区。

## 4. 执行流程（后端）
1. 创建评估运行（run）：生成 `run_id`、快照当前配置（模型、工具清单、语言、config_overrides）。
2. 选择用例集合：按维度/语言/可用工具过滤，计算实际用例列表与总权重。
3. 逐条执行：
   - 为每题创建独立 `session_id`，构造 `/wunder` 请求并启用 SSE。
   - 监听 `tool_call`/`tool_result`/`llm_output`/`final` 事件，收集输出与工具调用轨迹。
   - 运行 checker 判定，产出 `score`、`status` 与 `detail`。
4. 汇总评分：按维度权重生成总分与摘要。
5. 持久化：写入 run/item 记录，支持历史回溯。
6. 运行终止：支持 cancel（run 级别），取消后标记为 `cancelled` 并保留已完成结果。

## 5. 持久化设计
### 5.1 表结构建议
- `evaluation_runs`
  - `run_id`、`user_id`、`model_name`、`language`、`status`
  - `case_set`、`config_snapshot`、`tool_snapshot`
  - `dimension_scores`（JSON）、`total_score`
  - `started_at`、`finished_at`、`elapsed_s`、`error`
- `evaluation_items`
  - `run_id`、`case_id`、`dimension`、`status`
  - `score`、`max_score`、`weight`
  - `prompt`、`final_answer`、`tool_calls`、`checker_detail`
  - `started_at`、`finished_at`、`elapsed_s`、`error`
- 可选：`evaluation_case_sets`（持久化用例版本快照，便于追溯）

### 5.2 StorageBackend 扩展
- 新增统一接口：`create_eval_run`、`update_eval_run`、`append_eval_item`、`list_eval_runs`、`get_eval_run_detail`、`delete_eval_run`。
- SQLite/Postgres 同步实现，表初始化随 `ensure_initialized` 完成。

## 6. API 设计（管理员）
- `POST /wunder/admin/evaluation/start`
  - 入参：`user_id`、`model_name`、`language`、`case_set`、`dimensions`、`tool_names`、`config_overrides`、`stream`
  - 返回：`run_id`、`status`、`selected_cases`
- `POST /wunder/admin/evaluation/{run_id}/cancel`
  - 取消评估运行
- `GET /wunder/admin/evaluation/runs`
  - 支持过滤：`user_id`、`model_name`、`status`、`time_range`
- `GET /wunder/admin/evaluation/{run_id}`
  - 运行详情 + items 列表
- `DELETE /wunder/admin/evaluation/{run_id}`
  - 删除历史评估记录
- `GET /wunder/admin/evaluation/stream/{run_id}`（SSE）
  - 事件建议：`eval_progress`、`eval_item`、`eval_log`、`eval_finished`

## 7. 前端页面设计
- 替换评估占位页：
  - 运行参数区：user_id、模型、语言、用例集、维度、工具覆盖开关
  - 运行控制：Start/Stop、进度条、当前用例状态
  - 评分面板：维度分数 + 总分；支持柱状图/雷达图
  - 日志区：逐题判定输出（工具调用、最终答案、判定结果）
- 历史区：评估记录列表，支持查看历史记录详情。
- 复用调试面板 SSE 解析与事件展示逻辑，避免重复实现。

## 8. 实施节点（按阶段落地）
### 节点 1：用例与持久化骨架
- 输出：用例结构与示例集、评估数据目录、StorageBackend 扩展与表结构落地。
- 验收：能创建 run 并持久化空结果；用例可被读取并过滤。

### 节点 2：评估执行器与判定器
- 输出：评估运行器（逐题执行 + 判定 + 评分），SSE 进度事件。
- 验收：后端可完整跑通一组用例并生成维度分数与总分。

### 节点 3：管理 API + 前端页面
- 输出：评估 API（start/cancel/list/detail）、前端评估页面与历史查看。
- 验收：浏览器可发起评估、实时看到进度与结果、支持历史回溯。

### 节点 4：用例覆盖与稳定性
- 输出：工具覆盖用例补齐（内置/MCP/技能/知识库/自建/共享），复杂任务用例完善。
- 验收：覆盖率统计可见，评估结果稳定可复现，异常超时可回收。

## 9. 风险与约束
- 工具缺失或未启用会导致用例跳过，需在结果里明确 `skipped` 原因。
- 复杂任务涉及工作区写入，必须隔离目录并提供自动清理策略。
- 评估过程耗时较长，需限制并发与超时，防止影响线上服务。