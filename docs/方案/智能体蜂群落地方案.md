# 智能体蜂群落地方案（wunder）

## 1. 背景与目标

### 1.1 背景
- wunder 已具备基础蜂群能力：
  - 内置工具 `智能体蜂群`（`agent_swarm` / `swarm_control`）支持 `list/status/send/history/spawn`。
  - 子会话运行链路已有 `session_runs` 持久化与 `subagent_announce` 回传。
  - 流式链路已有 WebSocket 优先、SSE 兜底与事件持久化回放。
- 当前短板：
  - 主要是“单次工具调用式蜂群”，缺少“可复用编排模板（team playbook）”。
  - 前端对蜂群执行过程可视化不足（缺少任务拓扑、节点状态、汇聚决策展示）。
  - 缺少“蜂巢”这一显式业务实体，无法让用户在前端创建和管理多个智能体群组。

### 1.2 新目标（按蜂巢分组）
- 不再按 `sandbox_container_id` 划分蜂群范围。
- 引入 **蜂巢（Hive）** 作为新的分组边界：
  - 同一蜂巢内的所有智能体天然属于同一组。
  - 蜂群工具只能看到和管理当前蜂巢内的智能体。
- 用户可以在前端点击“创建蜂巢”获得新的蜂巢，并在蜂巢间切换和管理智能体归属。
- 在不推翻现有架构前提下，以中度重构方式落地（域服务化 + 前端分层）。

### 1.3 非目标（本轮不做）
- 不引入独立分布式调度系统（如外部消息队列集群）。
- 不改动现有 `/wunder` 核心请求协议与认证模型。
- 不做跨租户蜂巢协作（仍限制在同 `user_id` 范围内）。
- 不将 `sandbox_container_id` 作为蜂群权限边界（容器仅保留为沙盒运行属性）。

---

## 2. 现状基线（代码层）
- 工具层：`src/services/tools.rs`
  - `智能体蜂群` 工具规格与动作分发已存在。
  - `spawn_session_run` + `SessionRunRecord` 形成异步执行与结果落库。
- 会话层：`src/api/chat.rs` + `src/storage/*`
  - `chat_sessions` 已有 `parent_session_id/spawn_label/spawned_by`。
  - `session_runs` 已有运行态字段（queued/running/success/error/timeout）。
- 智能体模型：`src/api/user_agents.rs` + `src/storage/mod.rs`
  - 智能体应用已有 `sandbox_container_id`，可继续用于沙盒执行，但不再用于蜂群分组。
- 前端：`frontend/src/views/PortalView.vue` + `frontend/src/stores/chat.js`
  - 有“世界页/门户页”与通用 workflow，但缺少蜂巢实体与创建流程。

---

## 3. 落地总设计（蜂巢分组版）

### 3.1 核心设计原则
- **蜂巢优先**：蜂群权限边界从容器切换到 `hive_id`。
- **中度重构优先**：拆高耦合点，不做全量重写，保留旧接口可用。
- **事件先行**：先定义统一事件模型，再做 UI；避免前后端语义漂移。
- **节点可验收**：每个里程碑节点都有明确输入/输出/验收标准。
- **性能约束**：低内存、低额外写放大；大 payload 按摘要传输。

### 3.2 核心业务模型
- Hive（蜂巢）
  - 表示一个用户可管理的智能体群组空间。
  - 一个用户可拥有多个 Hive。
  - 同一时刻前端可选择“当前 Hive”。
- Agent Membership
  - 智能体属于某个 `hive_id`（一对一归属，便于治理和性能）。
- TeamRun
  - 表示一次蜂群任务，固定归属某个 `hive_id`。
- TaskRun
  - TeamRun 下的子任务节点，执行对象必须属于同一 `hive_id`。

### 3.3 推荐重构蓝图（后端）
- 新增 `src/services/swarm/*` 域模块：
  - `service.rs`：统一入口 `SwarmService`
  - `scope.rs`：`SwarmHiveResolver`（解析当前 `hive_id`）
  - `runner.rs`：编排状态机
  - `merger.rs`：结果汇聚策略
  - `policy.rs`：并发/深度/重试/超时治理
  - `events.rs`：team 事件定义与发射
  - `repo.rs`：蜂群持久化访问抽象
- `tools.rs` 中 `agent_swarm` 保留工具协议，但业务逻辑下沉至 `SwarmService`。

### 3.4 数据模型（数据库）

#### 表 A：`hives`（新增）
- `hive_id` TEXT PK
- `user_id` TEXT NOT NULL
- `name` TEXT NOT NULL
- `description` TEXT NULL
- `is_default` BOOLEAN NOT NULL DEFAULT FALSE
- `status` TEXT NOT NULL DEFAULT `active` (`active/archived`)
- `created_time` DOUBLE PRECISION NOT NULL
- `updated_time` DOUBLE PRECISION NOT NULL

索引建议：
- `(user_id, updated_time DESC)`
- `(user_id, status, updated_time DESC)`

#### 表 B：`user_agents`（扩展）
- 新增字段：`hive_id` TEXT NOT NULL
- 默认值策略：
  - 历史智能体自动迁移到用户默认蜂巢。
  - 新建智能体默认归属当前蜂巢（前端可覆盖）。

索引建议：
- `(user_id, hive_id, updated_at DESC)`

#### 表 C：`team_runs`（新增）
- `team_run_id` TEXT PK
- `user_id` TEXT NOT NULL
- `hive_id` TEXT NOT NULL
- `parent_session_id` TEXT NOT NULL
- `parent_agent_id` TEXT NULL
- `strategy` TEXT NOT NULL
- `status` TEXT NOT NULL (`queued/running/merging/success/failed/cancelled/timeout`)
- `task_total` INT NOT NULL DEFAULT 0
- `task_success` INT NOT NULL DEFAULT 0
- `task_failed` INT NOT NULL DEFAULT 0
- `context_tokens_total` BIGINT NOT NULL DEFAULT 0
- `context_tokens_peak` BIGINT NOT NULL DEFAULT 0
- `model_round_total` BIGINT NOT NULL DEFAULT 0
- `started_time` DOUBLE PRECISION
- `finished_time` DOUBLE PRECISION
- `elapsed_s` DOUBLE PRECISION
- `summary` TEXT NULL
- `error` TEXT NULL
- `updated_time` DOUBLE PRECISION NOT NULL

索引建议：
- `(user_id, hive_id, updated_time DESC)`
- `(hive_id, parent_session_id, updated_time DESC)`
- `(hive_id, status, updated_time DESC)`

#### 表 D：`team_tasks`（新增）
- `task_id` TEXT PK
- `team_run_id` TEXT NOT NULL
- `user_id` TEXT NOT NULL
- `hive_id` TEXT NOT NULL
- `agent_id` TEXT NOT NULL
- `target_session_id` TEXT NULL
- `spawned_session_id` TEXT NULL
- `status` TEXT NOT NULL (`queued/running/success/failed/cancelled/timeout/retry`)
- `retry_count` INT NOT NULL DEFAULT 0
- `priority` INT NOT NULL DEFAULT 0
- `started_time` DOUBLE PRECISION
- `finished_time` DOUBLE PRECISION
- `elapsed_s` DOUBLE PRECISION
- `result_summary` TEXT NULL
- `error` TEXT NULL
- `updated_time` DOUBLE PRECISION NOT NULL

索引建议：
- `(hive_id, team_run_id, updated_time DESC)`
- `(user_id, hive_id, agent_id, updated_time DESC)`
- `(hive_id, status, updated_time DESC)`

约束建议：
- `team_tasks.team_run_id` 外键关联 `team_runs.team_run_id`。
- `team_tasks.hive_id` 必须等于所属 `team_runs.hive_id`。

### 3.5 后端接口设计

#### 3.5.1 Hive 管理 API（新增）
1. `POST /wunder/hives`
- 创建蜂巢。
- 入参：`name`、`description`（可选）。
- 出参：`hive_id`、`name`、`status`。

2. `GET /wunder/hives`
- 列出当前用户的蜂巢。

3. `PATCH /wunder/hives/{hive_id}`
- 修改蜂巢名称/描述/状态。

4. `POST /wunder/hives/{hive_id}/agents`
- 批量将智能体加入目标蜂巢（或迁移智能体到新蜂巢）。

#### 3.5.2 TeamRun API（新增）
1. `POST /wunder/chat/team_runs`
- 创建蜂群任务。
- 入参：`parent_session_id`、`hive_id`（可选）`strategy`、`tasks[]`、`merge_policy`、`timeout_s`。
- 规则：
  - 工具调用场景自动从当前智能体会话解析 `hive_id`。
  - 前端手动发起场景可显式传 `hive_id`，服务端校验必须属于当前用户。

2. `GET /wunder/chat/team_runs/{team_run_id}`
- 查询团队任务详情（含任务列表、状态汇总、耗时、摘要）。

3. `POST /wunder/chat/team_runs/{team_run_id}/cancel`
- 取消团队任务，级联取消进行中的子任务。

4. `GET /wunder/chat/sessions/{session_id}/team_runs`
- 查询某父会话下的蜂群运行历史（可按 `hive_id` 过滤）。

#### 3.5.3 工具侧约束（现有 `智能体蜂群`）
- `list/status/send/history/spawn` 五个 action 统一追加 `hive_id` 过滤。
- 工具触发 TeamRun 时自动继承当前智能体 `hive_id`，无需模型显式传参。
- 指向其他蜂巢的 agent/session 时返回 `SWARM_HIVE_DENIED`。
- 工具层只做参数标准化与错误映射，不承载核心编排逻辑。

#### 3.5.4 管理侧 API（新增）
1. `GET /wunder/admin/team_runs`
- 多维筛选（状态/用户/时段/策略/`hive_id`）。
2. `GET /wunder/admin/team_runs/{team_run_id}`
- 查看详情与异常上下文。
3. `GET /wunder/admin/hives/{hive_id}/team_runs`（可选）
- 单蜂巢运营视图。

### 3.6 事件协议（SSE/WS 统一）
新增 Team 事件类型：
- `team_start`
- `team_task_dispatch`
- `team_task_update`
- `team_task_result`
- `team_merge`
- `team_finish`
- `team_error`

统一 payload 关键字段：
- `team_run_id`
- `hive_id`（必填）
- `task_id`（任务事件时）
- `agent_id`
- `session_id`
- `status`
- `summary`
- `user_round/model_round`
- `timestamp`

### 3.7 调度与并发策略
- 并发上限仍受 `server.max_active_sessions` 控制。
- 新增配置：
  - `agent_swarm.max_active_team_runs`
  - `agent_swarm.max_parallel_tasks_per_team`
  - `agent_swarm.default_timeout_s`
  - `agent_swarm.max_retry`
- 建议按蜂巢分桶调度：
  - `team_queue:{hive_id}`，避免单蜂巢占满全局资源。

### 3.8 权限与安全
- 仅允许访问当前 `user_id` 下可见 agent 与会话。
- 同一 `user_id` 下仍必须满足 `hive_id` 相同才能进入同一 TeamRun。
- 统一越界错误码：`SWARM_HIVE_DENIED`。
- 禁止跨用户 `team_run` 关联。

### 3.9 Token 与成本统计
- 坚持“上下文占用量”口径：记录 `context_tokens`。
- 在 `team_runs` 汇总：
  - `context_tokens_total`
  - `context_tokens_peak`
  - `model_round_total`
- 支持按 `hive_id` 聚合展示。

---

## 4. 前端展示与交互方案

### 4.1 蜂巢页（原世界页）
- 页面命名改为“蜂巢”。
- 顶部展示当前蜂巢汇总：
  - 智能体总数
  - 运行中 TeamRun 数
  - 近 1h 成功率
  - 平均时延/超时数
- 智能体卡片使用六边形蜂巢样式（兼容深浅主题，不使用 `backdrop-filter`）。

### 4.2 蜂巢管理交互（新增）
- 顶部新增“蜂巢切换器 + 创建蜂巢按钮”。
- 点击“创建蜂巢”流程：
  1) 打开创建弹窗（名称必填，描述可选）；
  2) 调用 `POST /wunder/hives` 创建；
  3) 创建后自动切换到新蜂巢；
  4) 提示将智能体迁入该蜂巢（可立即操作或稍后配置）。
- 新增“批量迁移智能体到蜂巢”交互，支持从当前蜂巢移动到目标蜂巢。

### 4.3 聊天页蜂群面板
- 新增 `SwarmPanel`：任务泳道 + 拓扑时间线 + 汇聚结果。
- 面板显示当前 `hive_id`。
- 仅渲染当前蜂巢范围内 team 事件。

### 4.4 管理端（web）
- 新增蜂群运行视图：
  - 支持按 `hive_id` 筛选
  - 统计 TopN 慢任务/失败智能体
  - 下钻 team run 事件链

---

## 5. 落地节点（重构版里程碑）

### 节点 R0：基线冻结
- 输出：Hive 模型、API 契约、错误码、灰度开关。
- 验收：后端/前端/测试三方评审通过。

### 节点 R1：后端域模块骨架
- 输出：`src/services/swarm/*` 模块与 `SwarmService` 入口。
- 验收：`agent_swarm` 五动作全部通过服务层。

### 节点 R2：存储层改造
- 输出：`hives` + `user_agents.hive_id` + `team_runs/team_tasks`。
- 验收：可完整创建/查询/更新 Hive 与 TeamRun。

### 节点 R3：编排器与汇聚
- 输出：`SwarmRunner` + merge policy。
- 验收：支持并行、重试、取消、汇聚。

### 节点 R4：API 与管理查询
- 输出：`/wunder/hives` 与 `/wunder/chat/team_runs` 系列 API。
- 验收：用户侧/管理侧都能按 `hive_id` 查询。

### 节点 R5：事件流与回放
- 输出：Team 事件入持久化白名单并支持 resume。
- 验收：断线可恢复完整 team 轨迹。

### 节点 R6：前端蜂巢改造
- 输出：蜂巢页面、蜂巢创建弹窗、蜂巢切换与迁移。
- 验收：用户可创建新蜂巢并管理该蜂巢智能体。

### 节点 R7：治理与性能
- 输出：限流、深度、审计、慢任务指标。
- 验收：压测下无失控、异常可定位。

### 节点 R8：测试、灰度、回滚
- 输出：全量测试、灰度切流、回滚预案。
- 验收：可灰度、可回滚、可观测。

---

## 6. 测试策略
- 单元测试：
  - `SwarmHiveResolver`、状态机、merge、权限守卫。
- 集成测试：
  - Hive 创建 -> 智能体迁移 -> TeamRun 执行 -> 事件回放。
- 前端测试：
  - 蜂巢创建/切换/迁移流程。
  - `SwarmPanel` 回放与过滤。
- 压测建议：
  - 50/100/200 并发 TeamRun。
  - 多蜂巢并发下验证分桶公平性。

---

## 7. 发布与回滚
- 发布顺序：
  1) 后端存储与服务（隐藏入口）；
  2) API 与事件协议；
  3) 前端蜂巢创建与可视化；
  4) 灰度开启 `team_runner`。
- 回滚策略：
  - 配置切回 `legacy`。
  - 保留新表，停止写入新路径。
  - `agent_swarm` 旧能力作为兜底。

---

## 8. 与现有能力兼容策略
- 保持 `智能体蜂群` 工具兼容：已有 `action` 不改语义。
- 新增能力通过“可选参数 + 新 API”扩展。
- `sandbox_container_id` 保留为沙盒执行属性，不再承担蜂群分组职责。

---

## 9. 预期收益
- 群组语义更贴近产品心智：用户直接管理“蜂巢”。
- 前端可自助创建蜂巢，组织多智能体协作更直观。
- 后端编排层完成解耦，后续扩展策略与治理成本更低。

---

## 10. 决策建议
- 推荐采用“完整中度重构路线（R0-R8）”。
- 第一阶段优先完成 R0-R2，尽快把“蜂巢实体 + 智能体归属”打通。
- 第二阶段推进 R3-R6，形成前后端可用闭环。

> 本方案核心变化：蜂群分组从“容器维度”切换为“蜂巢维度”，并将“创建蜂巢”作为前端一等能力。
