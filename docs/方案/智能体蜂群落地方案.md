# 智能体蜂群落地方案（wunder）

## 1. 背景与目标

### 1.1 背景
- wunder 已具备基础蜂群能力：
  - 内置工具 `智能体蜂群`（`agent_swarm` / `swarm_control`）支持 `list/status/send/history/spawn`。
  - 子会话运行链路已有 `session_runs` 持久化与 `subagent_announce` 回传。
  - 流式链路已有 WebSocket 优先、SSE 兜底与事件持久化回放。
- 当前短板：
  - 主要是“单次工具调用式蜂群”，缺少“可复用编排模板（team playbook）”。
  - 前端对蜂群执行过程可视化不足（缺少任务拓扑、节点状态、汇聚决策展示）。
  - 缺少清晰的“容器级边界”治理，易导致同用户下不同容器应用混杂。
  - 蜂群逻辑集中在大文件，后续演进成本高（典型是 `tools.rs` / 前端大 store 持续膨胀）。

### 1.2 总体目标
- 将智能体蜂群升级为 **可编排、可追踪、可回放、可治理** 的一等能力。
- 蜂群强制采用 **同容器作用域**：同一 `sandbox_container_id` 内可见、可调度、可管理。
- 采用 **中度重构路线**：不推翻现有架构，但把蜂群从“工具内逻辑”升级为“独立域能力”。
- 分阶段落地：
  1) 先完成后端域拆分与容器约束；
  2) 再补齐前端蜂巢可视化；
  3) 最后固化治理、压测、灰度发布。

### 1.3 非目标（本轮不做）
- 不引入独立分布式调度系统（如外部消息队列集群）。
- 不改动现有 `/wunder` 核心请求协议与认证模型。
- 不做跨租户蜂群协作（仍限制在同 `user_id` 范围内）。
- 不做跨容器蜂群协作（不同 `sandbox_container_id` 之间严格隔离）。

---

## 2. 现状基线（代码层）
- 工具层：`src/services/tools.rs`
  - `智能体蜂群` 工具规格与动作分发已存在。
  - `spawn_session_run` + `SessionRunRecord` 形成异步执行与结果落库。
- 会话层：`src/api/chat.rs` + `src/storage/*`
  - `chat_sessions` 已有 `parent_session_id/spawn_label/spawned_by`。
  - `session_runs` 已有运行态字段（queued/running/success/error/timeout）。
- 智能体模型：`src/api/user_agents.rs` + `src/storage/mod.rs`
  - 智能体应用已有 `sandbox_container_id` 字段，可作为蜂群作用域边界。
- 监控与事件：`src/orchestrator/event_stream.rs` + `src/ops/monitor.rs`
  - 已有事件持久化与断线续传。
  - 已有 `user_round/model_round` 分轮逻辑。
- 前端：`frontend/src/stores/chat.js` + `frontend/src/views/PortalView.vue`
  - 有通用 workflow 列表和“世界页”能力，但缺少容器维度聚合与蜂群专属视图。

---

## 3. 落地总设计

### 3.1 核心设计原则
- **复用优先**：最大化复用现有 Orchestrator / Monitor / Storage。
- **中度重构优先**：拆高耦合点，不做全量重写，保留旧接口可用。
- **事件先行**：先定义统一事件模型，再做 UI；避免前后端语义漂移。
- **容器隔离优先**：蜂群所有读写默认附带 `scope_container_id`，禁止跨容器访问。
- **节点可验收**：每个里程碑节点必须有明确“输入/输出/验收标准”。
- **性能约束**：默认低内存、低额外写放大；大 payload 按摘要传输。
- **十年可维护**：版本化事件协议、模板规范化、指标可观测。

### 3.2 蜂群编排模型
新增“团队运行（Team Run）”抽象，覆盖一次蜂群任务全流程。

- TeamRun
  - 表示一次父任务的整体执行，包含多个 TaskRun。
  - 关键字段：`team_run_id`、`parent_session_id`、`scope_container_id`、`strategy`、`status`、`started_at`、`finished_at`。
- TaskRun
  - 表示一个子任务节点，通常映射到一个子会话或一次跨智能体发送。
  - 关键字段：`task_id`、`team_run_id`、`scope_container_id`、`agent_id`、`session_id`、`status`、`retry_count`、`result_summary`。
- Container Hive Scope（强约束）
  - 每次蜂群运行固定一个 `scope_container_id`（运行时不可变）。
  - TeamRun 只能调度同 `scope_container_id` 的智能体应用。
  - 任务查询、状态查询、消息发送、历史读取、子会话拉起均按同容器过滤。
- Strategy（编排策略）
  - `parallel_all`：并行执行全部子任务。
  - `parallel_quorum`：并行执行，达到阈值即汇聚。
  - `pipeline`：串行流水线（A 输出给 B）。
  - `review_gate`：审查门（先执行、后验证、再汇总）。

> 首期默认支持 `parallel_all` 与 `review_gate`。

### 3.3 推荐重构蓝图（后端）
目标：把蜂群能力从“工具函数集合”重构为“独立域模块”，工具层仅适配。

#### 3.3.1 模块分层
- `src/services/swarm/mod.rs`
  - 对外统一入口 `SwarmService`。
- `src/services/swarm/scope.rs`
  - `SwarmScopeResolver`：解析与校验 `scope_container_id`。
- `src/services/swarm/runner.rs`
  - `SwarmRunner`：状态机与任务调度。
- `src/services/swarm/merger.rs`
  - `SwarmMerger`：`first_success/best_confidence/consensus`。
- `src/services/swarm/policy.rs`
  - 并发、深度、白名单、超时、重试策略。
- `src/services/swarm/events.rs`
  - Team 事件定义与落库桥接。
- `src/services/tools.rs`
  - 保留 `agent_swarm` 工具名与动作参数，但内部改为调用 `SwarmService`。

#### 3.3.2 仓储层拆分
- 在 `src/storage/swarm_repo.rs` 定义 `SwarmRepo`（子 trait）。
- `postgres/sqlite` 各自在独立文件实现 swarm repo（避免继续扩张主文件）。
- `StorageBackend` 保留兼容入口：
  - 第一阶段可桥接到 `SwarmRepo`；
  - 第二阶段逐步把 swarm 方法从主 trait 收敛到子 trait。

#### 3.3.3 API 层职责收敛
- `chat/user_tools/admin` 仅做：鉴权、参数校验、错误映射。
- 编排、重试、容器过滤全部在 `SwarmService` 内统一执行。
- 统一错误码：
  - `SWARM_SCOPE_UNRESOLVED`
  - `SWARM_SCOPE_DENIED`
  - `SWARM_POLICY_BLOCKED`
  - `SWARM_RUN_TIMEOUT`

#### 3.3.4 兼容策略
- 工具名、动作名、主要字段保持兼容。
- 旧调用路径可继续使用；新能力通过可选参数和新 API 暴露。
- 通过配置开关控制新旧运行器切换：
  - `agent_swarm.runner = legacy | team_runner`

### 3.4 数据模型（数据库）
在现有 `session_runs` 基础上新增两张表，减少语义混用。

#### 表 A：`team_runs`
- `team_run_id` TEXT PK
- `user_id` TEXT NOT NULL
- `scope_container_id` TEXT NOT NULL
- `parent_session_id` TEXT NOT NULL
- `parent_agent_id` TEXT NULL
- `strategy` TEXT NOT NULL
- `status` TEXT NOT NULL (`queued/running/merging/success/failed/cancelled/timeout`)
- `task_total` INT NOT NULL DEFAULT 0
- `task_success` INT NOT NULL DEFAULT 0
- `task_failed` INT NOT NULL DEFAULT 0
- `started_time` DOUBLE PRECISION
- `finished_time` DOUBLE PRECISION
- `elapsed_s` DOUBLE PRECISION
- `summary` TEXT NULL
- `error` TEXT NULL
- `context_tokens_total` BIGINT NOT NULL DEFAULT 0
- `context_tokens_peak` BIGINT NOT NULL DEFAULT 0
- `model_round_total` BIGINT NOT NULL DEFAULT 0
- `updated_time` DOUBLE PRECISION NOT NULL

索引：
- `(user_id, scope_container_id, updated_time DESC)`
- `(scope_container_id, parent_session_id, updated_time DESC)`
- `(scope_container_id, status, updated_time DESC)`

#### 表 B：`team_tasks`
- `task_id` TEXT PK
- `team_run_id` TEXT NOT NULL
- `user_id` TEXT NOT NULL
- `scope_container_id` TEXT NOT NULL
- `agent_id` TEXT NOT NULL
- `target_session_id` TEXT NULL
- `spawned_session_id` TEXT NULL
- `status` TEXT NOT NULL (`queued/running/success/failed/cancelled/timeout/retry`)
- `retry_count` INT NOT NULL DEFAULT 0
- `priority` INT NOT NULL DEFAULT 0
- `started_time` DOUBLE PRECISION
- `finished_time` DOUBLE PRECISION
- `elapsed_s` DOUBLE PRECISION
- `result_summary` TEXT NULL
- `error` TEXT NULL
- `updated_time` DOUBLE PRECISION NOT NULL

索引：
- `(scope_container_id, team_run_id, updated_time DESC)`
- `(user_id, scope_container_id, agent_id, updated_time DESC)`
- `(scope_container_id, status, updated_time DESC)`

约束建议：
- `team_tasks.team_run_id` 外键关联 `team_runs.team_run_id`。
- `team_tasks.scope_container_id` 必须等于所属 `team_runs.scope_container_id`。
- 原有 `session_runs` 保留，用于单子会话运行记录；`team_*` 聚焦蜂群视角。

### 3.5 后端接口设计

#### 3.5.1 容器作用域解析规则（强约束）
- 统一作用域字段：`scope_container_id`。
- 作用域解析顺序：
  1) 请求来自智能体工具调用时，取当前智能体 `sandbox_container_id`；
  2) 请求来自会话上下文时，取父会话绑定智能体的 `sandbox_container_id`；
  3) 仍无法解析时拒绝执行，返回 `SWARM_SCOPE_UNRESOLVED`。
- 用户侧请求不得传入或覆盖 `scope_container_id`；后端同名字段忽略并记录审计。
- 所有蜂群查询/写入都必须附带 `user_id + scope_container_id` 双条件过滤。

#### 3.5.2 用户侧 API（新增）
1. `POST /wunder/chat/team_runs`
- 创建蜂群任务。
- 入参：`parent_session_id`、`strategy`、`tasks[]`、`merge_policy`、`timeout_s`。
- 后端行为：
  - 自动解析并写入 `scope_container_id`；
  - 过滤 `tasks[]` 中跨容器目标，若全被过滤则报错 `SWARM_SCOPE_DENIED`。
- 出参：`team_run_id`、`status`、`scope_container_id`。

2. `GET /wunder/chat/team_runs/{team_run_id}`
- 查询团队任务详情（含任务列表、状态汇总、耗时、摘要）。
- 权限：仅当 `team_run.user_id == current_user_id` 且 `team_run.scope_container_id == current_scope_container_id` 时可读。

3. `POST /wunder/chat/team_runs/{team_run_id}/cancel`
- 取消团队任务，级联取消进行中的子任务。
- 权限：同容器校验不通过时返回 `SWARM_SCOPE_DENIED`。

4. `GET /wunder/chat/sessions/{session_id}/team_runs`
- 查询某父会话下的蜂群运行历史。
- 返回结果仅包含当前 `scope_container_id` 内数据。

#### 3.5.3 工具侧约束（现有 `智能体蜂群`）
- `list/status/send/history/spawn` 五个 action 统一追加 `scope_container_id` 过滤。
- 工具触发 TeamRun 时自动继承当前智能体容器，无需模型显式传参。
- `send/spawn` 指向跨容器 agent 或会话时，统一返回错误：`SWARM_SCOPE_DENIED`。
- 工具层只做参数标准化和错误映射，不承载蜂群核心业务逻辑。

#### 3.5.4 管理侧 API（新增）
1. `GET /wunder/admin/team_runs`
- 多维筛选（状态/用户/时段/策略/`scope_container_id`）。
2. `GET /wunder/admin/team_runs/{team_run_id}`
- 查看详情与异常上下文。
3. `GET /wunder/admin/containers/{container_id}/team_runs`（可选）
- 面向单容器运营视图，便于定位隔离域内异常。

### 3.6 事件协议（SSE/WS 统一）
新增事件类型（进入 `stream_events` 持久化白名单）：
- `team_start`
- `team_task_dispatch`
- `team_task_update`
- `team_task_result`
- `team_merge`
- `team_finish`
- `team_error`

统一 payload 关键字段：
- `team_run_id`
- `scope_container_id`（必填）
- `task_id`（任务事件时）
- `agent_id`
- `session_id`
- `status`
- `summary`
- `user_round/model_round`
- `timestamp`

约束：
- 事件正文仅放摘要；大结果写数据库后仅回传 `result_ref`。
- 事件字段保持向后兼容，新增字段必须可选（team 事件中的 `scope_container_id` 为必填）。

### 3.7 调度与并发策略
- 并发上限仍受 `server.max_active_sessions` 控制。
- 新增蜂群并发配置（建议）：
  - `agent_swarm.max_active_team_runs`
  - `agent_swarm.max_parallel_tasks_per_team`
  - `agent_swarm.default_timeout_s`
  - `agent_swarm.max_retry`
- 按容器分桶调度：
  - `team_queue:{scope_container_id}`，避免单容器占满全局资源。
- 锁域策略：
  - 父会话：维持现有 session lock。
  - 子任务：独立 `subagent:{session_id}` 锁域。
  - 团队运行：`team:{team_run_id}` 软锁，防止重复 merge。

### 3.8 结果汇聚（Merge）策略
首期提供三种可配置合并策略：
- `first_success`：第一个成功结果即返回（低延迟）。
- `best_confidence`：按评分选最优（质量优先）。
- `consensus`：多任务一致性判定后输出（稳健优先）。

实现建议：
- 汇聚前统一做 `result_summary` 归一化。
- 若策略需要打分，打分逻辑下沉为独立函数，便于后续替换模型评审器。

### 3.9 权限与安全
- 仅允许访问当前 `user_id` 下可见 agent 与会话。
- 同一 `user_id` 下仍必须满足 `scope_container_id` 相同。
- `includeCurrent` 默认 false，避免自调用死循环。
- 增加蜂群递归深度限制：`agent_swarm.max_depth`（默认 2）。
- 禁止跨用户、跨容器 `team_run` 关联。
- 统一越界错误码：`SWARM_SCOPE_DENIED`，并记录审计日志（触发人、策略、目标、容器、动作）。

### 3.10 Token 与成本统计
- 坚持“上下文占用量”口径：记录 `context_tokens`，不混用总消耗。
- 在 `team_runs` 汇总：
  - `context_tokens_total`
  - `context_tokens_peak`
  - `model_round_total`
- 支持按容器聚合统计（`scope_container_id` 维度）。
- 前端展示默认摘要，详细 token 明细按需展开。

---

## 4. 前端展示与重构方案

### 4.1 前端分层重构（推荐）
- 新增 `frontend/src/stores/beehive.js`：
  - 负责 team runs、team tasks、容器统计、事件聚合。
- `chat.js` 只保留会话消息流；蜂群状态迁移到 beehive store。
- 组件拆分建议：
  - `frontend/src/components/beehive/BeehiveSummaryBar.vue`
  - `frontend/src/components/beehive/BeehiveHexCard.vue`
  - `frontend/src/components/beehive/SwarmTimeline.vue`
  - `frontend/src/components/beehive/SwarmTaskLane.vue`
- 结果：降低 `PortalView.vue` 与 `chat.js` 膨胀速度，减少跨页面状态污染。

### 4.2 用户侧聊天页（frontend）
新增「蜂群执行面板」（建议组件：`frontend/src/components/chat/SwarmPanel.vue`）：
- 视图 1：任务泳道（按 agent 分组）
- 视图 2：拓扑时间线（dispatch -> running -> merge -> finish）
- 视图 3：汇聚结果与降级说明（为何选此结果）

交互要求：
- 面板头部展示当前 `scope_container_id`。
- 仅展示当前容器作用域内任务和智能体应用。
- 支持取消团队任务、点击任务跳转子会话。
- 支持断线恢复后从 `event_id` 继续渲染。

### 4.3 蜂巢页面（原“世界”页面）
- 页面命名改为“蜂巢”，定位为容器级蜂群总览。
- 顶部标题汇总当前容器统计：
  - 活跃智能体数
  - 运行中 TeamRun 数
  - 近 1h 成功率
  - 平均耗时 / 超时数
- 智能体应用卡片改为六边形蜂巢卡样式（保持深浅主题兼容，不使用 `backdrop-filter`）。
- 卡片与操作仅显示同 `scope_container_id` 智能体应用。

### 4.4 会话历史区改造
- 将平铺会话列表升级为“父子树”模式（按 `parent_session_id` 组织）。
- 对 `spawned_by=swarm/model` 显示不同标识。
- 支持筛选：仅主会话 / 仅子会话 / 仅蜂群任务会话。
- 增加容器筛选提示：仅展示当前 `scope_container_id` 内历史。

### 4.5 管理端（web）
新增「蜂群运行视图」：
- 运行数、成功率、超时率、平均时延。
- Top N 慢任务、Top N 失败 agent。
- 支持按 `team_run_id` 下钻查看完整事件链。
- 支持按 `scope_container_id` 聚合筛选并导出。

---

## 5. 落地节点（重构版里程碑）

### 节点 R0：重构基线冻结
- 输出物：
  - 新模块目录草案（后端 swarm / 前端 beehive）。
  - 错误码规范与开关策略（`legacy | team_runner`）。
  - 事件协议 v1 与容器作用域规则。
- 验收标准：
  - 后端/前端/测试三方评审通过。

### 节点 R1：后端域模块骨架
- 任务：
  - 新建 `src/services/swarm/*` 模块骨架。
  - 完成 `SwarmScopeResolver` 与 `SwarmPolicy` 最小可用版本。
  - `tools.rs` 接入 `SwarmService`（仅 adapter 化，不改外部工具协议）。
- 验收标准：
  - 工具调用能进入新服务层。
  - 同容器过滤在 `list/status/send/history/spawn` 生效。

### 节点 R2：存储层落地（SwarmRepo + team_*）
- 任务：
  - Postgres/SQLite 增加 `team_runs/team_tasks` 表与索引。
  - 新增 `SwarmRepo` trait 与实现。
  - 增加 `scope_container_id` 跨表一致性校验。
- 验收标准：
  - TeamRun/TaskRun 可完整落库、查询、更新。
  - 无法写入跨容器 task（数据库与业务层双重拦截）。

### 节点 R3：编排器与汇聚策略
- 任务：
  - 完成 `SwarmRunner` 状态机。
  - 接入 `spawn_session_run` 与现有发送能力。
  - 支持 `parallel_all/review_gate` + 3 种 merge policy。
- 验收标准：
  - 一次请求可并发启动多个任务并完成 merge。
  - 超时/重试/取消路径可控。

### 节点 R4：API 与管理查询
- 任务：
  - 新增 `/wunder/chat/team_runs` 系列 API。
  - 新增 admin 侧按容器筛选 API。
  - 统一错误码映射与审计字段。
- 验收标准：
  - 用户和管理端均可稳定查询 team run 生命周期。
  - 同用户跨容器访问全部拒绝，返回 `SWARM_SCOPE_DENIED`。

### 节点 R5：事件流与回放
- 任务：
  - 增加 team 事件并接入持久化回放。
  - `resume` 与 WS 回放适配 team 事件。
  - 事件 payload 全量携带 `scope_container_id`。
- 验收标准：
  - 断线恢复后可重建完整蜂群轨迹。
  - 无跨容器事件泄漏。

### 节点 R6：前端蜂巢改造
- 任务：
  - “世界页面”重命名为“蜂巢”。
  - 上线 `BeehiveSummaryBar` + 六边形智能体卡片。
  - 新增 `beehive` store，接管蜂群运行态。
- 验收标准：
  - 用户仅可见当前容器蜂群与统计。
  - 深浅主题下视觉一致且性能稳定。

### 节点 R7：治理与性能
- 任务：
  - 并发限流、深度限制、白名单与取消级联完善。
  - 容器分桶调度与公平性优化。
  - 审计告警与慢任务指标上线。
- 验收标准：
  - 压测下无队列失控、无递归爆炸。
  - 同用户跨容器越界全部可审计追踪。

### 节点 R8：测试、灰度、回滚
- 任务：
  - 单元/集成/回归/压测全套执行。
  - 灰度切流：`legacy -> team_runner`。
  - 完成回滚脚本与操作手册。
- 验收标准：
  - 关键链路自动化通过。
  - 生产可灰度、可回滚、可观测。

---

## 6. 测试策略
- 单元测试：
  - `SwarmScopeResolver` 解析逻辑、权限守卫。
  - `SwarmRunner` 状态机、merge 策略、重试退避。
- 集成测试：
  - `team_runs` API + 事件流 + DB 一致性。
  - `list/status/send/history/spawn` 全链路同容器过滤。
- 前端测试：
  - `beehive` store 事件消费与断线恢复。
  - `SwarmPanel`、蜂巢页统计与过滤快照测试。
- 压测建议：
  - 50/100/200 并发 team run 分级压测。
  - 多容器并发压测，验证分桶公平性与内存曲线。

---

## 7. 发布与回滚
- 发布顺序：
  1) 后端新模块与存储（隐藏入口）；
  2) 事件协议与前端渲染；
  3) 灰度开启 team_runner。
- 灰度策略：
  - 按用户白名单与容器白名单渐进放量。
  - 观察失败率、时延、超时、跨容器拒绝率。
- 回滚策略：
  - 配置开关切回 `legacy` 运行器。
  - 保留原有 `agent_swarm` 单次调用能力兜底。

---

## 8. 与现有能力兼容策略
- 保持 `智能体蜂群` 工具兼容：已有 `action` 不改语义。
- 新增能力优先通过“可选参数 + 新 API”扩展，避免破坏旧调用。
- 行为增强点：现有 `list/status/send/history/spawn` 统一增加容器作用域过滤。
- 保持前端主题与性能约束：
  - 不使用 `backdrop-filter`。
  - 深浅色主题下统一状态色语义。

---

## 9. 预期收益
- 从“单次多智能体调用”升级为“可治理团队编排”。
- 在不重写系统的前提下完成关键解耦，降低后续维护成本。
- 蜂群管理边界清晰：同用户下按容器隔离，避免互相干扰。
- 用户可见性显著提升：知道谁在做、做到哪步、为何这样合并。
- 管理端可运维：可衡量、可诊断、可限流、可审计。

---

## 10. 决策建议
- 若目标是“尽快上线基础蜂群”：可先执行 R1~R4。
- 若目标是“长期稳定 + 高频迭代”：建议完整执行 R1~R8。
- 综合当前 wunder 体量与未来演进，推荐采用 **完整中度重构路线（R1~R8）**。

> 本方案遵循“最小侵入、分期交付、可回滚”的原则，在保证兼容的前提下完成关键架构重构，确保蜂群能力可持续演进。
