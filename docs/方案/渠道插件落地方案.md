# 渠道插件落地方案

## 1. 背景与目标

当前 wunder 的渠道能力已经具备“统一消息模型 + 统一会话路由 + 统一出站队列”的基础，但**新增一个渠道仍需要改 Rust 主干代码**，主要体现在：

- 需要新增渠道模块并注册到 `src/channels/mod.rs`。
- 需要在 `src/api/channel.rs` 增加专用 webhook 解析与验签逻辑。
- 需要在 `src/channels/service.rs` 的出站分发里增加 `if/else` 分支。
- 需要在 `src/channels/types.rs` 的 `ChannelAccountConfig` 增加渠道专属字段。
- 需要在 `src/api/user_channels.rs`、`frontend/src/components/channels/UserChannelSettingsPanel.vue`、`web/modules/channels.js` 分别补齐前后端静态渠道列表与配置表单。

目标：把“新增渠道”从“改主仓代码”变成“安装插件 + 配置账号 + 启用绑定”，管理员可在**管理端渠道监控**完成插件安装与启停。

---

## 2. 现状代码审查结论（关键耦合点）

### 2.1 后端渠道入口耦合（高）

1. `src/api/channel.rs`
   - 路由存在显式硬编码：
     - `/wunder/channel/whatsapp/webhook`
     - `/wunder/channel/feishu/webhook`
     - `/wunder/channel/wechat/webhook`
     - `/wunder/channel/wechat_mp/webhook`
     - `/wunder/channel/qqbot/webhook`
   - 每个渠道都有独立的解析、验签、账号识别逻辑。

2. `src/channels/service.rs`
   - `deliver_outbox_record` 中按渠道常量分支发送（whatsapp/feishu/qqbot/wechat/wechat_mp）。
   - 飞书长连接调度器在 `ChannelHub` 内部专门实现，无法复用到其他渠道。

3. `src/channels/types.rs`
   - `ChannelAccountConfig` 内嵌 `feishu/qqbot/wechat/wechat_mp/whatsapp_cloud` 专属结构体，新增渠道必须改类型定义。

### 2.2 管理端与用户端配置耦合（高）

1. `src/api/user_channels.rs`
   - `SUPPORTED_USER_CHANNELS` 静态常量限制可配置渠道。
   - 渠道专属校验逻辑写死（如 feishu/wechat/wechat_mp）。

2. `frontend/src/components/channels/UserChannelSettingsPanel.vue`
   - `FALLBACK_CHANNELS`、`USER_ONLY_CHANNELS` 静态。
   - 创建/编辑逻辑内嵌 feishu 特殊分支。

3. `web/modules/channels.js` + `web/index.html`
   - 当前“渠道监控”仅做账号列表和配置快照展示，没有插件安装生命周期管理。

### 2.3 数据模型缺口（中）

现有表（`channel_accounts/channel_bindings/channel_sessions/channel_messages/channel_outbox`）可复用“账号、路由、会话、消息、出站”主链路，但缺少：

- 插件包与版本元数据
- 插件运行状态（健康、崩溃、重启次数）
- 插件安装来源、签名、校验信息

---

## 3. 方案总览

采用**进程隔离插件**（推荐）实现渠道扩展：

- 核心服务仅维护统一协议和运行时（Plugin Runtime）。
- 每个渠道插件独立进程（可执行文件），通过 JSON-RPC（stdio）与主进程通信。
- 插件负责“渠道协议细节”（验签、格式转换、三方 API 发送）。
- 主进程继续负责“业务主链路”（绑定、会话、编排、出站队列、监控）。

> 不建议首版采用 Rust 动态库热加载（ABI 稳定性与跨平台维护成本过高）。

---

## 4. 目标架构

```text
渠道平台(如 QQ/WhatsApp/企业微信)
          |
          v
/wunder/channel/{provider}/webhook  (统一入口)
          |
          v
Channel Plugin Runtime (主进程)
  -> 调用 provider 插件 parse_inbound
  -> 产出标准 ChannelMessage
          |
          v
ChannelHub (现有)
  绑定路由 -> 会话映射 -> Orchestrator -> 生成回复
          |
          v
channel_outbox
          |
          v
Channel Plugin Runtime
  -> 调用 provider 插件 send_outbound
          |
          v
渠道平台
```

说明：
- `ChannelHub` 不再写渠道分支，只调用“Provider 抽象”。
- Provider 可来自：`builtin`（内置）或 `plugin`（安装包）。
- 首版先支持 webhook 模式；长连接模式作为第二阶段能力。

---

## 5. 插件协议设计（MVP）

### 5.1 插件包结构

```text
channel-plugin.zip
├─ plugin.json              # manifest
├─ bin/
│  ├─ linux-amd64/plugin
│  ├─ windows-amd64/plugin.exe
│  └─ darwin-arm64/plugin
└─ schemas/
   └─ account.schema.json   # 账号配置表单 schema（可选）
```

### 5.2 Manifest（建议字段）

```json
{
  "plugin_id": "qq",
  "name": "QQ Channel Plugin",
  "version": "0.1.0",
  "api_version": 1,
  "entry": {
    "linux-amd64": "bin/linux-amd64/plugin",
    "windows-amd64": "bin/windows-amd64/plugin.exe"
  },
  "capabilities": {
    "webhook": true,
    "outbound": true,
    "long_connection": false
  },
  "permissions": {
    "network": ["api.sgroup.qq.com", "bots.qq.com"],
    "filesystem": "none",
    "command": false
  }
}
```

### 5.3 JSON-RPC 方法

主进程 -> 插件：

- `plugin.handshake`
- `plugin.health`
- `channel.validate_account_config`
- `channel.parse_inbound`
- `channel.send_outbound`
- `plugin.shutdown`

插件 -> 主进程（预留第二阶段）：

- `channel.push_inbound`（长连接/主动推送）

### 5.4 请求响应约束

- `parse_inbound` 返回：
  - `messages: ChannelMessage[]`
  - `immediate_response`（可选，支持 challenge 场景）
- `send_outbound` 返回：
  - `provider_message_id`（可选）
  - `raw_result`（可选）
- 超时：
  - `parse_inbound`: 2s（可配置）
  - `send_outbound`: 10s（可配置）

---

## 6. 后端改造点（按模块）

### 6.1 渠道 Provider 抽象层

新增：`src/channels/providers/`

- `trait ChannelProvider`
  - `id()`
  - `parse_inbound(...)`
  - `send_outbound(...)`
  - `health()`
- `BuiltinProviderAdapter`：封装现有 feishu/wechat/wechat_mp/qqbot/whatsapp 逻辑。
- `PluginProviderAdapter`：封装插件 RPC 调用。
- `ProviderRegistry`：统一注册/查找 provider。

### 6.2 ChannelHub 改造

`src/channels/service.rs`

- 出站分发 `deliver_outbox_record` 从 `if/else` 改为：
  - `provider_registry.get(channel).send_outbound(...)`
- 飞书长连接保留为内置 provider 特殊实现（阶段 1 不迁移）。

### 6.3 统一 webhook 转发

`src/api/channel.rs`

- 保留现有专用路由（兼容）。
- 对 `/wunder/channel/{provider}/webhook` 增强：
  - 若 provider 有插件，调用 `parse_inbound`。
  - 若 provider 为内置，走原逻辑。

### 6.4 配置模型去硬编码

`src/channels/types.rs`

- `ChannelAccountConfig` 新增通用字段：
  - `provider_config: Option<Value>`（插件专属配置容器）
- 渠道专属结构体逐步收敛到内置 provider 内部，不再作为平台公共结构扩展点。

### 6.5 管理端 API

`src/api/admin.rs` 新增：

- `GET /wunder/admin/channel_plugins`
- `POST /wunder/admin/channel_plugins/upload`
- `POST /wunder/admin/channel_plugins/{plugin_id}/enable`
- `POST /wunder/admin/channel_plugins/{plugin_id}/disable`
- `DELETE /wunder/admin/channel_plugins/{plugin_id}/{version}`
- `GET /wunder/admin/channel_plugins/{plugin_id}/runtime`

并沿用现有 admin 鉴权中间件（`/wunder/admin/*`）。

---

## 7. 存储层改造

在 Postgres/SQLite 同步新增（测试仍兼容 sqlite）：

1. `channel_plugins`
   - `plugin_id` (PK)
   - `name`
   - `current_version`
   - `status` (`enabled|disabled|error`)
   - `manifest` (json/text)
   - `install_path`
   - `last_error`
   - `created_at/updated_at`

2. `channel_plugin_versions`
   - `plugin_id`
   - `version`
   - `package_sha256`
   - `signature`（可空，阶段 2 强制）
   - `manifest` (json/text)
   - `install_path`
   - `created_at`
   - 复合主键 `(plugin_id, version)`

说明：
- `channel_accounts` 继续复用，`channel` 直接使用 `plugin_id`。
- 现有 `channel_bindings/channel_sessions/channel_outbox` 无需改表结构即可复用。

---

## 8. 管理端前端（渠道监控）改造

### 8.1 web 管理端

改造文件：

- `web/index.html`
- `web/modules/channels.js`
- `web/modules/elements.js`
- `web/modules/i18n.js`

新增能力：

1. 插件列表区
   - 插件名、版本、状态、最近错误、健康状态。
2. 安装区
   - 上传 zip（复用 skills upload 的文件校验风格）。
3. 生命周期操作
   - 启用/停用/卸载/切换版本。
4. 账号配置联动
   - 新建渠道账号时 provider 下拉来自插件列表（动态）。

### 8.2 用户侧前端（第二优先级）

- `src/api/user_channels.rs` 支持动态返回可用 provider。
- `frontend/src/components/channels/UserChannelSettingsPanel.vue` 移除静态 `FALLBACK_CHANNELS` 强依赖，改为服务端驱动。

---

## 9. 安全与稳定性要求

1. 安装安全
- 插件包仅允许 zip；路径穿越校验（复用现有 skills upload 处理方式）。
- 校验 `sha256`；阶段 2 引入签名校验（公钥信任链）。

2. 运行隔离
- 插件独立进程，崩溃不影响主进程。
- 插件进程工作目录固定到 `data/channel_plugins/...`。
- 环境变量白名单注入，默认不继承敏感环境变量。

3. 资源控制
- 单插件并发上限、调用超时、重启退避（指数退避 + 熔断）。
- 单条消息大小限制（例如 512KB）。

4. 审计与可观测性
- 记录插件调用耗时、错误码、重启次数。
- 将 `plugin_id/version/account_id` 写入 monitor 事件与 outbox 结果。

---

## 10. 分阶段落地节点（明确里程碑）

### 节点 N1：Provider 抽象落地（不引入插件）

交付：
- 抽象 `ChannelProvider` 与 `ProviderRegistry`。
- 内置渠道全部封装为 builtin provider。
- `ChannelHub` 出站分发去掉硬编码 `if/else`。

验收：
- 现有 feishu/whatsapp/wechat/wechat_mp/qqbot 回归通过。

### 节点 N2：插件安装与注册

交付：
- 新增 `channel_plugins/channel_plugin_versions` 表。
- 新增 admin 插件安装与生命周期 API。
- 插件包上传、解压、manifest 校验、状态管理。

验收：
- 可在管理端看到已安装插件与版本。

### 节点 N3：插件 RPC Runtime

交付：
- 插件进程管理器（启动/健康检查/重启/关闭）。
- JSON-RPC 通道（stdio）与超时治理。

验收：
- 可通过测试插件完成 handshake + health。

### 节点 N4：Webhook 入站插件化

交付：
- `/wunder/channel/{provider}/webhook` 接入插件 `parse_inbound`。
- 插件返回标准 `ChannelMessage[]` 进入现有 ChannelHub。

验收：
- 无需改主仓代码即可新增一个 webhook 渠道。

### 节点 N5：Outbox 出站插件化

交付：
- `deliver_outbox_record` 统一走 provider send。
- 出站失败与重试保留现有 outbox 语义。

验收：
- 插件渠道支持完整入站->模型->出站闭环。

### 节点 N6：管理端“渠道监控”插件安装界面

交付：
- 管理端新增插件列表、安装、启停、卸载、运行状态展示。
- 账号创建页 provider 下拉联动插件。

验收：
- 管理员可在 UI 完成安装与启用，无需手工改配置。

### 节点 N7：QQ 插件样板

交付：
- `plugins/channel-qq/` 示例工程（独立仓/目录均可）。
- 支持 QQ 入站解析与出站发送。

验收：
- 演示“安装 QQ 插件 -> 创建账号 -> 收发消息”闭环。

### 节点 N8：加固与灰度

交付：
- 签名校验、权限模型、熔断告警、回滚策略。
- 文档与 API 完整更新。

验收：
- 灰度环境稳定运行，具备回滚能力。

---

## 11. 兼容与迁移策略

1. 首版不破坏现有渠道
- 内置渠道继续可用；插件模式按 provider 粒度逐步切换。

2. 渐进迁移
- 先让新渠道（如 QQ 新实现）走插件。
- 稳定后再将旧内置渠道逐个迁移为“内置插件”或外部插件。

3. 回滚
- 任何插件可按 provider 一键切回 builtin provider。
- `channel_accounts` 与 `channel_bindings` 不变，回滚成本低。

---

## 12. 验收标准（必须满足）

1. 新增渠道无需改 `src/channels/*` 与 `src/api/channel.rs` 主逻辑分支。
2. 管理员可在“渠道监控”完成插件安装、启停、版本切换。
3. 插件异常不影响主服务可用性，且 outbox 重试语义不变。
4. 入站/出站全链路可观测：能定位到 `plugin_id/version/account_id`。
5. 用户侧渠道配置面板可动态识别新 provider（至少显示与基础配置可用）。

---

## 13. 需要同步更新的文档

方案落地后需同步：

- `docs/设计方案.md`
- `docs/API文档.md`
- `docs/系统介绍.md`
- `docs/数据库设计.md`

并补充插件 SDK 示例文档（插件 manifest、RPC 协议、调试方法、发布流程）。

---

## 14. 结论

该方案可以在不破坏现有渠道主链路的前提下，把“渠道扩展能力”从“源码扩展”升级为“插件扩展”。建议按 N1~N8 分阶段推进，优先完成 **N1~N6（平台能力 + 管理端安装）**，再以 QQ 作为首个外部插件完成闭环验证。
