# 用户侧前端加速方案

## 1. 目标与范围

- 目标：在开发模式下（`npm run dev`），将“登录后进入门户页”的体验优化到秒开。
- 固定回归场景：Docker 重启后，使用有效 token 直接访问 `/app/home`，评估首屏与可交互耗时。
- 范围：仅覆盖用户侧前端（`frontend`）与其直接依赖的后端接口链路（`/wunder/auth/*`、`/wunder/agents*`、`/wunder/user_tools/catalog`、`/wunder/channels/*` 等）。
- 非目标：不涉及管理员前端（`web`）界面改版，不改变业务语义。

## 2. 现状问题与瓶颈画像

结合当前代码与构建结果，首屏等待约 3 秒属于“多因素叠加”：

1. 资源加载成本偏高
   - 主 JS/CSS 体积较大，开发模式冷启动解析与执行压力明显。
   - 路由为全量静态引入，未访问页面也进入主包。

2. App 挂载前存在阻塞动作
   - `main.ts` 在 `app.mount` 前等待 `loadRuntimeConfig` 与 `initI18n`，可见内容出现被延后。

3. 首屏请求链路过长且有重复
   - 路由守卫与布局层存在重复 `loadProfile`。
   - 门户页初始化请求数量较多，且 agent 列表请求存在重复。

4. 后端冷路径开销
   - `/wunder/agents` 调用链包含预置智能体校准逻辑。
   - `/wunder/user_tools/catalog` 涉及用户工具上下文构建与共享配置扫描。

5. 可观测性不足
   - 缺少统一的前端首屏关键耗时指标与自动回归基线，优化结果难稳定复现与比较。

## 3. 优化原则

- 首屏优先：先可见、后完善（Progressive Rendering）。
- 主链路最短：首屏只保留必要请求，低优先级数据延后。
- 热路优先：高频路径缓存化、聚合化；低频路径异步化。
- 可回归：每项优化都必须有可量化指标与可重复测试流程。

## 4. 分阶段实施方案

### 阶段 A（P0）：前端首屏“先显示再补全”

预计 1~2 天，可快速将体验从“等待进入”改为“秒开壳层”。

1. 启动去阻塞
   - `app.mount('#app')` 前移，`runtime config/i18n` 改为后台初始化。
   - 对 `config` 与 `i18n` 请求设置超时与兜底（例如 200~300ms 快速回退默认值）。

2. 路由懒加载
   - 用户侧页面改为 `() => import(...)` 动态加载，减少主包体积与解析压力。
   - 聊天页、工作区页、定时任务页等重页面优先拆分。

3. 首屏请求瘦身
   - 门户页仅保留“必须数据”（用户信息 + agents 基础列表）。
   - `catalog/channels/cron/running` 延迟加载：进入对应面板再拉取，或在 `requestIdleCallback` 中补齐。

4. 去重与并发治理
   - 统一 `authStore.loadProfile` 触发点，移除布局层重复触发。
   - 复用 `loadAgents` 结果，消除复制选项二次请求。
   - 首屏请求增加“同键去重”与“短窗口缓存”（如 3~5 秒）。

5. 视觉体验优化
   - 增加门户骨架屏/占位态，确保“秒开有内容”。
   - 将全屏阻塞 loading 改为局部占位，降低白屏感知。

### 阶段 B（P1）：后端接口聚合与冷路径降耗

预计 2~4 天，重点降低 API 往返次数与冷扫描开销。

1. 新增聚合接口
   - 增加 `GET /wunder/portal/bootstrap`，一次返回门户首屏所需基础数据。
   - 前端首屏从多请求收敛为 1~2 请求。

2. 预置智能体校准异步化
   - 将 `ensure_preset_agents` 从高频读取链路中剥离到登录后异步任务或后台定时校准。
   - 对“已校准用户”增加版本标记，避免重复执行。

3. 用户工具目录缓存
   - `user_tools/catalog` 增加 `user_id + config_version` 维度缓存。
   - 共享配置扫描改为增量索引（文件变化驱动刷新），避免每次目录全扫描。

4. 接口级性能保护
   - 对首屏关键接口增加超时、快速失败与降级返回。
   - 增加慢查询与慢接口日志标签，便于持续优化。

### 阶段 C（P2）：量化与自动回归体系

预计 1~2 天，确保优化可持续、可复验。

1. 前端关键点埋点
   - 在 `main.ts`、路由切换、门户数据就绪处统一埋点：`performance.mark/measure`。
   - 输出指标：`shell_visible_ms`、`portal_ready_ms`、`agents_ready_ms`、`bootstrap_api_count`。

2. 接口耗时采样
   - 在 axios interceptor 记录首屏请求耗时（URL、状态码、duration）。
   - 按接口生成 P50/P95，用于识别瓶颈接口。

3. 回归脚本
   - 提供脚本自动执行“已登录态直达 `/app/home`”并连续采样（建议 10~20 次）。
   - 输出 JSON 报告（本次 vs 基线），用于回归与验收。

## 5. 量化验收标准（开发模式）

固定口径：Docker 重启后，已登录态访问 `/app/home`。

- `shell_visible_ms`：P50 <= 300ms，P95 <= 600ms
- `portal_ready_ms`：P50 <= 1200ms，P95 <= 2000ms
- `agents_ready_ms`：P50 <= 900ms，P95 <= 1500ms
- 首屏关键请求数：较当前基线下降 >= 50%
- `/wunder/agents`：P95 降低 >= 30%
- `/wunder/user_tools/catalog`：P95 降低 >= 40%

> 若短期受开发模式冷编译波动影响，至少满足“相对基线持续下降且 P95 收敛”的目标。

## 6. 观测与验证方案

1. 前端观测
   - 在关键节点打 `performance.mark/measure`，聚合后输出到 `window.__WUNDER_PERF__`。
   - 首屏结束时记录统一快照，避免多次刷新口径不一致。

2. 后端观测
   - 为关键接口增加耗时日志（user_id、status、duration、cache_hit）。
   - 对 `catalog` 与 `agents` 增加分段耗时（认证、校准、存储查询、响应组装）。

3. 回归流程
   - 固定流程：重启 docker -> 确认可访问 -> 已登录态访问 `/app/home` -> 连续采样。
   - 输出 P50/P95 与接口明细，和历史基线做自动对比。

## 7. 风险与回滚

- 风险 1：异步初始化导致语言/配置短暂回退默认值
  - 处理：保留本地缓存快照，异步完成后无闪烁更新。

- 风险 2：接口聚合导致响应体变大
  - 处理：拆分“首屏必要字段”与“扩展字段”，默认仅返回必要集。

- 风险 3：缓存导致数据陈旧
  - 处理：短 TTL + 配置版本号失效 + 手动刷新通道。

- 回滚策略：所有优化开关化（前端 `runtime flag` + 后端配置开关），异常时秒级回退旧链路。

## 8. 建议实施顺序

1. 先落地阶段 C 的基础埋点（先量化，再优化）。
2. 再落地阶段 A（快速改善用户体感）。
3. 最后推进阶段 B（长期稳定降耗）。

---

该方案面向开发模式下的绝对性能提升，核心目标是把“登录后门户页进入耗时”稳定压缩到秒级，并具备持续回归能力。
