# 智能体蜂群 R0-R8 代码级改造清单（蜂巢分组版）

## 0. 文档说明
- 本文为 `docs/方案/智能体蜂群落地方案.md` 的代码执行清单。
- 本版核心变更：蜂群范围不再按容器划分，改为按 `hive_id`（蜂巢）划分。
- 用户可在前端创建蜂巢，并将智能体归入蜂巢后参与蜂群协作。

---

## 1. 全局改造约束

### 1.1 领域边界
- 蜂群作用域唯一键：`hive_id`。
- 蜂群读写必须使用 `(user_id, hive_id)` 双条件过滤。
- `sandbox_container_id` 仅作为沙盒执行属性，不再参与蜂群权限判断。

### 1.2 兼容与灰度
- 保留现有工具名与动作：`agent_swarm` + `list/status/send/history/spawn`。
- 新架构通过 `agent_swarm.runner = legacy | team_runner` 切换。
- 旧路径至少保留一个发布周期，确保回滚安全。

### 1.3 代码组织
- 蜂群核心逻辑必须从 `src/services/tools.rs` 下沉至 `src/services/swarm/*`。
- API 层只负责鉴权、参数校验、错误映射。
- 用户前端功能放在 `frontend/`；管理端功能放在 `web/`。

---

## 2. 文件级改造总览

## 2.1 后端（Rust）

### 新增文件（建议）
- `src/services/swarm/mod.rs`
- `src/services/swarm/types.rs`
- `src/services/swarm/errors.rs`
- `src/services/swarm/scope.rs`
- `src/services/swarm/policy.rs`
- `src/services/swarm/runner.rs`
- `src/services/swarm/merger.rs`
- `src/services/swarm/events.rs`
- `src/services/swarm/repo.rs`
- `src/services/swarm/service.rs`
- `src/services/swarm/bridge.rs`
- `src/api/hives.rs`（用户侧蜂巢管理 API）
- `src/api/team_runs.rs`（用户侧蜂群运行 API）
- `src/api/admin_swarm.rs`（管理侧蜂群 API，建议）

### 重点修改文件
- `src/services/mod.rs`
- `src/services/tools.rs`
- `src/core/config.rs`
- `src/core/state.rs`
- `src/api/mod.rs`
- `src/api/chat.rs`
- `src/api/errors.rs`
- `src/orchestrator/event_stream.rs`
- `src/storage/mod.rs`
- `src/storage/postgres.rs`
- `src/storage/sqlite.rs`
- `src/api/user_agents.rs`
- `config/wunder.yaml`
- `config/wunder-example.yaml`

## 2.2 用户侧前端（frontend）

### 新增文件（建议）
- `frontend/src/stores/beehive.js`
- `frontend/src/views/BeehiveView.vue`
- `frontend/src/components/beehive/BeehiveSummaryBar.vue`
- `frontend/src/components/beehive/BeehiveHexCard.vue`
- `frontend/src/components/beehive/HiveSwitcher.vue`
- `frontend/src/components/beehive/HiveCreateDialog.vue`
- `frontend/src/components/beehive/HiveAgentMoveDialog.vue`
- `frontend/src/components/beehive/SwarmTimeline.vue`
- `frontend/src/components/beehive/SwarmTaskLane.vue`
- `frontend/src/components/chat/SwarmPanel.vue`
- `frontend/src/api/hives.js`
- `frontend/src/api/swarm.js`
- `frontend/src/styles/pages/beehive.css`

### 重点修改文件
- `frontend/src/views/PortalView.vue`（迁移为蜂巢页或壳组件）
- `frontend/src/router/index.js`
- `frontend/src/stores/chat.js`
- `frontend/src/styles/pages/portal.css`
- `frontend/src/styles/pages/agents.css`
- `frontend/src/components/user/UserTopbar.vue`
- `frontend/src/i18n/messages/zh-CN.js`
- `frontend/src/i18n/messages/en-US.js`

## 2.3 管理端（web）

### 新增文件（建议）
- `web/modules/swarm-runs.js`
- `web/modules/swarm-hives.js`
- `web/styles/swarm.css`

### 重点修改文件
- `web/app.js`
- `web/modules/api.js`
- `web/modules/i18n.js`
- `web/styles/app.admin.css`

---

## 3. R0-R8 代码级改造清单

## R0：基线冻结

### 目标
- 冻结蜂巢模型、错误码、配置项、接口契约。

### 后端清单
- [ ] `src/core/config.rs` 新增 `AgentSwarmConfig` 字段：
  - `runner`（`legacy|team_runner`）
  - `max_active_team_runs`
  - `max_parallel_tasks_per_team`
  - `default_timeout_s`
  - `max_retry`
  - `max_depth`
- [ ] 在 `ToolsConfig` 中挂载 `swarm` 配置，补默认值与反序列化兼容。
- [ ] 更新 `config/wunder.yaml` 与 `config/wunder-example.yaml`。
- [ ] 在 `src/api/errors.rs` 增加错误码：
  - `SWARM_HIVE_UNRESOLVED`
  - `SWARM_HIVE_DENIED`
  - `SWARM_POLICY_BLOCKED`
  - `SWARM_RUN_TIMEOUT`

### 文档清单
- [ ] 更新 `docs/API文档.md`：补 `hives` 与 `team_runs` 新接口。
- [ ] 更新 `docs/设计方案.md`：补蜂巢分层架构与时序。
- [ ] 更新 `docs/系统介绍.md`：补“创建蜂巢 -> 管理智能体 -> 运行蜂群”流程。

### 验收
- [ ] `cargo check`
- [ ] 管理端能读取 `tools.swarm` 配置。

---

## R1：后端域模块骨架

### 目标
- 形成蜂群域服务，工具层只做 adapter。

### 后端清单
- [ ] 新建 `src/services/swarm/mod.rs`，导出 `SwarmService`。
- [ ] 新建 `types.rs`：
  - `SwarmAction`
  - `TeamRunStatus` / `TeamTaskStatus`
  - `SwarmHiveScope`（`user_id`, `hive_id`, `current_agent_id`）
- [ ] 新建 `scope.rs`：`SwarmHiveResolver`，从当前 agent/session 解析 `hive_id`。
- [ ] 新建 `policy.rs`：深度限制、重试限制、同蜂巢约束。
- [ ] 在 `src/services/mod.rs` 增加 `pub mod swarm;`。
- [ ] 在 `src/core/state.rs` 注入 `swarm_service: Arc<SwarmService>`。
- [ ] `src/services/tools.rs` 中 `agent_swarm*` 重定向到 `swarm_service`。

### 验收
- [ ] `agent_swarm` 五动作全部通过新服务层。
- [ ] `tools.rs` 仅保留参数转换与调用封装。

---

## R2：存储层改造（Hive + TeamRun）

### 目标
- 持久化蜂巢实体与蜂群运行实体。

### 后端清单
- [ ] `src/storage/mod.rs` 新增记录结构：
  - `HiveRecord`
  - `TeamRunRecord`
  - `TeamTaskRecord`
  - 查询参数对象
- [ ] `src/storage/postgres.rs` 增加表与 CRUD：
  - `hives`
  - `team_runs`
  - `team_tasks`
  - `user_agents.hive_id` 列迁移
- [ ] `src/storage/sqlite.rs` 同步实现。
- [ ] `src/api/user_agents.rs`：创建/更新智能体时支持 `hive_id`。
- [ ] 迁移逻辑：历史智能体归属默认蜂巢。
- [ ] 在 retention 清理中加入 `team_runs/team_tasks`。

### 验收
- [ ] 用户可创建蜂巢并把智能体归属到蜂巢。
- [ ] TeamRun/TaskRun 可按 `hive_id` 完整读写。

---

## R3：编排器与汇聚策略

### 目标
- 实现可并发、可重试、可取消的 Team Runner。

### 后端清单
- [ ] `runner.rs` 状态机：
  - `queued -> running -> merging -> success|failed|cancelled|timeout`
- [ ] `runner.rs` 首发支持：`parallel_all`、`review_gate`。
- [ ] `merger.rs` 支持：`first_success`、`best_confidence`、`consensus`。
- [ ] `bridge.rs` 复用旧能力：会话拉起、消息发送。
- [ ] `policy.rs` 增加按蜂巢分桶并发：
  - `team_queue:{hive_id}`
- [ ] runner 写审计字段（触发人、hive、策略、目标、取消动作）。

### 验收
- [ ] 单个 TeamRun 可并发调度多智能体并完成汇聚。
- [ ] 超时、重试、取消路径可预测。

---

## R4：API 与管理查询

### 目标
- 提供完整的蜂巢与蜂群运行对外接口。

### 后端清单
- [ ] 新建 `src/api/hives.rs` 路由：
  - `POST /wunder/hives`
  - `GET /wunder/hives`
  - `PATCH /wunder/hives/{hive_id}`
  - `POST /wunder/hives/{hive_id}/agents`
- [ ] 新建 `src/api/team_runs.rs` 路由：
  - `POST /wunder/chat/team_runs`
  - `GET /wunder/chat/team_runs/{team_run_id}`
  - `POST /wunder/chat/team_runs/{team_run_id}/cancel`
  - `GET /wunder/chat/sessions/{session_id}/team_runs`
- [ ] `src/api/mod.rs` 合并 `hives` 与 `team_runs` 路由。
- [ ] 管理侧 `src/api/admin_swarm.rs`（建议拆分）：
  - `GET /wunder/admin/team_runs`
  - `GET /wunder/admin/team_runs/{team_run_id}`
  - `GET /wunder/admin/hives/{hive_id}/team_runs`
- [ ] 所有 handler 统一调用 `SwarmService`。

### 前端/管理端 API 封装
- [ ] `frontend/src/api/hives.js`
- [ ] `frontend/src/api/swarm.js`
- [ ] `web/modules/api.js` 增加 hive/team-run 相关请求函数。

### 验收
- [ ] 用户可创建蜂巢并查看蜂巢下运行记录。
- [ ] 管理端可按 `hive_id` 筛选运行数据。

---

## R5：事件流与回放

### 目标
- team 事件可实时消费且可回放。

### 后端清单
- [ ] `src/services/swarm/events.rs` 定义事件常量：
  - `team_start`
  - `team_task_dispatch`
  - `team_task_update`
  - `team_task_result`
  - `team_merge`
  - `team_finish`
  - `team_error`
- [ ] `src/orchestrator/event_stream.rs`：将 team 事件加入持久化白名单。
- [ ] `src/api/chat.rs`：在 `is_workflow_event` 中加入 team 事件。
- [ ] team 事件 payload 全量带 `hive_id`。

### 前端清单
- [ ] `frontend/src/stores/chat.js`：识别 team 事件。
- [ ] `frontend/src/stores/beehive.js`：按 `hive_id` 聚合运行态。

### 验收
- [ ] `/wunder/chat/sessions/{id}/resume` 能恢复完整 team 轨迹。
- [ ] 当前蜂巢以外事件不会进入展示层。

---

## R6：用户侧蜂巢改造

### 目标
- 完成“世界 -> 蜂巢”改造与“创建蜂巢”主流程。

### 前端清单
- [ ] 路由改造：新增 `BeehiveView.vue`，保留旧路径兼容跳转。
- [ ] 新增 `HiveSwitcher.vue`：
  - 当前蜂巢展示
  - 蜂巢列表切换
  - 入口按钮“创建蜂巢”
- [ ] 新增 `HiveCreateDialog.vue`：
  - 表单校验（名称必填）
  - 调用 `POST /wunder/hives`
  - 创建成功后自动切换蜂巢
- [ ] 新增 `HiveAgentMoveDialog.vue`：
  - 支持把选中智能体迁移到目标蜂巢
- [ ] 新增 `BeehiveSummaryBar.vue`：展示当前蜂巢指标。
- [ ] 新增 `BeehiveHexCard.vue`：六边形卡片展示智能体。
- [ ] 新增 `SwarmPanel.vue`：聊天页蜂群轨迹面板。
- [ ] `i18n` 全量替换世界页文案为蜂巢语义。

### 样式清单
- [ ] `frontend/src/styles/pages/beehive.css`。
- [ ] 不使用 `backdrop-filter`。
- [ ] 深浅主题 + 低性能设备模式兼容。

### 验收
- [ ] 用户可在前端点击创建蜂巢并成功切换。
- [ ] 当前蜂巢统计、智能体列表、运行态展示正确。

---

## R7：治理与性能加固

### 目标
- 防止蜂群失控并提升可观测性。

### 后端清单
- [ ] `policy.rs` 补全限制：
  - `max_depth`
  - `max_parallel_tasks_per_team`
  - `max_active_team_runs`
  - `max_retry`
  - `default_timeout_s`
- [ ] 分桶调度公平性优化：避免单蜂巢霸占资源。
- [ ] `monitor/throughput` 增加蜂群指标：
  - team run 吞吐
  - P95 延迟
  - timeout rate
  - hive denied rate
- [ ] 审计日志补充 hive 维度字段。

### 管理端清单
- [ ] `web/modules/swarm-runs.js`：运行列表与异常分布。
- [ ] `web/modules/swarm-hives.js`：蜂巢维度聚合视图。
- [ ] `web/styles/swarm.css`：管理端可视化样式。

### 验收
- [ ] 压测下无队列失控。
- [ ] 异常可定位到具体 hive 与策略。

---

## R8：测试、灰度、回滚

### 目标
- 平滑切换到 `team_runner` 并确保可回退。

### 测试清单（Rust）
- [ ] `src/services/swarm/*` 单元测试：
  - hive 解析
  - policy 拦截
  - runner 状态迁移
  - merge 策略
- [ ] `tests/` 新增集成测试：
  - `swarm_hive_create_flow.rs`
  - `swarm_hive_isolation.rs`
  - `swarm_team_run_lifecycle.rs`
  - `swarm_resume_replay.rs`

### 测试清单（前端）
- [ ] `npm --prefix frontend run build` 必过。
- [ ] 创建蜂巢/切换蜂巢/迁移智能体的端到端冒烟脚本（可放 `scripts/`）。

### 灰度与回滚
- [ ] 默认 `legacy`，按用户或蜂巢白名单切 `team_runner`。
- [ ] 达标后逐步全量。
- [ ] 回滚一键切回 `legacy`，新表保留只读。

### 验收
- [ ] `cargo check`
- [ ] `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] `cargo test`
- [ ] `npm --prefix frontend run build`

---

## 4. 跨节点依赖关系
- R2 依赖 R1（先有域对象与 repo 接口）。
- R3 依赖 R2（runner 依赖 team/hive 持久化）。
- R4 与 R5 可并行推进。
- R6 依赖 R4+R5（没有 API 与事件无法完成蜂巢交互）。
- R7 在 R3 稳定后实施。
- R8 最后执行，必须包含灰度与回滚演练。

---

## 5. 建议交付节奏
- 阶段 I（第 1-2 周）：R0-R2
- 阶段 II（第 3-4 周）：R3-R5
- 阶段 III（第 5-6 周）：R6-R7
- 阶段 IV（第 7 周）：R8 + 发布复盘

---

## 6. 每阶段完成后必须同步文档
- `docs/功能迭代.md`（使用脚本更新）
- `docs/API文档.md`（接口与错误码）
- `docs/设计方案.md`（模块图与时序）
- `docs/系统介绍.md`（页面与交互流程）

> 建议：每完成一个 R 节点就同步一次文档与变更日志，避免后置补文档导致遗漏。
