# 智能体蜂群 R0-R8 代码级改造清单（中度重构版）

## 0. 文档说明
- 本文是 `docs/方案/智能体蜂群落地方案.md` 的工程化拆解文档，聚焦“可直接执行的代码改造项”。
- 范围覆盖 R0-R8 全节点，按后端（Rust）、用户侧前端（Vue3）、管理端（web）分别列项。
- 目标是“中度重构”：不推翻现有架构，完成关键解耦、容器隔离、可视化和治理闭环。

---

## 1. 全局改造约束（先统一再开工）

### 1.1 领域边界约束
- 蜂群作用域唯一键：`scope_container_id`，与 `sandbox_container_id` 对齐。
- 作用域类型统一为 `i32`（Rust）/ `INTEGER`（DB），避免字符串比较与转换损耗。
- 所有蜂群读取与写入都必须使用 `(user_id, scope_container_id)` 双条件过滤。

### 1.2 兼容约束
- 保留现有工具名与动作：`agent_swarm` + `list/status/send/history/spawn`。
- 新架构通过 `agent_swarm.runner = legacy | team_runner` 灰度切换。
- 旧路径不删，至少保留一个版本周期用于回滚。

### 1.3 代码组织约束
- 蜂群核心逻辑不得继续堆积在 `src/services/tools.rs`。
- API 层只做参数校验/错误映射，不承载编排逻辑。
- 管理端展示在 `web/` 下实现，用户侧展示在 `frontend/` 下实现。

### 1.4 事件与统计约束
- Team 事件必须进入 `stream_events` 可持久化白名单。
- token 统计口径只记录上下文占用量（`context_tokens`），不混入总消耗。
- 同一会话的轮次统计保持“用户轮次/模型轮次”既有定义不变。

---

## 2. 文件级改造总览（新增 + 修改）

## 2.1 后端（Rust）

### 新增文件（建议）
- `src/services/swarm/mod.rs`
- `src/services/swarm/types.rs`
- `src/services/swarm/errors.rs`
- `src/services/swarm/scope.rs`
- `src/services/swarm/policy.rs`
- `src/services/swarm/runner.rs`
- `src/services/swarm/merger.rs`
- `src/services/swarm/events.rs`
- `src/services/swarm/repo.rs`
- `src/services/swarm/service.rs`
- `src/services/swarm/bridge.rs`（复用旧 `send/spawn` 能力的桥接层）
- `src/api/team_runs.rs`（用户侧 team run API）
- `src/api/admin_swarm.rs`（管理侧蜂群 API，建议从 `admin.rs` 拆分）

### 重点修改文件
- `src/services/mod.rs`
- `src/services/tools.rs`
- `src/core/config.rs`
- `src/core/state.rs`
- `src/api/mod.rs`
- `src/api/chat.rs`
- `src/api/errors.rs`
- `src/orchestrator/event_stream.rs`
- `src/storage/mod.rs`
- `src/storage/postgres.rs`
- `src/storage/sqlite.rs`
- `config/wunder.yaml`
- `config/wunder-example.yaml`

## 2.2 用户侧前端（frontend）

### 新增文件（建议）
- `frontend/src/stores/beehive.js`
- `frontend/src/views/BeehiveView.vue`（或将 PortalView 重命名并保留兼容路由）
- `frontend/src/components/beehive/BeehiveSummaryBar.vue`
- `frontend/src/components/beehive/BeehiveHexCard.vue`
- `frontend/src/components/beehive/SwarmTimeline.vue`
- `frontend/src/components/beehive/SwarmTaskLane.vue`
- `frontend/src/components/chat/SwarmPanel.vue`
- `frontend/src/api/swarm.js`
- `frontend/src/styles/pages/beehive.css`

### 重点修改文件
- `frontend/src/views/PortalView.vue`（迁移到蜂巢页或壳组件）
- `frontend/src/router/index.js`
- `frontend/src/stores/chat.js`
- `frontend/src/styles/pages/portal.css`
- `frontend/src/styles/pages/agents.css`
- `frontend/src/components/user/UserTopbar.vue`
- `frontend/src/i18n/messages/zh-CN.js`
- `frontend/src/i18n/messages/en-US.js`

## 2.3 管理端（web）

### 新增文件（建议）
- `web/modules/swarm-runs.js`
- `web/modules/swarm-containers.js`
- `web/styles/swarm.css`

### 重点修改文件
- `web/app.js`
- `web/modules/api.js`
- `web/modules/i18n.js`
- `web/styles/app.admin.css`

---

## 3. R0-R8 代码级改造清单

## R0：重构基线冻结

### 目标
- 冻结接口、错误码、配置项、容器边界规则，避免边开发边改协议。

### 后端清单
- [ ] 在 `src/core/config.rs` 新增 `AgentSwarmConfig`：
  - `runner`（`legacy|team_runner`）
  - `max_active_team_runs`
  - `max_parallel_tasks_per_team`
  - `default_timeout_s`
  - `max_retry`
  - `max_depth`
  - `scope_strict`
- [ ] 扩展 `ToolsConfig`：`pub swarm: AgentSwarmConfig`，补齐默认值和反序列化兼容。
- [ ] 更新 `config/wunder.yaml` 与 `config/wunder-example.yaml` 增加 `tools.swarm` 样例。
- [ ] 在 `src/api/errors.rs` 注册新错误码映射：
  - `SWARM_SCOPE_UNRESOLVED`
  - `SWARM_SCOPE_DENIED`
  - `SWARM_POLICY_BLOCKED`
  - `SWARM_RUN_TIMEOUT`

### 文档清单
- [ ] 更新 `docs/API文档.md`（新增 team_runs API 草案）。
- [ ] 更新 `docs/设计方案.md`（增加 swarm 模块分层图）。
- [ ] 更新 `docs/系统介绍.md`（补充“蜂巢页面 + 容器隔离”流程）。

### 验收
- [ ] `cargo check`
- [ ] 配置热加载后 `tools.swarm` 可在管理端读取。

---

## R1：后端域模块骨架

### 目标
- 把蜂群逻辑从工具文件中抽出，形成可复用服务层。

### 后端清单
- [ ] 新建 `src/services/swarm/mod.rs`，导出统一入口 `SwarmService`。
- [ ] 新建 `types.rs`：定义
  - `TeamRunStatus` / `TeamTaskStatus`
  - `SwarmAction`（list/status/send/history/spawn）
  - `SwarmScope`（`user_id`, `scope_container_id`, `current_agent_id`）
- [ ] 新建 `errors.rs`：统一 `SwarmError -> api::errors` 映射。
- [ ] 新建 `scope.rs`：实现 `SwarmScopeResolver`：
  - 从当前 agent 解析 `sandbox_container_id`
  - fallback 到父会话绑定 agent
  - 无法解析返回 `SWARM_SCOPE_UNRESOLVED`
- [ ] 新建 `policy.rs`：实现 `SwarmPolicyGuard`：
  - 深度限制
  - includeCurrent 限制
  - 跨容器拒绝
- [ ] 在 `src/services/mod.rs` 增加 `pub mod swarm;`。
- [ ] 在 `src/core/state.rs` 注入 `swarm_service: Arc<SwarmService>`。
- [ ] `src/services/tools.rs` 中 `agent_swarm*` 改为 Adapter：
  - 参数解析仍在工具层
  - 业务执行转调 `swarm_service.handle_action(...)`

### 验收
- [ ] `agent_swarm list/status/send/history/spawn` 走新服务层。
- [ ] `tools.rs` 内蜂群业务逻辑体量明显下降（仅保留参数适配）。

---

## R2：存储层落地（SwarmRepo + team_*）

### 目标
- 建立蜂群专用持久化模型，摆脱 `session_runs` 语义挤压。

### 后端清单
- [ ] 在 `src/storage/mod.rs` 新增记录类型：
  - `TeamRunRecord`
  - `TeamTaskRecord`
  - `ListTeamRunsQuery`
  - `ListTeamTasksQuery`
- [ ] 在 `src/services/swarm/repo.rs` 定义 `SwarmRepo` trait（建议）并桥接 `StorageBackend`。
- [ ] 在 `src/storage/postgres.rs` 增加表创建与 CRUD：
  - `team_runs`
  - `team_tasks`
  - 关键索引（按 user+container、container+status）
- [ ] 在 `src/storage/sqlite.rs` 同步实现同结构 CRUD。
- [ ] 增加数据库约束：
  - `team_tasks.team_run_id` 外键
  - `team_tasks.scope_container_id == team_runs.scope_container_id`
- [ ] 在 retention 清理中纳入 `team_runs/team_tasks`。

### 数据字段细化（实现口径）
- `scope_container_id`：`INTEGER NOT NULL`（对齐 `sandbox_container_id`）
- 时间字段：沿用 `DOUBLE PRECISION` / `REAL`（与现有时间戳一致）
- token 汇总字段放在 `team_runs`：
  - `context_tokens_total`
  - `context_tokens_peak`
  - `model_round_total`

### 验收
- [ ] Postgres/SQLite 两种后端都可完成 team run 全生命周期读写。
- [ ] 跨容器 task 写入被 DB + 业务层双重拒绝。

---

## R3：编排器与汇聚策略

### 目标
- 形成可并发、可重试、可取消的 Team Runner 状态机。

### 后端清单
- [ ] `runner.rs` 实现状态机：
  - `queued -> running -> merging -> success|failed|cancelled|timeout`
- [ ] `runner.rs` 支持两种首发策略：
  - `parallel_all`
  - `review_gate`
- [ ] `merger.rs` 实现三种 merge policy：
  - `first_success`
  - `best_confidence`
  - `consensus`
- [ ] `bridge.rs` 封装对旧能力调用：
  - 会话拉起（复用 `spawn_session_run`）
  - agent 发送（复用 `agent_swarm_send` 底层能力）
- [ ] `policy.rs` 增加容器分桶并发控制：
  - `team_queue:{scope_container_id}`
  - 单容器并发上限 + 全局上限双闸门
- [ ] runner 写入统一审计字段（触发人、容器、策略、目标、取消动作）。

### 验收
- [ ] 一次 TeamRun 可并发分发多 task 并汇聚结果。
- [ ] 超时、重试、取消三条异常路径行为一致。

---

## R4：API 与管理查询

### 目标
- 提供稳定的用户与管理入口，支持 team run 查询与控制。

### 后端清单
- [ ] 新建 `src/api/team_runs.rs`，新增用户侧路由：
  - `POST /wunder/chat/team_runs`
  - `GET /wunder/chat/team_runs/{team_run_id}`
  - `POST /wunder/chat/team_runs/{team_run_id}/cancel`
  - `GET /wunder/chat/sessions/{session_id}/team_runs`
- [ ] 在 `src/api/mod.rs` 合并 `team_runs::router()`。
- [ ] 管理接口从 `admin.rs` 拆分到 `src/api/admin_swarm.rs`（建议），并在 `admin` 路由合并：
  - `GET /wunder/admin/team_runs`
  - `GET /wunder/admin/team_runs/{team_run_id}`
  - `GET /wunder/admin/containers/{container_id}/team_runs`（可选）
- [ ] 所有 handler 统一用 `SwarmService`，禁止各自拼装查询逻辑。
- [ ] 在 `src/api/errors.rs` 完成错误码到 HTTP 状态映射。

### 前端/管理端 API 清单
- [ ] 新增 `frontend/src/api/swarm.js`：封装 team_runs 请求。
- [ ] 在 `web/modules/api.js` 增加 admin swarm API 封装。

### 验收
- [ ] 用户仅可操作当前容器 team run。
- [ ] 管理端可按容器维度筛选运行数据。

---

## R5：事件流与回放

### 目标
- 让 team run 在 WS/SSE/恢复接口中具备完整可回放轨迹。

### 后端清单
- [ ] 在 `src/services/swarm/events.rs` 定义 team 事件常量：
  - `team_start`
  - `team_task_dispatch`
  - `team_task_update`
  - `team_task_result`
  - `team_merge`
  - `team_finish`
  - `team_error`
- [ ] 在 `src/orchestrator/event_stream.rs` 的 `should_persist_stream_event` 中加入以上事件。
- [ ] 在 `src/api/chat.rs` 的 `is_workflow_event` 中加入以上事件，确保 resume 输出。
- [ ] 所有 team 事件 payload 必带：
  - `team_run_id`
  - `scope_container_id`
  - `task_id`（任务事件）
  - `user_round/model_round`

### 前端清单
- [ ] `frontend/src/stores/chat.js` 补充 team 事件识别与反序列化。
- [ ] `frontend/src/stores/beehive.js` 聚合 team 事件生成运行视图模型。

### 验收
- [ ] 中途断线后通过 `/resume` 可恢复完整 team 轨迹。
- [ ] 不会混入其他容器事件。

---

## R6：用户侧蜂巢改造（含页面重命名）

### 目标
- 完成“世界 -> 蜂巢”改造与蜂群可视化主体验。

### 用户侧前端清单
- [ ] 路由命名与入口改造：
  - 新增 `BeehiveView.vue`
  - 保留旧 `portal/world` 路由别名（兼容收藏链接）
- [ ] i18n 文案更新：
  - `nav.world` -> `nav.beehive`（保留兼容映射）
  - `portal.*` 迁移/复用为 `beehive.*`
- [ ] 顶部汇总栏 `BeehiveSummaryBar.vue`：
  - 活跃智能体数
  - 运行中 TeamRun 数
  - 近 1h 成功率
  - 平均时延与超时数
- [ ] 六边形卡片 `BeehiveHexCard.vue`：
  - 使用 `clip-path: polygon(...)` 或 SVG 方案
  - 不使用 `backdrop-filter`
  - 支持深/浅色主题
- [ ] `SwarmPanel.vue` 接入聊天侧：
  - 任务泳道
  - 拓扑时间线
  - 汇聚结果区
  - 取消与跳转子会话
- [ ] 仅显示同 `scope_container_id` 数据与操作。

### 样式清单
- [ ] 新增 `frontend/src/styles/pages/beehive.css`。
- [ ] 精简 `portal.css`，将蜂巢专属样式迁出。
- [ ] 补齐低性能设备样式降级策略（减少阴影/动画）。

### 验收
- [ ] 用户能在蜂巢页查看当前容器全量运行态。
- [ ] 无跨容器可见数据。

---

## R7：治理与性能加固

### 目标
- 防止蜂群失控，提升并发公平性和运维可观测性。

### 后端清单
- [ ] `policy.rs` 增加防护：
  - `max_depth`
  - `max_parallel_tasks_per_team`
  - `max_active_team_runs`
  - `max_retry`
  - `default_timeout_s`
- [ ] 增加容器级公平调度：
  - 容器配额
  - 饥饿保护（轮转/最久未执行优先）
- [ ] 审计日志增强：
  - 越界拒绝
  - 策略阻断
  - 取消级联
- [ ] 在 `src/ops/throughput.rs` / `src/ops/monitor.rs` 增加蜂群指标输出：
  - team run 吞吐
  - P95 延迟
  - timeout rate
  - scope denied rate

### 管理端（web）清单
- [ ] `web/modules/swarm-runs.js`：运行列表 + 失败原因分布。
- [ ] `web/modules/swarm-containers.js`：容器维度聚合看板。
- [ ] `web/styles/swarm.css`：管理端图表与列表样式。

### 验收
- [ ] 压测下队列无失控增长。
- [ ] 异常可在管理端快速定位到具体容器/策略。

---

## R8：测试、灰度、回滚

### 目标
- 在可观测前提下把 `legacy` 平滑切到 `team_runner`。

### 测试清单（Rust）
- [ ] 在 `src/services/swarm/*` 添加单元测试：
  - scope 解析
  - policy 拦截
  - runner 状态迁移
  - merge 策略
- [ ] 在 `tests/` 新增集成测试：
  - `swarm_scope_isolation.rs`
  - `swarm_team_run_lifecycle.rs`
  - `swarm_resume_replay.rs`
  - `swarm_cancel_cascade.rs`

### 测试清单（前端）
- [ ] 至少保证 `npm --prefix frontend run build` 通过。
- [ ] 新增最小化运行态回放脚本（可放 `tests/` 或 `scripts/`）验证 team 事件渲染顺序。

### 灰度清单
- [ ] 配置开关默认 `legacy`。
- [ ] 按容器白名单切换 `team_runner`。
- [ ] 观测指标达标后逐步全量。

### 回滚清单
- [ ] 一键切回 `legacy`。
- [ ] 保留新表，不做破坏性回滚；仅停止写入并降级读取。
- [ ] 回滚后 `agent_swarm` 五动作功能不下降。

### 验收
- [ ] `cargo check`
- [ ] `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] `cargo test`
- [ ] `npm --prefix frontend run build`

---

## 4. 跨节点依赖关系（执行顺序约束）
- R2 依赖 R1（需要先有域对象与 repo 接口）。
- R3 依赖 R2（runner 需要 team_* 持久化）。
- R4 与 R5 可并行，但 R5 完成前前端只能拿到部分运行态。
- R6 依赖 R4+R5（无 API 与事件无法完成蜂巢体验）。
- R7 应在 R3 基本稳定后进行（避免优化目标频繁变化）。
- R8 最后执行，且必须包含灰度 + 回滚演练。

---

## 5. 建议交付节奏（两周一阶段）
- 阶段 I（第 1-2 周）：R0-R2
- 阶段 II（第 3-4 周）：R3-R5
- 阶段 III（第 5-6 周）：R6-R7
- 阶段 IV（第 7 周）：R8 + 发布复盘

---

## 6. 每阶段完成后必须同步的文档
- `docs/功能迭代.md`（使用脚本更新）
- `docs/API文档.md`（接口与错误码）
- `docs/设计方案.md`（模块图与时序）
- `docs/系统介绍.md`（产品行为与页面说明）

> 建议：每完成一个 R 节点就补一次文档与变更日志，避免最后集中补文档导致遗漏。
