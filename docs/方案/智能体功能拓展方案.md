# 智能体功能拓展方案

## 1. 目标与范围
- 将聊天页“自建工具 / 共享工具”迁移至功能广场的“工具管理”页面，统一配置入口。
- 功能广场成为所有智能体应用入口，首卡为“+ 新建智能体应用”。
- 聊天页新增“调整工具”面板，用于会话级工具覆盖。
- 智能体按用户等级控制可见性；工具不展示等级，后台按用户等级与管理员覆盖过滤可用工具。
- 智能体提示词以“追加模式”叠加到基础系统提示词之上。

## 2. 已落地能力总览
- 工具管理页整合：系统工具目录 + 用户自建工具（MCP/技能/知识库）+ 共享工具选择。
- 功能广场智能体应用卡片：首卡为新建入口，新增后卡片就近展示。
- 聊天页：顶部显示当前智能体信息与“调整工具”入口；会话级工具覆盖实时生效。
- 并发与工作区：会话锁与临时工作区按 `user_id + agent_id` 划分，智能体可并行运行，默认聊天仍按 `user_id`。
- 后端：新增 `user_agents` 与 `user_agent_access`，会话记录新增 `agent_id`/`tool_overrides`。
- 共享工具选择由后端 `user_tools` 持久化，不再依赖本地存储。

## 3. 信息架构与交互流程
### 3.1 工具管理
- “管理员开放工具”：来自 `/wunder/user_tools/catalog` 的内置/系统工具目录，用于选择挂载。
- “用户自建工具”：复用 MCP/技能/知识库管理面板，所有工具同步进入可挂载集合。
- “共享工具选择”：在工具目录中勾选可用的共享工具，保存到后端。

### 3.2 功能广场
- 智能体应用卡片：展示名称/描述/挂载工具数量/更新时间。
- 新建/编辑：选择工具、填写系统提示词、描述、图标（等级自动取用户等级）。
- 创建后卡片就近展示，可直接进入聊天并携带 `agent_id`。

### 3.3 聊天页工具调整
- 每个会话提供“调整工具”入口，展示可用工具并支持会话级覆盖。
- 默认工具集合来自当前智能体的挂载工具；会话覆盖仅作用当前会话。
- 支持“禁用所有工具”（写入 `__no_tools__`）。

## 4. 数据模型与权限策略
### 4.1 数据模型
- `user_agents`：
  - `agent_id / user_id / name / description / system_prompt / tool_names / access_level(自动取用户等级) / status / icon / created_at / updated_at`
- `chat_sessions`：
  - 新增 `agent_id` 与 `tool_overrides`。
- `user_tool_access`：
  - `allowed_tools`（可选白名单）。
- `user_agent_access`：
  - `allowed_agent_ids`（可选白名单）+ `blocked_agent_ids`（强制禁用）。

### 4.2 权限规则
- 等级规则：A >= B >= C，用户只能看到不高于自己等级的智能体；工具按内部类别映射等级过滤，但前端不展示等级。
- 管理员覆盖：
  - 工具：按类别映射等级过滤 + `allowed_tools` 白名单收敛，最后移除。
  - 智能体：先按等级过滤，再按 `allowed_agent_ids`/`blocked_agent_ids` 过滤。
- 工具最终集合 = 可见集合 ∩ 智能体挂载集合 ∩ 会话覆盖集合（若覆盖为空则使用智能体默认）。

## 5. 提示词叠加与缓存
提示词层级顺序：
1) 基础系统提示词（含工具/技能协议块）。
2) 智能体 `system_prompt`。
3) 运行期附加块（如 a2ui、计划/问询面板等）。

缓存 key 已引入：工具集合、用户工具版本、共享工具版本、智能体提示词哈希、工作区版本。

## 6. API 变更摘要
- 智能体管理：
  - `GET/POST /wunder/agents`
  - `GET/PUT/DELETE /wunder/agents/{id}`
  - `GET /wunder/agents/running` 智能体运行状态概览（含默认入口/个人/共享）
- 工具管理：
  - `GET /wunder/user_tools/catalog` 完整目录
  - `POST /wunder/user_tools/shared_tools` 保存共享工具选择
  - `GET /wunder/user_tools/tools` 返回可用工具 + 共享选择
- 会话工具调整：
  - `POST /wunder/chat/sessions/{id}/tools` 更新 `tool_overrides`
- 管理员覆盖：
  - `GET/PUT /wunder/admin/user_accounts/{user_id}/tool_access`
  - `GET/PUT /wunder/admin/user_accounts/{user_id}/agent_access`
- 提示词：
  - `/wunder/chat/system-prompt` 支持 `agent_id` + `tool_overrides`
  - 请求体含 `agent_prompt`（内部传递给 orchestrator）
- 工作区：
  - `/wunder/workspace/*` 支持 `agent_id` 以区分智能体工作区

## 7. 落地节点与验收
1) 工具管理迁移
   - 验收：工具配置统一集中入口，聊天页不再出现工具/提示词弹窗。
2) 功能广场智能体应用入口
   - 验收：首卡为新建入口，创建后卡片就近展示并可进入聊天。
3) 会话级工具调整
   - 验收：会话覆盖立即影响工具调用与提示词预览。
4) 等级与覆盖策略
   - 验收：A/B/C 用户可见范围正确，管理员白名单生效。
5) 提示词叠加
   - 验收：基础 + 智能体提示词按顺序追加，缓存可区分不同智能体。
6) 智能体并发与工作区隔离
   - 验收：智能体可同时运行，工作区路径按 `user_id + agent_id` 拆分，默认聊天仍使用 `user_id` 工作区。

## 8. 体验默认策略
- 智能体提示词为“追加”，不覆盖基础系统提示词。
- 会话覆盖默认仅影响当前会话，避免影响其他智能体。
- 共享工具必须显式勾选后才进入可挂载范围。
