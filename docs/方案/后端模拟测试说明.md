# 后端模拟测试说明

## 1. 目的

`backend_sim` 是一个面向后端迭代加速的本地模拟程序，用于：

- 并发压测 `orchestrator.run/stream` 路径
- 快速观察吞吐、延迟、流事件完整性
- 与基线报告对比，发现行为偏移（drift）

程序入口：`src/bin/backend_sim.rs`

---

## 2. 快速使用

### 2.1 运行一次流式模拟

```bash
cargo run --bin backend_sim -- \
  --requests 200 \
  --concurrency 40 \
  --stream true \
  --report temp_dir/backend_sim_report.json
```

### 2.2 写入基线

```bash
cargo run --bin backend_sim -- \
  --requests 200 \
  --concurrency 40 \
  --stream true \
  --baseline temp_dir/backend_sim_baseline.json \
  --write-baseline \
  --report temp_dir/backend_sim_report.json
```

### 2.3 对比基线并在偏移超阈值时失败退出

```bash
cargo run --bin backend_sim -- \
  --requests 200 \
  --concurrency 40 \
  --stream true \
  --baseline temp_dir/backend_sim_baseline.json \
  --fail-on-drift \
  --max-error-rate-drift 0.02 \
  --max-p95-latency-drift-ms 200 \
  --max-final-miss-rate-drift 0.01 \
  --report temp_dir/backend_sim_report.json
```

---

## 3. 常用参数

- `--requests`: 总请求数（默认 120）
- `--concurrency`: 最大并发（默认 24）
- `--stream`: `true/false`，是否走流式路径（默认 `true`）
- `--skip-tool-calls`: 是否跳过工具调用（默认 `true`）
- `--session-mode`: `unique/shared/fixed`
- `--session-id`: `session-mode=fixed` 时必填
- `--question`: 测试问题文本
- `--report`: 报告输出路径（默认 `temp_dir/backend_sim_report.json`）
- `--baseline`: 基线路径

---

## 4. 报告重点字段

- `summary.success_rate / error_rate`
- `latency_ms.p50/p95/p99`
- `first_event_latency_ms.p50/p95/p99`（stream 模式）
- `summary.final_event_missing_rate`
- `summary.monotonic_violation`
- `stop_reasons`
- `answer_digests / event_digests`
- `drift`（开启基线对比时）

---

## 5. 实现细节说明

- 程序会将存储后端强制设为 SQLite：
  - `storage.backend = sqlite`
  - `storage.db_path = temp_dir/backend_sim.sqlite3`
- 为保证可离线运行并减少外部变量影响，程序默认注入 mock LLM 覆盖：
  - `llm.default = __sim_mock__`
  - `llm.models.__sim_mock__.mock_if_unconfigured = true`
- 该程序主要用于“迭代快反馈”，不替代生产真实链路压测。

---

## 6. 建议迭代节奏

1. 先跑一版当前主干，写入 baseline。
2. 每次改动后跑同参数用例，启用 `--fail-on-drift`。
3. 若 drift 失败，优先检查：
   - `p95/p99` 是否显著抬升
   - `final_event_missing_rate` 是否增加
   - `error_kinds` 是否出现新类型
4. 在确认行为不偏移后再继续提并发或扩大请求规模。

---

## 7. TeamRun 蜂群模拟（swarm_sim）

`swarm_sim` 是专门用于蜂群/TeamRun 全流程回归与性能采样的离线程序。

程序入口：`src/bin/swarm_sim.rs`

### 7.1 典型命令

```bash
cargo run --bin swarm_sim -- \
  --runs 20 \
  --tasks-per-run 8 \
  --agent-count 8 \
  --max-active-runs 6 \
  --max-parallel-tasks 4 \
  --task-timeout-s 45 \
  --max-wait-s 300 \
  --poll-ms 200
```

### 7.2 同一智能体并发压力场景

```bash
cargo run --bin swarm_sim -- \
  --runs 20 \
  --tasks-per-run 10 \
  --agent-count 4 \
  --same-agent \
  --max-active-runs 8 \
  --max-parallel-tasks 6
```

### 7.3 输出指标（用于后续优化）

- `run_status / task_status`：成功、失败、超时、取消分布
- `task_elapsed_s`：任务耗时分位（avg/p50/p90/p99/max）
- `queue_wait_s`：队列等待分位（avg/p50/p90/p99/max）
- `task_throughput_per_s`：任务吞吐（task/s）
- `peak_task_concurrency`：运行时峰值并发
- `concurrency_utilization`：并发利用率（sum(task_elapsed)/(wall*peak)）
- `completed_ratio`：已完成任务占比

### 7.4 离线可复现说明

- 程序会在系统临时目录创建独立工作区/SQLite 数据库，不污染在线数据。
- 默认启用 mock LLM（`mock_if_unconfigured = true`），不依赖外部大模型输出。
- 问题输入使用内置模板，便于横向对比不同版本。

---

## 8. 一键三场景工作流（推荐）

为避免手工拼命令，已提供脚本：`scripts/run_backend_sim_workflow.py`。

### 8.1 生成三场景 baseline

```bash
python scripts/run_backend_sim_workflow.py baseline
```

### 8.2 对比三场景 drift（任一场景失败则脚本退出码非 0）

```bash
python scripts/run_backend_sim_workflow.py compare
```

### 8.3 本地快速冒烟（小规模）

```bash
python scripts/run_backend_sim_workflow.py baseline --quick
python scripts/run_backend_sim_workflow.py compare --quick
```

### 8.4 默认三场景定义

- `stream_high_concurrency`：高并发流式 + unique session，关注吞吐与尾延迟。
- `stream_shared_session`：共享 session 冲突场景，关注锁竞争与最终事件完整性。
- `run_non_stream`：非流式控制组，关注 `run` 路径性能与稳定性。

脚本默认将产物写到：`temp_dir/backend_sim/`

- baseline：`temp_dir/backend_sim/baselines/*.json`
- report：`temp_dir/backend_sim/reports/*.json`
- 汇总：`temp_dir/backend_sim/summary.*.json`

> 说明：`stream_shared_session` 场景天然存在更高抖动，脚本内对该场景使用了更宽松的 drift 阈值，避免误报。

### 8.5 阈值策略（脚本内置）

`compare` 模式会对每个场景计算有效 p95 阈值：

- `effective_p95_drift_ms = max(static_p95_drift_ms, baseline_p95 * p95_drift_ratio)`

这样可以避免“同一场景绝对延迟很高时，固定 200ms 阈值过于敏感”的误报。

可调参数：

- `--max-error-rate-drift`
- `--max-final-miss-rate-drift`
- `--max-p95-latency-drift-ms`
- `--p95-drift-ratio`

### 8.6 建议

- 日常开发先跑 `--quick`；
- 合并前再跑标准场景；
- 若机器负载波动大（例如后台任务较多），建议先固定机器负载再做标准对比。
