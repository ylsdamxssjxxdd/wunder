# 外部系统嵌入（iframe）接入方案

> 目标：把 **用户侧前端（`frontend/`）** 作为外链嵌入到其他系统页面中，并复用对方的鉴权/用户体系；外部系统只需提供 `key + 账号 + 密码 + 单位(可选)` 即可让用户“免登录进入 wunder”，若 wunder 内不存在该用户则自动创建。

## 1. 现状与约束（基于代码）

- 用户侧前端通过 `localStorage.access_token` 保存 Token，并在每次请求自动加 `Authorization: Bearer <token>`：`frontend/src/stores/auth.ts`、`frontend/src/api/http.ts`。
- 后端用户体系由 `/wunder/auth/*` 提供：注册/登录签发 `wund_...` Token（默认 7 天 TTL），并写入数据库：`src/api/auth.rs`、`src/services/user_store.rs`。
- `/wunder/auth/*` 路由默认不在 `security.api_key` 保护范围内（`src/core/auth.rs`）；因此 **嵌入对接必须单独做密钥校验**，否则会变成公开注册/重置入口。
- iframe 场景下，第三方 Cookie 不可靠（浏览器限制），因此 **不走 Cookie 会话**，仍走 Bearer Token（存 iframe 自己 origin 的 localStorage）。

## 2. 推荐落地：一次性登录码（不把密钥/密码暴露给浏览器）

### 2.1 wunder 侧配置

1) 配置外部嵌入密钥（独立于管理员 `api_key`）：

- 环境变量：`WUNDER_EXTERNAL_AUTH_KEY=<长随机串>`
- 或配置文件：`security.external_auth_key: ${WUNDER_EXTERNAL_AUTH_KEY:-}`

> 未配置时 `/wunder/auth/external/*` 视为禁用。

### 2.2 外部系统后端：签发一次性登录码

外部系统后端在用户已登录的前提下，拿到用户信息后调用：

- `POST /wunder/auth/external/code`
- Body（JSON）：`key`、`username`、`password`、`unit_id`（可选）

说明：
- `username` 会被归一化为 wunder 的 `user_id`（仅允许 `[A-Za-z0-9_-]`）。
- 若用户不存在：自动创建并绑定单位（未传 `unit_id` 则使用默认根单位）。
- 若用户已存在：自动对齐密码；传了 `unit_id` 且不同则更新单位（同时按单位层级默认额度规则做最小化调整）。
- 默认一次性码 TTL=60 秒，且 **单次使用**（一次性码存内存，服务重启会失效）。

### 2.3 外部系统前端：iframe 嵌入

外部系统后端把 `code` 渲染到页面中，iframe 直接指向 wunder 用户前端：

```html
<iframe
  src="https://<wunder-frontend-host>/app/home?wunder_code=<code>"
  style="width: 100%; height: 100%; border: 0;"
></iframe>
```

用户侧前端会在首跳自动：

1) 调 `POST /wunder/auth/external/exchange`（Body: `{ code }`）换取 `access_token`；
2) 写入 `localStorage.access_token`；
3) `history.replaceState` 清理 URL Query 中的敏感参数（避免泄漏到浏览器地址栏/分享链接）。

## 3. 快速落地：直接下发 Token（不推荐，但最省事）

外部系统后端调用：

- `POST /wunder/auth/external/login`（同入参）
- 返回 `data.access_token`

然后 iframe 直接带 token：

```html
<iframe
  src="https://<wunder-frontend-host>/app/home?wunder_token=<access_token>"
  style="width: 100%; height: 100%; border: 0;"
></iframe>
```

前端同样会在首跳写入 localStorage 并清理 Query。

风险提示：
- Token 出现在 URL 中可能被日志、Referer、截图等途径泄露；除非你能保证链路不记录 Query，否则优先用“一次性登录码”方案。

## 4. 单位（unit_id）对接建议

- 外部系统需维护一张映射表：`外部单位 -> wunder.unit_id`。
- wunder 单位树可通过 `GET /wunder/auth/org_units` 获取（`data.items`/`data.tree`）。
- 若外部系统暂时不传 `unit_id`，wunder 会把新用户落到默认根单位（若存在）。

## 5. 部署与安全注意事项

- HTTPS：外部系统与 wunder 前端/后端都应启用 HTTPS，避免 Token/Code 被中间人截获。
- 不要把 `WUNDER_EXTERNAL_AUTH_KEY` 暴露给浏览器：它应只存在于外部系统后端配置中。
- iframe 允许嵌入：
  - 若你在 Nginx/网关层设置了 `X-Frame-Options: DENY` 或 CSP `frame-ancestors`，需要放行外部系统域名。
  - 推荐用 CSP 白名单方式：只允许指定域名嵌入，而不是全放开。
- CORS：
  - 用户侧前端会带 `Authorization` 调用 API；需确保后端 `cors.allow_headers` 包含 `Authorization`，并按需收敛 `cors.allow_origins` 到外部系统前端域名。

## 6. 账号命名与冲突规避（建议）

由于 wunder `username/user_id` 仅支持 `[A-Za-z0-9_-]`，且不同外部系统可能出现同名账号，建议外部系统在调用时做命名空间：

- 推荐：`username = <system_key>_<external_user_id>`
- 例如：`oa_123456`、`erp_u001`

这样可以避免多个系统接入时的用户名冲突，也便于后续做审计与迁移。
