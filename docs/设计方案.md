# wunder 总体方案设计

## 1. 目标与范围

- 建设一个基于 Rust (Axum) 的智能体调度系统，统一对接大模型、MCP 与技能流程。
- 对外暴露 `/wunder` 接口，输入用户 id 和用户问题，支持流式输出中间过程与最终回复。
- 对外提供 A2A 标准接口 `/a2a`，支持 JSON-RPC 调用与 SSE 流式事件，并通过 `/.well-known/agent-card.json` 进行能力发现。
- 支持多用户并发访问，按用户 id + 智能体应用 id 划分持久化工作区（默认无智能体时仍按 user_id），便于持续对话与上下文复用。
- 线程 `user_id` 可为虚拟标识，不要求已注册；注册用户仅用于用户端登录与权限管理。
- 注册用户每日请求额度按单位层级默认额度控制（一级/二级/三级/四级），0 点重置；每次模型调用计入额度，超额拒绝模型请求并提示原因，前后端统一展示剩余额度与消耗情况。
- 配置集中化：大模型 API、MCP 工具与技能流程在一个配置文件中统一管理。
- 运行时环境变量通过 `.env` 集中管理，docker compose 默认读取，用于覆盖常用参数（如 `WUNDER_HOST`/`WUNDER_PORT`/`WUNDER_API_KEY`/`WUNDER_POSTGRES_DSN`/`WUNDER_SANDBOX_ENDPOINT`）。

## 2. 需求分析

### 2.1 功能需求

- 接收 `user_id` 与 `question`，返回流式推送的过程信息与最终答案。
- 内置基础工具链：读文件、写文件、编辑文件、搜索内容、列出文件、替换内容、执行命令、ptc。
- A2A 服务工具：由管理员配置并启用，作为 `a2a@service` 使用，支持 internal/external 区分；internal 表示 Wunder 内部 A2A 并需预置 user_id。
- 通过 LLM + MCP + Skills 组合执行任务，支持工具调用与流程编排。
- 维护用户 + 智能体级工作区与历史记录（user_id + agent_id），支持并发会话与持久化。
- 支持中英文语言切换，前端与接口返回消息/系统提示词随语言切换。
- 用户额度治理：管理员可调整每日额度并查看消耗情况；注册用户按额度限制，虚拟 user_id 不限；用户侧在回复完成后展示额度消耗。
- 用户侧前端新增“功能广场”入口（`/home`），统一展示内部功能与外链页面；默认访问仍进入聊天页。

### 2.2 非功能需求

- 高并发：同一时间支持多用户访问与长连接流式输出。
- 稳定性：支持超时、重试、降级与错误可观测性。
- 安全性：隔离用户工作区、限制工具权限与执行范围。
- 可维护性：模块清晰、配置统一、日志可追踪。
- 启动性能：MCP 服务、监控与调度器采用惰性初始化，降低冷启动时间。

## 3. 总体架构

```text
Web 调试页 / Client
  |
  |  /wunder (SSE/Streaming)
  v
API 层 (Axum)
  |
  v
Prompt Builder
  |
  v
调度引擎 Orchestrator
  |             |               |
  v             v               v
LLM 适配器     MCP 客户端        Skills 引擎
  |             |               |
  +-------------+---------------+
                |
                v
            工具执行层
           /        \
      本机执行     沙盒执行
                    |
           共享沙盒服务

Workspace/Memory/日志
```

### 3.1 Rust 服务落地

- Rust 版 API 已成为默认实现，基于 Axum 直接提供 `/wunder` 与 `/a2a`。
- 提供 `Dockerfile.rust` 与 `docker-compose.rust.x86.yml` / `docker-compose.rust.arm.yml`，用于 x86/arm64 的运行与热重载环境。
- 新增 `wunder-mcp` 服务用于运行 `mcp_server/` 下的 FastMCP 脚本，默认以 streamable-http 暴露 MCP 入口，人员数据库连接通过 `mcp_server/mcp_config.json` 的 `database` 配置。
- MCP 服务支持 `mcp_server/mcp_config.json` 统一管理数据库配置（`MCP_CONFIG_PATH` 可指定路径），数据库配置以配置文件为准。
- 人员数据库 MCP 支持 MySQL/PostgreSQL，多库配置通过 `database.targets`，默认使用 `default_key`，需要切换目标可调整 `default_key` 或部署多个 MCP 实例；单库可用 `database.db_type` 切换类型。
- 知识库 MCP `kb_query` 仍可配置（`mcp_config.json` 的 `knowledge`），但向量知识库检索已改为直连 Weaviate，不再依赖 RAGFlow MCP。
- 向量知识库使用 Weaviate 作为向量数据库，配置位于 `vector_store.weaviate`（url/api_key/timeout_s/batch_size）。
- Python 代理入口已移除，`WUNDER_PY_BACKEND_*` 环境变量当前不再生效。
- 共享沙盒服务由 `wunder-server` 的 `sandbox` 模式提供，通过 `WUNDER_SERVER_MODE=sandbox` + `WUNDER_PORT=9001` 启动独立容器；运行时使用 `WUNDER_SANDBOX_ENDPOINT` 连接，并在常见的 `sandbox`/`127.0.0.1` 地址之间自动回退，减少内网迁移时的 IP 配置问题。
- Rust 版内置工具“执行命令/ptc”在 `sandbox.mode=sandbox` 时调用 `/sandboxes/execute_tool`，并在工具结果中标记 `sandbox=true`；ptc 仍通过容器内 `python3` 执行脚本。

### 3.2 Rust 原型现状说明

- 监控、长期记忆与 A2A 任务存储目前采用进程内存实现，数据库持久化后续补齐。
- MCP 服务与工具发现/调用已落地，Skills/知识库转换接口当前返回轻量结构，执行与索引能力正在迁移中。
- token 统计以“上下文占用量”为准，而非模型总消耗量。

## 4. API 设计

详见 `docs/API文档.md`。

## 5. 核心模块设计

### 5.1 API 层

- Axum 路由聚合，统一入口 `/wunder`。
- 提供 A2A JSON-RPC `/a2a`，并暴露 AgentCard 发现入口。
- 新增 `/wunder/doc2md/convert` 文档转 Markdown 接口（无鉴权），附件解析统一使用 Rust doc2md 模块，不再依赖外部二进制。
- doc2md 支持 doc/docx/pdf/pptx/xlsx/ods/odt/odp/wps/dps/et 与常见文本/代码格式，默认上传上限 200MB。
- 附件解析接口：管理端调试页使用 `/wunder/attachments/convert`（鉴权），用户侧使用 `/wunder/chat/attachments/convert`（Bearer Token），底层复用同一解析链路。
- 用户侧鉴权与会话接口：`/wunder/auth/*` 与 `/wunder/chat/*`；管理员通过 `/wunder/admin/user_accounts/*` 管理账号、重置密码、工具权限与每日额度。
- 新增 `/wunder/temp_dir/*` 临时文件接口（无鉴权），用于上传/下载/列出/清理项目根目录 `temp_dir/`。
- AgentCard 额外补充内置/MCP/知识库工具清单，便于对外展示可调用范围（轻量清单，不包含参数 schema）。
- 启动入口为 `src/main.rs`，通过 `RUST_LOG` 控制日志级别。
- 管理连接生命周期，支持 SSE 推送。
- 统一鉴权与入参校验：管理员接口使用 `security.api_key`，用户端接口使用 `/wunder/auth` 颁发的 Bearer Token。
- 默认管理员账号为 admin/admin，服务启动时自动创建且不可删除，可通过用户管理重置密码。
- 路由按领域拆分为 `src/api` 的 core/admin/workspace/user_tools/a2a 等模块，状态由 `AppState` 统一注入。
- 管理端新增吞吐量压测接口，服务端按并发列表逐档压测，采样总/单预填充与总/单解码速度等指标，使用内置题库随机发送问题，并支持结果保存/导出与历史回放。
- 管理端新增性能测试采样接口，按并发采集系统提示词构建、文件操作、命令执行与日志写入耗时，便于观察系统能力基线。
- 管理端新增能力评估接口，支持启动/取消、运行进度 SSE、历史列表与回溯/删除；评估用例文件固定存放在 `config/evaluation/cases`。

### 5.2 调度引擎 Orchestrator

- 负责输入解析、任务规划、工具选择与执行编排。
- 对接 LLM 进行意图解析与步骤规划。
- 过程信息抽象为“摘要”，避免泄露内部链路细节。
- 全局并发上限由 `server.max_active_sessions` 控制，超过上限的请求进入排队等待。
- 管理端系统设置支持调整 `server.max_active_sessions`、`server.stream_chunk_size`、`security`、`sandbox`、`observability`、`cors` 等，写入覆盖配置并按配置生效。
- 并发与单用户 + 智能体互斥先使用进程内锁实现，后续可接入数据库 `session_locks` 以支持跨进程互斥。
- 会话轮次拆分为“用户轮次/模型轮次”：用户每发送一条消息记 1 轮用户轮次；模型每执行一次动作（模型调用、工具调用或最终回复）记 1 轮模型轮次；一次会话可包含多轮用户轮次，每轮用户轮次可包含多轮模型轮次。
- 模型轮次上限可通过 `llm.models.<name>.max_rounds` 配置，防止执行循环无限增长。
- 每次模型调用前消耗注册用户额度，消耗结果通过 `quota_usage` 事件回传，超额时立即返回 429。
- 工具调用支持 `tool_call`/`function_call` 两种模式，使用 `llm.models.<name>.tool_call_mode` 切换；`function_call` 模式下工具结果通过 role=tool + tool_call_id 回传。
- 模型轮次中的工具调用会把上一轮 assistant 的原始输出（`tool_call` 模式含工具调用标签）与 reasoning 写入下一轮 messages；`function_call` 模式回填 assistant 的 `tool_calls` 与 role=tool/tool_call_id 结果，保持上下文完整。
- SSE 客户端断开时任务继续运行，事件仍写入监控与历史记录。
- SSE 事件队列满时会落库到 `stream_events`，由流式通道回放补齐，避免事件丢失。
- 流式事件会按时间/长度合并 `llm_output_delta` 写入 `stream_events`，断线续传可按 event_id 回放并继续推送后续事件。
- 断线续传回放的 llm_output_delta 会携带 event_id_start/event_id_end 用于合并与去重。
- 上下文占用量通过 `context_usage` 事件回传并持久化到 session_token_usage。
- 最终回复事件补充 `stop_reason`（`model_response/final_tool/a2ui/question_panel/max_rounds/unknown`），便于调试面板定位停止原因。
- 终止会话会主动中断 LLM 调用并尽量中断工具执行（轮询取消标记，约 200ms 级别响应），避免长时间卡住。

### 5.3 工具系统

- 内置工具（EVA 风格）：最终回复、a2ui、计划面板、问询面板、a2a观察/a2a等待、执行命令、ptc、列出文件、搜索内容、读取文件、技能调用、写入文件、替换文本、编辑文件。
- 内置工具支持英文别名（如 read_file、write_file），模型与接口可用英文名调用，内部统一映射为标准中文名。
- a2ui 为 UI 输出工具，显式启用后与“最终回复”互斥，输出 A2UI JSON 消息供前端渲染。
- 计划面板用于记录与更新任务计划，触发 `plan_update` 事件供前端展示看板。
- 问询面板用于输出多条路线供用户选择，触发 `question_panel` 事件，由前端回传用户选择或忽略。
- LSP 能力：配置多语言 LSP 服务后，系统按 user_id + 项目根目录启动 LSP 进程，提供“LSP查询”工具，支持 definition/references/hover/documentSymbol/workspaceSymbol/implementation/callHierarchy，并在文件写入后补充诊断摘要。
- A2A 服务工具由管理员在 A2A 服务管理中配置并缓存 AgentCard，启用后以 `a2a@service` 形式对模型可用；`tool_call` 模式下注入提示词，`function_call` 模式通过 tools 协议传入；internal 类型对应 Wunder 内部 A2A 并需预置 user_id。
- 内置 `a2a观察`/`a2a等待` 提供任务观察与等待能力，可配合 `a2a@service` 实现并行协作流程。
- 内置工具由 `src/services/tools.rs` 统一维护规格与执行入口，确保配置、提示词与执行一致。
- 工具规格与可用性汇总由 Rust 工具清单构建逻辑生成，`tool_call` 模式下 `/wunder/tools` 与提示词注入共享同一策略；`function_call` 模式不注入工具提示词。
- 内置工具执行支持本机与沙盒两种模式，沙盒模式仅用于执行命令与 ptc，可走共享沙盒服务。
- 内置工具启用项可在配置与管理页面调整，仅启用的内置工具会在 `tool_call` 模式下注入系统提示词。
- `/wunder/tools` 提供对开发者可见的内置工具/MCP/知识库/技能清单，请求时通过 `tool_names` 控制可用工具；`tool_call` 模式下影响提示词注入，`function_call` 模式仅影响 tools 协议。
- MCP 工具：基于 rmcp 客户端连接服务端，由管理员在配置中选择性启用后在 `tool_call` 模式下注入系统提示词，调用形式为 server@tool。
- 自托管 MCP 服务：系统内置 `/wunder/mcp`，Rust 版已实现；管理页默认内置该服务，启用后以 `wunder@excute` 执行任务、`wunder@doc2md` 解析文档。
- MCP 管理支持导入 mcpServers 结构体，配置 headers/transport 等连接参数；工具清单仅由管理员在管理页刷新并缓存，系统提示词构建不触发远端发现且在 `tool_call` 模式下仅注入已启用服务。
- MCP 工具清单拉取增加短 TTL 缓存（按 endpoint/headers/auth/allow_tools 区分），减少重复刷新带来的远端压力。
- Skills：管理员启用的技能在两种模式下均注入 SKILL.md 元信息（名称/描述），引导模型先读取再按流程执行。
- 字面知识库工具：每个知识库作为一个独立工具，传入 query/limit 后触发模型检索，返回结构化知识点列表。
- 字面知识库支持启用开关，未启用的知识库不会在 `tool_call` 模式下注入工具清单。
- 向量知识库工具：基于 Weaviate 向量检索，知识条目绑定嵌入模型；上传文件经 doc2md 解析后按字符切片，切片默认待嵌入，管理员可按切片嵌入/删除或整库重建索引，检索返回 chunk 命中。
- 向量知识库同样支持启用开关，且必须指定嵌入模型（`llm.models.*.model_type=embedding`）。
- 自建工具：用户可配置专属 MCP 服务、上传技能包、维护个人知识库文档，工具名称统一加 `user_id@` 前缀（MCP 为 `user_id@server@tool`）。
- 用户知识库同样支持启用开关，禁用的知识库不会生成 `user_id@` 工具。
- 共享工具：共享的是用户自建工具实体，其他用户在系统提示词页可勾选使用。
- 个人知识库目录固定在 `data/user_tools/{user_id}/knowledge/<base>`（字面知识库），向量知识库存储在 `vector_knowledge/users/{user_id}/<base>`。
- 个人知识库上传支持 doc2md 可解析格式，服务端自动转换为 Markdown 保存。

### 5.4 LLM 适配层

- 多模型兼容：统一 `LLMClient` 接口。
- 模型配置新增 `model_type`（llm/embedding），嵌入模型用于向量知识库的 `/v1/embeddings` 调用。
- 支持多套模型配置与默认模型切换，请求可按模型配置名称路由。
- 支持超时、重试、限流与模型降级，失败时采用指数退避重试并输出结构化错误详情。
- 思考类模型会透传 `reasoning_content`，并计入 token 统计与后续请求上下文。
- 流式调用可通过 `stream_include_usage` 尝试返回 usage 统计，用于精确计算占用。
- HTTP 请求复用全局 reqwest 连接池（如 `src/sandbox/mod.rs`/`src/services/mcp.rs`），降低连接建立开销。

### 5.5 Workspace & Memory

- 按 `user_id` + `agent_id` 创建持久化工作区（默认无智能体时仅使用 `user_id`）：
- `workspaces/{user_id}/`：通用聊天工作区（提示词中使用 `/workspaces/{user_id}/` 作为工作目录）
- `workspaces/{user_id}__agent__{agent_id}/`：智能体应用独立工作区
- 若用户 24 小时内无会话，自动清空对应工作区内容。
- `data/wunder.db`：SQLite 持久化（backend=sqlite 时启用）
- PostgreSQL：默认持久化（历史对话、工具日志、产物索引、监控记录、系统日志、会话锁、溢出事件）
- Rust 版已实现 SQLite/PostgreSQL 存储后端（`src/storage/*`），按 `storage.backend` 切换并统一 `StorageBackend` 接口。
- PostgreSQL 连接池支持配置（`storage.postgres.pool_size`），高并发场景可上调。
- 日志/监控表补充时间与工具维度索引（BRIN + 复合索引），长期保留下统计与清理更高效。
- 能力评估启动时清理用户 eval 临时目录，并在 `evaluation_runs` / `evaluation_items` 中预创建 `active` 明细，完成后更新评分结果用于历史回溯。
- `data/config/wunder.override.yaml`：管理端配置持久化覆盖（与基础配置分离）
- `data/historys/`：旧版 JSONL 与监控文件，仅用于迁移
- `data/user_tools/{user_id}/config.json`：用户自建 MCP/技能/知识库配置与共享工具选择
- `data/user_tools/{user_id}/skills/`：用户技能包解压目录
- `data/user_tools/{user_id}/knowledge/`：用户字面知识库根目录（按知识库名称分子目录）
- `vector_knowledge/shared/`：共享向量知识库根目录（管理员侧）
- `vector_knowledge/users/{user_id}/`：用户向量知识库根目录
- `user_agents`：用户智能体配置（agent_id/name/system_prompt/tool_names/access_level/is_shared）
- `user_agent_access`：用户智能体权限覆盖（allowed_agent_ids/blocked_agent_ids）
- `user_tool_access`：用户工具权限覆盖（allowed_tools）
- `chat_sessions`：会话记录附带 `agent_id` 与 `tool_overrides`
- 会话在历史 token 占用达到 `max_context * history_compaction_ratio` 时触发压缩，压缩请求使用独立 system 提示词并将历史消息合并为单条 user 内容（排除当前用户问题），压缩后按 `history_compaction_reset` 重置并在收到模型 usage 后修正累计，摘要携带覆盖时间边界并在每轮模型调用前检查，避免上下文溢出。
- 上下文压缩采用结构化摘要模板，压缩输入会合并产物索引与工具观察信息，压缩后上下文仅保留摘要与当前用户问题。
- 工作区树缓存带版本号与脏标记，文件写入/技能执行后会主动标记并触发刷新。
- 工作区文件接口补充内容读取、搜索、批量移动/复制与分页排序，适配调试面板树形视图。
- 会话级锁控制并发写入冲突。
- 长期记忆：用户可按开关启用，系统提示词末尾追加该用户历史记忆（纯文本段落，以 `[长期记忆]` 标签开头并附带年月日时分前缀）。
- 记忆总结：每次最终回复后触发新请求（禁用工具调用），系统提示词使用 `prompts/memory_summary.txt`，用户消息为线程历史消息的融合内容（包含最终回复），写入数据库 `memory_records`，同会话覆盖且单用户最多 30 条。
- 记忆任务日志：写入数据库 `memory_task_logs`，与记忆记录同会话覆盖并随删除同步清理，用于历史队列长期保留。
- 总结任务按线程完成时间排队单线程执行，降低额外请求压力。

### 5.6 Prompt 与智能体设计

- 提示词模板拆分为系统、工具协议与工程师信息块，统一由 Prompt Builder 组装；`function_call` 模式不注入工具协议与工具清单，但仍保留技能提示词。
- 提示词文件集中在 `prompts/`，`tool_call` 模式按需注入工具清单与环境信息，`function_call` 模式保持简化。
- 提示词模板支持语言版本目录（如 `prompts/en`），请求语言会决定读取版本。
- 系统提示词构建使用短时 LRU 缓存并限制容量，降低重复请求等待且避免内存膨胀。
- 提示词模板文件读取带缓存（按文件更新时间失效），避免频繁磁盘 IO 影响构建速度。
- 系统提示词预览使用轻量上下文构建，跳过工具执行器初始化以降低耗时。
- 智能体提示词作为追加层注入（基础系统提示词 → 智能体 system_prompt → 会话覆盖）。
- 用户技能规格按目录更新时间与启用列表缓存，减少重复扫描 SKILL.md 的成本。
- ToolSpec 序列化结果缓存复用，降低提示词构建时的 JSON 拼装开销。
- 工作区树在刷新/文件操作时缓存并结合版本号/脏标记复用，减少目录遍历开销。
- 产物索引：独立记录文件变更/命令/脚本运行摘要，无摘要时注入上下文，压缩时并入摘要输入以保留关键轨迹。
- 启用技能时追加技能使用协议与 SKILL.md 路径清单，提示模型先使用 读取文件 再执行脚本。
- 启用 a2ui 时在 `tool_call` 模式下追加 A2UI 提示词，避免注入完整 Schema 造成小上下文模型溢出。
- 参考 `参考项目\eva` 的智能体设计方式与工具协议格式。

### 5.7 前端调试页面

- 根路径 `/` 提供管理端调试前端入口（`web/index.html`）；`web/simple-chat` 暂时停用。
- 调试面板用于测试 `/wunder` SSE 与非流式接口，支持模型配置选择、A2UI 渲染与事件回放。
- 页面新增 A2A 服务管理面板，可配置 A2A 服务并缓存 AgentCard，启用后可在 `tool_call` 模式下注入提示词。
- 静态资源默认通过 `/` 对外暴露。
- 调试页面新增“幻灯片”页，嵌入 `/wunder/ppt` 的 PPT（页面拆分为 `docs/ppt/slides/*.js`，由 `slides/manifest.js` 清单驱动，`slides/boot.js` 动态加载）并支持全屏展示，同时提供 `/wunder/ppt-en` 英文版（`docs/ppt-en`），入口位于侧边栏「文档 / 幻灯片」。
- 页面包含 user_id、session_id、question 等输入项与事件日志区。
- 页面新增模型请求日志区，显示每轮模型 API 请求体/摘要（历史回放会裁剪）。
- 请求日志区同步展示知识库检索模型的请求体，便于排查检索流程。
- 页面新增模型输出区域，显示模型原始输出内容。
- 模型输出区域支持 A2UI 渲染，收到 a2ui 事件时直接渲染 UI。
- 页面增加侧边栏，可切换查看系统提示词，侧边栏支持滚动展示；导航按系统/工具/调试/文档分组，父级可展开/收起，收起后悬停父级显示子项。
- 页面新增 MCP 与技能管理面板，支持配置服务与启用技能。
- 页面新增内置工具管理面板，支持勾选内置工具并实时更新启用状态。
- 页面新增能力评估面板，支持维度选择、执行进度与历史记录查看/删除。
- 页面新增性能测试面板，支持并发步增采样、曲线与耗时明细表格展示。
- 性能测试面板支持历史记录查看与还原，便于不同时间结果对比。
- 页面新增知识库管理面板，配置多知识库目录并支持文档维护与索引刷新。
- 字面知识库支持上传多格式文件，服务端自动调用 doc2md 转为 Markdown 后写入知识库目录。
- 系统提示词页新增自建工具/共享工具区域，自建工具通过弹窗配置。
- 技能管理支持上传 zip 压缩包并自动解压到 EVA_SKILLS。
- 技能管理支持删除 EVA_SKILLS 内的技能条目，悬停展示删除按钮。
- 页面新增模型配置面板，支持多套模型配置、侧边栏切换与默认模型选择。
- 调试面板新增模型配置下拉框，可按默认或指定模型发起请求。
- 系统设置页提供语言选择，前端请求会携带 `X-Wunder-Language` 以同步后端语言。
- 页面新增系统监视面板，展示资源占用与活动/历史线程，并支持终止与查看详情。
- 系统监视支持按起止时间筛选图表统计区间，覆盖线程状态占比与工具调用热力图。
- 工具调用线程详情会返回真实工具名，便于前端定位具体调用事件。
- 页面新增线程管理面板，统计用户历史对话与工具调用次数，可查看用户会话并支持删除用户数据。
- 页面新增用户管理面板，用于账号列表、重置密码与工具权限控制。
- 页面新增记忆管理面板，左侧用户列表、右侧运行状态，展示活动/历史队列并支持查看请求详情。
- 调试面板内置临时工作区，支持树形浏览、搜索、多选批量、拖拽移动与在线编辑。
- 调试面板支持上传文件/图片，文件通过 `/wunder/attachments/convert` 走 doc2md 解析链路后附加请求，图片按多模态格式发送。
- MCP 服务配置以结构体导入为主，编辑通过弹窗完成，工具列表在主区域展示。
- 内部状态/线程详情：`/wunder/admin/monitor`、`/wunder/admin/monitor/tool_usage`、`/wunder/admin/monitor/{session_id}`、`/wunder/admin/monitor/{session_id}/cancel`。
- 线程管理：`/wunder/admin/users`、`/wunder/admin/users/{user_id}/sessions`、`/wunder/admin/users/{user_id}`。
- 用户管理：`/wunder/admin/user_accounts`、`/wunder/admin/user_accounts/{user_id}`、`/wunder/admin/user_accounts/{user_id}/password`、`/wunder/admin/user_accounts/{user_id}/tool_access`、`/wunder/admin/user_accounts/{user_id}/agent_access`。
- 单位管理：`/wunder/admin/org_units`、`/wunder/admin/org_units/{unit_id}`。
- 记忆管理：`/wunder/admin/memory/*`。
- 模型配置/系统设置：`/wunder/admin/llm`、`/wunder/admin/llm/context_window`、`/wunder/admin/server`、`/wunder/i18n`。
- 工具/知识库/A2A：`/wunder/admin/tools`、`/wunder/admin/mcp`、`/wunder/admin/mcp/tools`、`/wunder/admin/a2a`、`/wunder/admin/skills`、`/wunder/admin/knowledge/*`。
- 吞吐量/性能/评估：`/wunder/admin/throughput/*`、`/wunder/admin/performance/sample`、`/wunder/admin/evaluation/*`。
- 调试面板接口：`/wunder`、`/wunder/system_prompt`、`/wunder/tools`、`/wunder/attachments/convert`、`/wunder/workspace/*`、`/wunder/user_tools/*`。
- 文档/幻灯片：`/wunder/ppt`、`/wunder/ppt-en`。

### 5.8 用户侧前端（Vue3）

- 用户侧前端位于 `frontend/`，开发端口默认 18001。
- 支持注册/登录/演示登录，统一使用 Bearer Token 访问 `/wunder/auth` 与 `/wunder/chat`/`/wunder/workspace`/`/wunder/user_tools`。
- 工作区与用户工具能力与后端保持一致，UI 复用既有交互设计。
- 附件解析通过 `/wunder/chat/attachments/convert`，支持 doc/docx/pdf/pptx/xlsx/ods/odt/odp/wps/dps/et 与常见文本/代码类型。
- 账号状态/角色/所属单位由管理员在 `/wunder/admin/user_accounts/*` 维护，线程 `user_id` 与注册用户仍保持区分。
- 功能广场作为智能体应用入口，首卡为“新建智能体应用”，新增共享智能体区域展示共享应用，聊天页支持会话级工具调整与智能体入口跳转。

### 5.9 沙盒管理服务

- 共享沙盒服务由第二个 wunder 容器提供，运行 `wunder-server` 的 `sandbox` 模式（`WUNDER_SERVER_MODE=sandbox`），对外暴露 `/sandboxes/execute_tool` 接口供主服务调用。
- 共享沙盒不创建子容器，适合资源紧张场景；执行命令与 ptc 时仍遵循 allow_paths/deny_globs 白名单策略。
- 共享沙盒容器提供可选字体挂载：仓库 `fonts/` 挂载到 `/usr/share/fonts/wunder`，并通过 `config/fonts.conf` + `FONTCONFIG_FILE` 使用可写缓存目录，配合 `config/matplotlibrc` 为 ptc/Matplotlib 等工具提供中文字体。

## 6. 目录结构建议

```text
wunder/
  src/                # Rust 服务入口与模块
    api/              # 路由与接口层
    core/             # 基础配置与通用工具
    services/         # 内置工具/LLM/MCP/工作区等
    ops/              # 监控/性能/评估/压测
    sandbox/          # 沙盒 client/server
    orchestrator/     # 调度引擎
    storage/          # 存储实现
  frontend/           # 用户侧 Vue3 前端
  web/                # 前端调试页面
    index.html
    app.css            # 样式入口（聚合 web/styles/*.css）
    app.js              # 前端入口脚本
    app.config.js       # 前端统一配置
    styles/            # 拆分后的样式文件
    simple-chat/        # 简易聊天测试页（暂时停用）
    modules/            # 拆分后的页面脚本
      elements.js
      state.js
      utils.js
      log.js
      api.js
      tool-detail.js
      workspace.js
      tools.js
      prompt.js
      debug.js
      monitor.js
      mcp.js
      builtin.js
      skills.js
      llm.js
  config/
    wunder.yaml           # 统一配置文件
    i18n.messages.json    # i18n 文案（默认加载路径）
    fonts.conf            # Fontconfig 配置（可写缓存 + 字体目录）
    matplotlibrc          # Matplotlib 默认配置（CJK 字体优先）
  prompts/            # 系统/工具/记忆提示词模板
  workspaces/         # 持久化工作区（用户文件）
  fonts/              # 可选字体目录（挂载到容器 /usr/share/fonts/wunder）
  data/
    user_tools/         # 用户自建工具配置
    wunder.db           # SQLite 历史/监控/系统日志（backend=sqlite）
    historys/           # 旧版历史文件（迁移保留）
  knowledge/          # 字面知识库文件（Markdown）
  mcp_server/         # MCP 服务脚本
    tools/            # MCP 工具包目录
  docs/
    设计方案.md
    API文档.md
    功能迭代.md
    ppt/                # 系统介绍 PPT（入口 index.html）
    ppt-en/             # 系统介绍 PPT 英文版（入口 index.html）
      slides/           # 单页模块（每页一个 js，manifest.js 维护顺序）
  scripts/
    update_feature_log.py # 功能迭代记录写入脚本
  Dockerfile.rust
  docker-compose.rust.x86.yml
  docker-compose.rust.arm.yml
  Cargo.toml
```

- PostgreSQL 数据由 docker compose 默认写入命名卷 `wunder_postgres`，不再使用 `data/postgres`。

## 7. 配置文件规范（基础 + 覆盖）

  基础配置建议路径：`config/wunder.yaml`（可通过 `WUNDER_CONFIG_PATH` 指定）。
  持久化覆盖配置路径：`data/config/wunder.override.yaml`（可通过 `WUNDER_CONFIG_OVERRIDE_PATH` 指定），用于保存管理端修改内容。
  i18n 文案默认读取 `config/i18n.messages.json`（可通过 `WUNDER_I18N_MESSAGES_PATH` 指定）。

```yaml
server:
  host: 0.0.0.0
  port: 8000
  mode: api
  stream_chunk_size: 1024
  max_active_sessions: 30

i18n:
  default_language: zh-CN
  supported_languages:
    - zh-CN
    - en-US
  aliases:
    zh: zh-CN
    zh-cn: zh-CN
    zh-hans: zh-CN
    zh-hans-cn: zh-CN
    en: en-US
    en-us: en-US

llm:
  default: main
  models:
    main:
      enable: true
      provider: openai_compatible
      base_url: https://api.example.com
      api_key: ${WUNDER_LLM_API_KEY}
      model: gpt-4.1
      temperature: 0.7
      timeout_s: 120
      retry: 2
      max_rounds: 10
      max_context: 128000
      max_output: 4096
      support_vision: false
      stream: false
      stream_include_usage: true
      tool_call_mode: tool_call
      history_compaction_ratio: 0.8
      history_compaction_reset: zero
      stop:
        - </tool_call>
      mock_if_unconfigured: true

# provider 预置（OpenAI 兼容）
# - openai_compatible：自定义 OpenAI 兼容端点，需显式填写 base_url
# - openai/openrouter/siliconflow/deepseek/moonshot/qwen/groq/mistral/together/ollama/lmstudio：可省略 base_url，系统会使用内置默认地址

mcp:
  timeout_s: 120
  servers:
    - name: wunder
      display_name: Wunder 智能体
      endpoint: ${WUNDER_MCP_ENDPOINT:-http://127.0.0.1:18000/wunder/mcp}
      transport: streamable-http
      enabled: false
      allow_tools: []
      tool_specs:
        - name: excute
          description: 执行 wunder 智能体任务并返回最终回复
          input_schema:
            type: object
            properties:
              task:
                type: string
                description: 任务描述
            required:
              - task
        - name: doc2md
          description: 解析文档并返回 Markdown 文本
          input_schema:
            type: object
            properties:
              source_url:
                type: string
                description: 文件下载地址（URL，需包含扩展名）
            required:
              - source_url
    - name: WebSearch
      display_name: 阿里云百炼_联网搜索
      endpoint: https://dashscope.aliyuncs.com/api/v1/mcps/WebSearch/sse
      transport: sse
      description: 基于通义实验室检索模型的联网搜索服务
      headers:
        Authorization: Bearer ${DASHSCOPE_API_KEY}
      allow_tools: []
      enabled: true

skills:
  paths:
    - ./skills
    - ./EVA_SKILLS
  enabled: ["skill_a", "skill_b"]

tools:
  builtin:
    enabled:
      - 最终回复
      - 执行命令
      - ptc
      - 列出文件
      - 搜索内容
      - 读取文件
      - 写入文件
      - 替换文本
      - 编辑文件

knowledge:
  bases:
    - name: 公司制度知识库
      description: 公司规章制度与流程说明
      root: ./knowledge/plan
      enabled: true

workspace:
  root: ./workspaces
  max_history_items: 200
  retention_days: 30

storage:
  backend: postgres
  db_path: ./data/wunder.db
  postgres:
    dsn: postgresql://wunder:wunder@postgres:5432/wunder
    connect_timeout_s: 5

security:
  api_key: ylsdamxssjxxdd
  allow_commands: ["*"]
  allow_paths: ["./EVA_SKILLS", "./skills"]
  deny_globs: ["**/.git/**"]
  exec_policy_mode: allow

sandbox:
  mode: local
  endpoint: http://sandbox:9001
  container_root: /workspaces
  network: bridge
  readonly_rootfs: true
  idle_ttl_s: 0
  timeout_s: 120
  resources:
    cpu: 1.0
    memory_mb: 2048
    pids: 256

observability:
  log_level: INFO
  monitor_event_limit: 500
  monitor_payload_max_chars: 0
  monitor_drop_event_types:
    - llm_output_delta
    - tool_output_delta
```

补充说明：
- `workspace.max_history_items` <= 0 表示不限制历史条数。
- `workspace.retention_days` <= 0 表示不做历史清理。
- `observability.monitor_event_limit` <= 0 表示不裁剪监控事件。
- `observability.monitor_payload_max_chars` <= 0 表示不截断监控事件字段。

## 8. 数据持久化与清理策略

- 历史记录：写入数据库（`chat_history` 表，默认 PostgreSQL，可选 SQLite）。
- 工具调用日志：写入数据库（`tool_logs` 表）用于回放与排错。
- 监控记录：写入数据库（`monitor_sessions` 表），重启后仍可查询。
- 系统日志：写入数据库（`system_logs` 表），便于统一检索。
- 流式事件：合并 `llm_output_delta` 并写入 `stream_events`，支持断线续传，按 TTL 自动清理。
- 系统提示词：会话首次构建后写入历史记录并固定，后续工具勾选/工作区变化不再刷新，用于审计与历史还原。
- 长期记忆：写入数据库（`memory_settings`/`memory_records` 表），按用户开关管理与最多 30 条记录。
- 定时清理：`retention_days` > 0 时按天清理过旧记录，<= 0 表示不清理。

## 9. 安全与权限控制

- API/MCP 管理接口使用 `security.api_key` 鉴权，用户侧接口通过 `/wunder/auth` 的 Bearer Token 校验。
- 工作区严格隔离，拒绝跨用户访问。
- 命令执行支持 `allow_commands` 白名单，可设为 `*` 完全放开。
- security.exec_policy_mode（allow/audit/enforce）用于高风险命令审计/拦截。
- 高风险命令在 enforce 模式下需显式审批（tool args 支持 approved/approval_key），审批结果会在会话内短 TTL 缓存。
- 执行命令支持 `workdir` 指定目录（仅工作区内相对路径）。
- 文件工具默认仅允许访问工作区，可通过 `security.allow_paths` 放行 EVA_SKILLS 等白名单目录。
- 输入参数严格校验，限制超长问题与文件写入范围。

## 10. 可靠性与可观测性

- 统一错误码与异常封装，前端易于处理。
- 日志分级：请求日志、工具日志、模型日志。
- 并发控制：同一 user_id + agent_id 互斥 + `server.max_active_sessions` 上限，session_locks TTL 心跳保障跨进程互斥。
- 指标缓存：系统快照/日志占用/工作区占用与工作区树/搜索按 TTL 缓存，日志占用统计数据库日志表，降低频繁 IO。
- 监控事件按配置裁剪/限量，减少长会话占用的内存与存储压力。
- 增加指标：请求量、SSE 连接时长、错误率。
- 内部状态监控补充沙盒状态、近时段调用统计与日志/工作区占用。
- 流式模型调用支持断线自动重连，并通过 `llm_stream_retry` 事件提示重连进度。
- 监控写入采用有界队列 + 批量落库线程，降低高并发下的写入阻塞。
- 调度链路的存储访问以 blocking 线程隔离，避免阻塞 Tokio 运行时。
- SSE 事件队列满时溢出落库，避免慢客户端拖垮主流程。


