# wunder 总体方案设计

## 1. 目标与范围

- 建设一个基于 FastAPI 的智能体调度系统，统一对接大模型、MCP 与技能流程。
- 对外暴露 `/wunder` 接口，输入用户 id 和用户问题，支持流式输出中间过程与最终回复。
- 对外提供 A2A 标准接口 `/a2a`，支持 JSON-RPC 调用与 SSE 流式事件，并通过 `/.well-known/agent-card.json` 进行能力发现。
- 支持多用户并发访问，按用户 id 划分持久化工作区，便于持续对话与上下文复用。
- 配置集中化：大模型 API、MCP 工具与技能流程在一个配置文件中统一管理。

## 2. 需求分析

### 2.1 功能需求

- 接收 `user_id` 与 `question`，返回流式推送的过程信息与最终答案。
- 内置基础工具链：读文件、写文件、编辑文件、搜索内容、列出文件、替换内容、执行命令、ptc。
- A2A 服务工具：由管理员配置并启用，作为 `a2a@service` 使用，支持 internal/external 区分；internal 表示 Wunder 内部 A2A 并需预置 user_id。
- 通过 LLM + MCP + Skills 组合执行任务，支持工具调用与流程编排。
- 维护用户级工作区与历史记录，支持并发会话与持久化。
- 支持中英文语言切换，前端与接口返回消息/系统提示词随语言切换。

### 2.2 非功能需求

- 高并发：同一时间支持多用户访问与长连接流式输出。
- 稳定性：支持超时、重试、降级与错误可观测性。
- 安全性：隔离用户工作区、限制工具权限与执行范围。
- 可维护性：模块清晰、配置统一、日志可追踪。
- 启动性能：MCP 服务、监控与调度器采用惰性初始化，降低冷启动时间。

## 3. 总体架构

```text
Web 调试页 / Client
  |
  |  /wunder (SSE/Streaming)
  v
API 层 (FastAPI)
  |
  v
Prompt Builder
  |
  v
调度引擎 Orchestrator
  |             |               |
  v             v               v
LLM 适配器     MCP 客户端        Skills 引擎
  |             |               |
  +-------------+---------------+
                |
                v
            工具执行层
           /        \
      本机执行     沙盒执行
                    |
           共享沙盒服务

Workspace/Memory/日志
```

## 4. API 设计

详见 `docs/API文档.md`。

## 5. 核心模块设计

### 5.1 API 层

- FastAPI 路由聚合，统一入口 `/wunder`。
- 通过 A2A 适配层提供 JSON-RPC `/a2a`，将 Wunder 会话映射为 Task/StreamResponse，并暴露 AgentCard 发现入口。
- AgentCard 除了技能与能力字段外，额外补充内置/MCP/知识库工具清单，便于对外展示可调用范围（轻量清单，不包含参数 schema）。
- 提供轻量启动入口 `app/asgi.py`，支持秒起并后台预热。
- 管理连接生命周期，支持 SSE 推送。
- 统一鉴权与入参校验（Pydantic），API/MCP 请求通过 `security.api_key` 校验。
- 路由按领域拆分为 core/admin/workspace/user_tools 等模块，业务组装逻辑下沉至 `app/services`，提升复用与可维护性。

### 5.2 调度引擎 Orchestrator

- 负责输入解析、任务规划、工具选择与执行编排。
- 对接 LLM 进行意图解析与步骤规划。
- 过程信息抽象为“摘要”，避免泄露内部链路细节。
- 全局并发上限由 `server.max_active_sessions` 控制，超过上限的请求进入排队等待。
- 并发与单用户互斥使用数据库 `session_locks` 表实现，支持跨进程互斥与 TTL 心跳续租。
- 轮次上限可通过 `llm.models.<name>.max_rounds` 配置，防止执行循环无限增长。
- SSE 客户端断开时任务继续运行，事件仍写入监控与历史记录。
- SSE 事件队列满时会落库到 `stream_events`，由流式通道回放补齐，避免事件丢失。
- 终止会话会主动中断 LLM 调用并尽量中断工具执行，避免长时间卡住。

### 5.3 工具系统

- 内置工具（EVA 风格）：最终回复、a2ui、a2a观察/a2a等待、执行命令、ptc、列出文件、搜索内容、读取文件、写入文件、替换文本、编辑文件。
- 内置工具支持英文别名（如 read_file、write_file），模型与接口可用英文名调用，内部统一映射为标准中文名。
- a2ui 为 UI 输出工具，显式启用后与“最终回复”互斥，输出 A2UI JSON 消息供前端渲染。
- A2A 服务工具由管理员在 A2A 服务管理中配置并缓存 AgentCard，启用后以 `a2a@service` 形式注入提示词；internal 类型对应 Wunder 内部 A2A 并需预置 user_id。
- 内置 `a2a观察`/`a2a等待` 提供任务观察与等待能力，可配合 `a2a@service` 实现并行协作流程。
- 内置工具由 `app/tools/catalog.py` 统一维护规格、执行入口与沙盒策略，确保配置、提示词与执行一致。
- 工具规格与可用性汇总统一由 `app/tools/availability.py` 生成，`/wunder/tools` 与提示词注入共享同一策略。
- 内置工具执行支持本机与沙盒两种模式，沙盒模式仅用于执行命令与 ptc，可走共享沙盒服务。
- 内置工具启用项可在配置与管理页面调整，仅启用的内置工具会注入系统提示词。
- `/wunder/tools` 提供对开发者可见的内置工具/MCP/知识库/技能清单，请求时通过 `tool_names` 控制提示词注入与可用工具。
- MCP 工具：基于 fastmcp Client 连接服务端，由管理员在配置中选择性启用后注入系统提示词，调用形式为 server@tool。
- 自托管 MCP 服务：系统内置 `/wunder/mcp`，默认在管理页可见但未启用，启用后以 `wunder@run` 作为分身调用入口。
- MCP 管理支持导入 mcpServers 结构体，配置 headers/transport 等连接参数；工具清单仅由管理员在管理页刷新并缓存，系统提示词构建不触发远端发现且仅注入已启用服务。
- Skills：管理员启用的技能以 SKILL.md 元信息（名称/描述）注入系统提示词，引导模型先读取再按流程执行。
- 字面知识库工具：每个知识库作为一个独立工具，传入 query/limit 后触发模型检索，返回结构化知识点列表。
- 字面知识库支持启用开关，未启用的知识库不会注入工具清单。
- 自建工具：用户可配置专属 MCP 服务、上传技能包、维护个人知识库文档，工具名称统一加 `user_id@` 前缀（MCP 为 `user_id@server@tool`）。
- 用户知识库同样支持启用开关，禁用的知识库不会生成 `user_id@` 工具。
- 共享工具：共享的是用户自建工具实体，其他用户在系统提示词页可勾选使用。
- 个人知识库目录固定在 `data/user_tools/{user_id}/knowledge/<base>`，由系统生成并限制用户修改路径。
- 个人知识库支持上传多格式文件并自动转换为 Markdown，失败时使用 Python 方案兜底。
- 附加提示词：用户可在系统提示词页追加补充内容，系统提示词构建时自动拼接到末尾。

### 5.4 LLM 适配层

- 多模型兼容：统一 `LLMClient` 接口。
- 支持多套模型配置与默认模型切换，请求可按模型配置名称路由。
- 支持超时、重试、限流与模型降级，失败时采用指数退避重试并输出结构化错误详情。
- 思考类模型会透传 `reasoning_content`，并计入 token 统计与后续请求上下文。
- 流式调用可通过 `stream_include_usage` 尝试返回 usage 统计，用于精确计算占用。
- HTTP 请求复用全局连接池（`app/core/http_client.py`），降低连接建立开销。

### 5.5 Workspace & Memory

- 按 `user_id` 创建持久化工作区：
- `data/workspaces/{user_id}/files/`：用户可见文件区
- `data/wunder.db`：SQLite 持久化（backend=sqlite 时启用）
- PostgreSQL：默认持久化（历史对话、工具日志、产物索引、监控记录、系统日志、会话锁、溢出事件）
- `data/config/wunder.override.yaml`：管理端配置持久化覆盖（与基础配置分离）
- `data/historys/`：旧版 JSONL 与监控文件，仅用于迁移
- `data/user_tools/{user_id}/config.json`：用户自建 MCP/技能/知识库配置与附加提示词
- `data/user_tools/{user_id}/skills/`：用户技能包解压目录
- `data/user_tools/{user_id}/knowledge/`：用户知识库根目录（按知识库名称分子目录）
- 会话在历史 token 占用达到 `max_context * history_compaction_ratio` 时触发压缩，压缩后按 `history_compaction_reset` 重置并在收到模型 usage 后修正累计，摘要携带覆盖时间边界并在每轮模型调用前检查，避免上下文溢出。
- 上下文压缩采用结构化摘要模板，并结合产物索引保留文件变更、命令与关键输出，减少长会话遗忘。
- 工作区树缓存带版本号与脏标记，文件写入/技能执行后会主动标记并触发刷新。
- 工作区文件接口补充内容读取、搜索、批量移动/复制与分页排序，适配调试面板树形视图。
- 会话级锁控制并发写入冲突。
- 长期记忆：用户可按开关启用，系统提示词末尾追加该用户历史记忆（纯文本段落，以 `[长期记忆]` 标签开头并附带年月日时分前缀）。
- 记忆总结：每次最终回复后触发新请求（禁用工具调用），系统提示词使用 `app/prompts/memory_summary.txt`，用户消息为线程历史消息的融合内容（包含最终回复），写入数据库 `memory_records`，同会话覆盖且单用户最多 30 条。
- 记忆任务日志：写入数据库 `memory_task_logs`，与记忆记录同会话覆盖并随删除同步清理，用于历史队列长期保留。
- 总结任务按线程完成时间排队单线程执行，降低额外请求压力。

### 5.6 Prompt 与智能体设计

- 提示词模板拆分为系统、工具协议与工程师信息块，统一由 Prompt Builder 组装。
- 提示词文件集中在 `app/prompts`，按需注入工具清单与环境信息。
- 提示词模板支持语言版本目录（如 `app/prompts/en`），请求语言会决定读取版本。
- 系统提示词构建使用短时 LRU 缓存并限制容量，降低重复请求等待且避免内存膨胀。
- 提示词模板文件读取带缓存（按文件更新时间失效），避免频繁磁盘 IO 影响构建速度。
- 系统提示词预览使用轻量上下文构建，跳过工具执行器初始化以降低耗时。
- 用户技能规格按目录更新时间与启用列表缓存，减少重复扫描 SKILL.md 的成本。
- ToolSpec 序列化结果缓存复用，降低提示词构建时的 JSON 拼装开销。
- 工作区树在刷新/文件操作时缓存并结合版本号/脏标记复用，减少目录遍历开销。
- 产物索引：独立记录文件变更/命令/脚本运行摘要，作为上下文固定区块注入，避免压缩丢失关键轨迹。
- 启用技能时追加技能使用协议与 SKILL.md 路径清单，提示模型先使用 读取文件 再执行脚本。
- 启用 a2ui 时追加 A2UI 提示词，避免注入完整 Schema 造成小上下文模型溢出。
- 参考 `参考项目\eva` 的智能体设计方式与工具协议格式。

### 5.7 前端调试页面

- 提供简易 Web 页面用于测试 `/wunder` SSE 与非流式接口。
- 页面新增 A2A 服务管理面板，可配置 A2A 服务并缓存 AgentCard，启用后可作为工具注入提示词。
- 静态资源通过 `/wunder/web` 对外暴露，支持远程访问调试。
- 调试页面新增“系统介绍”页，嵌入 `/wunder/ppt` 的 PPT（页面拆分为 `docs/ppt/slides/*.js`，由 `slides/manifest.js` 清单驱动，`slides/boot.js` 动态加载）并支持全屏展示，同时提供 `/wunder/ppt-en` 英文版（`docs/ppt-en`），入口改为点击侧边栏标题。
- 页面包含 user_id、session_id、question 等输入项与事件日志区。
- 页面新增模型请求日志区，显示每轮模型 API 请求体/摘要（历史回放会裁剪）。
- 请求日志区同步展示知识库检索模型的请求体，便于排查检索流程。
- 页面新增模型输出区域，显示模型原始输出内容。
- 模型输出区域支持 A2UI 渲染，收到 a2ui 事件时直接渲染 UI。
- 页面增加侧边栏，可切换查看系统提示词，侧边栏支持滚动展示。
- 页面新增 MCP 与技能管理面板，支持配置服务与启用技能。
- 页面新增内置工具管理面板，支持勾选内置工具并实时更新启用状态。
- 页面新增字面知识库管理面板，配置多知识库目录并支持文档维护与索引刷新。
- 字面知识库支持上传多格式文件，自动转换为 Markdown 后写入知识库目录。
- 系统提示词页新增自建工具/共享工具/附加提示词区域，自建工具通过弹窗配置。
- 技能管理支持上传 zip 压缩包并自动解压到 EVA_SKILLS。
- 技能管理支持删除 EVA_SKILLS 内的技能条目，悬停展示删除按钮。
- 页面新增模型配置面板，支持多套模型配置、侧边栏切换与默认模型选择。
- 调试面板新增模型配置下拉框，可按默认或指定模型发起请求。
- 系统设置页提供语言选择，前端请求会携带 `X-Wunder-Language` 以同步后端语言。
- 页面新增系统监视面板，展示资源占用与活动/历史线程，并支持终止与查看详情。
- 系统监视支持按起止时间筛选图表统计区间，覆盖线程状态占比与工具调用热力图。
- 页面新增用户管理面板，统计用户历史对话与工具调用次数，可查看用户会话并支持删除用户数据。
- 页面新增记忆体面板，左侧用户列表、右侧运行状态，展示活动/历史队列并支持查看请求详情。
- 调试面板内置临时工作区，支持树形浏览、搜索、多选批量、拖拽移动与在线编辑。
- 调试面板支持上传文件/图片，文件经 doc2md 解析后附加请求，图片按多模态格式发送。
- MCP 服务配置以结构体导入为主，编辑通过弹窗完成，工具列表在主区域展示。

### 5.8 沙盒管理服务

- 共享沙盒服务由第二个 wunder 容器提供，复用同一镜像与代码挂载，对外暴露 `/sandboxes/execute_tool` 接口供主服务调用。
- 共享沙盒不创建子容器，适合资源紧张场景；执行命令与 ptc 时仍遵循 allow_paths/deny_globs 白名单策略。
- 共享沙盒容器仅挂载 `app` 代码（只读）、用户工作区（可写）与 `EVA_SKILLS`（只读），减少可写面。

## 6. 目录结构建议

```text
wunder/
app/
    asgi.py             # 轻量 ASGI 启动入口（惰性加载）
    api/                # 路由与接口层
    a2a/                # A2A 协议适配层
    services/           # 业务组装服务层
    core/               # 配置、日志、异常处理
    mcp/                # 自托管 MCP 服务
    knowledge/          # 字面知识库解析与检索
    orchestrator/       # 调度引擎
    llm/                # LLM 适配器
    monitor/            # 系统监控与会话状态
    tools/              # 内置工具 + MCP 适配
    skills/             # 技能加载与执行
    memory/             # 工作区与历史记录
    storage/            # 存储适配（SQLite/PostgreSQL）
    schemas/            # Pydantic 模型
    prompts/            # 提示词模板
  web/                  # 前端调试页面
    index.html
    app.js              # 前端入口脚本
    app.config.js       # 前端统一配置
    modules/            # 拆分后的页面脚本
      elements.js
      state.js
      utils.js
      log.js
      api.js
      tool-detail.js
      workspace.js
      tools.js
      prompt.js
      debug.js
      monitor.js
      mcp.js
      builtin.js
      skills.js
      llm.js
  config/
    wunder.yaml           # 统一配置文件
  data/
    knowledge/          # 字面知识库文件（Markdown）
    workspaces/         # 持久化工作区（用户文件）
    user_tools/         # 用户自建工具配置
    wunder.db           # SQLite 历史/监控/系统日志（backend=sqlite）
    postgres/           # PostgreSQL 数据卷（docker-compose 默认）
    historys/           # 旧版历史文件（迁移保留）
  docs/
    设计方案.md
    API文档.md
    功能迭代.md
    ppt/                # 系统介绍 PPT（入口 index.html）
    ppt-en/             # 系统介绍 PPT 英文版（入口 index.html）
      slides/           # 单页模块（每页一个 js，manifest.js 维护顺序）
  scripts/
    update_feature_log.py # 功能迭代记录写入脚本
  requirements.txt
```

## 7. 配置文件规范（基础 + 覆盖）

  基础配置建议路径：`config/wunder.yaml`（可通过 `WUNDER_CONFIG_PATH` 指定）。
  持久化覆盖配置路径：`data/config/wunder.override.yaml`（可通过 `WUNDER_CONFIG_OVERRIDE_PATH` 指定），用于保存管理端修改内容。

```yaml
server:
  host: 0.0.0.0
  port: 8000
  stream_chunk_size: 1024
  max_active_sessions: 30

i18n:
  default_language: zh-CN
  supported_languages:
    - zh-CN
    - en-US
  aliases:
    zh: zh-CN
    zh-cn: zh-CN
    zh-hans: zh-CN
    zh-hans-cn: zh-CN
    en: en-US
    en-us: en-US

llm:
  default: main
  models:
    main:
      enable: true
      provider: openai_compatible
      base_url: https://api.example.com
      api_key: ${WUNDER_LLM_API_KEY}
      model: gpt-4.1
      temperature: 0.7
      timeout_s: 60
      retry: 2
      max_rounds: 10
      max_context: 128000
      max_output: 4096
      support_vision: false
      stream: false
      stream_include_usage: true
      history_compaction_ratio: 0.8
      history_compaction_reset: zero
      stop:
        - </tool_call>
      mock_if_unconfigured: true

mcp:
  timeout_s: 120
  servers:
    - name: wunder
      display_name: Wunder 智能体
      endpoint: ${WUNDER_MCP_ENDPOINT:-http://127.0.0.1:8000/wunder/mcp}
      transport: streamable-http
      enabled: false
      allow_tools: []
      tool_specs:
        - name: run
          description: 执行 wunder 智能体任务并返回最终回复
          input_schema:
            type: object
            properties:
              task:
                type: string
                description: 任务描述
            required:
              - task
    - name: WebSearch
      display_name: 阿里云百炼_联网搜索
      endpoint: https://dashscope.aliyuncs.com/api/v1/mcps/WebSearch/sse
      transport: sse
      description: 基于通义实验室检索模型的联网搜索服务
      headers:
        Authorization: Bearer ${DASHSCOPE_API_KEY}
      allow_tools: []
      enabled: true

skills:
  paths:
    - ./skills
    - ./EVA_SKILLS
  enabled: ["skill_a", "skill_b"]

tools:
  builtin:
    enabled:
      - 最终回复
      - 执行命令
      - ptc
      - 列出文件
      - 搜索内容
      - 读取文件
      - 写入文件
      - 替换文本
      - 编辑文件

knowledge:
  bases:
    - name: 公司制度知识库
      description: 公司规章制度与流程说明
      root: ./knowledge/plan
      enabled: true

workspace:
  root: ./data/workspaces
  max_history_items: 200
  retention_days: 30

storage:
  backend: postgres
  db_path: ./data/wunder.db
  postgres:
    dsn: postgresql://wunder:wunder@postgres:5432/wunder
    connect_timeout_s: 5

security:
  api_key: wunder-change-me
  allow_commands: ["*"]
  allow_paths: ["./EVA_SKILLS", "./skills"]
  deny_globs: ["**/.git/**"]

sandbox:
  mode: local
  endpoint: http://sandbox:9001
  image: wunder:20250105-x86
  container_root: /workspaces
  network: bridge
  readonly_rootfs: true
  idle_ttl_s: 0
  timeout_s: 120
  resources:
    cpu: 1.0
    memory_mb: 2048
    pids: 256

observability:
  log_level: INFO
  monitor_event_limit: 500
  monitor_payload_max_chars: 0
  monitor_drop_event_types:
    - llm_output_delta
```

补充说明：
- `workspace.max_history_items` <= 0 表示不限制历史条数。
- `workspace.retention_days` <= 0 表示不做历史清理。
- `observability.monitor_event_limit` <= 0 表示不裁剪监控事件。
- `observability.monitor_payload_max_chars` <= 0 表示不截断监控事件字段。

## 8. 数据持久化与清理策略

- 历史记录：写入数据库（`chat_history` 表，默认 PostgreSQL，可选 SQLite）。
- 工具调用日志：写入数据库（`tool_logs` 表）用于回放与排错。
- 监控记录：写入数据库（`monitor_sessions` 表），重启后仍可查询。
- 系统日志：写入数据库（`system_logs` 表），便于统一检索。
- 系统提示词：会话首次构建后写入历史记录，用于审计与恢复。
- 长期记忆：写入数据库（`memory_settings`/`memory_records` 表），按用户开关管理与最多 30 条记录。
- 定时清理：`retention_days` > 0 时按天清理过旧记录，<= 0 表示不清理。

## 9. 安全与权限控制

- API/MCP 接口统一使用 `security.api_key` 进行鉴权，防止未授权访问。
- 工作区严格隔离，拒绝跨用户访问。
- 命令执行工具白名单化，支持将 `allow_commands` 设为 `*` 完全放开。
- 执行命令支持 `workdir` 指定目录，`shell` 仅在 allow_commands 为 `*` 时启用且默认开启。
- 文件工具默认仅允许访问工作区，可通过 `security.allow_paths` 放行 EVA_SKILLS 等白名单目录。
- 输入参数严格校验，限制超长问题与文件写入范围。

## 10. 可靠性与可观测性

- 统一错误码与异常封装，前端易于处理。
- 日志分级：请求日志、工具日志、模型日志。
- 监控事件按配置裁剪/限量，减少长会话占用的内存与存储压力。
- 增加指标：请求量、SSE 连接时长、错误率。
- 内部状态监控补充沙盒状态与近时段调用统计。
- 流式模型调用支持断线自动重连，并通过 `llm_stream_retry` 事件提示重连进度。
