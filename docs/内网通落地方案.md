# 内网通落地方案

## 1. 背景与目标

你提出的目标是：

1. **Desktop 本地模式不再隐藏“用户/群聊”入口**。
2. 在系统设置新增 **内网网段设置**（可选启用）。
3. 启用后，多个 Desktop 在同一内网内可自动发现、互相通信（类似内网通）。
4. **不依赖中心服务端**，只要各端程序运行且配置网段即可。
5. 支持 **黑名单**（至少网段黑名单、节点黑名单）。

本方案基于当前 wunder 代码结构，给出可落地的分阶段实现。

---

## 2. 当前代码基线（已分析）

### 2.1 Desktop 本地模式隐藏用户/群聊的现状

- `frontend/src/views/MessengerView.vue`
  - `sectionOptions` 在 `desktopMode && !isDesktopRemoteAuthMode()` 时过滤掉 `users/groups`。
  - 这是当前“本地模式隐藏用户和群聊”的直接原因。

### 2.2 系统设置现状

- `frontend/src/components/messenger/DesktopSystemSettingsPanel.vue`
  - 目前主要是模型配置 + 服务端连接（remote gateway）。
- `src/api/desktop.rs`
  - `DesktopSettingsFile` 目前字段含 `workspace_root/llm/remote_gateway/...`，无内网通信配置。
- `wunder-desktop/runtime.rs`
  - 也维护一份同构 `DesktopSettings`，同样无 LAN 配置。

### 2.3 通信与鉴权现状

- `wunder-desktop/bridge.rs`
  - `/wunder/*` 走 `desktop_token_guard`。
  - 默认监听 host 为 `127.0.0.1`（`wunder-desktop/args.rs`），并不对局域网开放。
- `src/api/user_world.rs` + `src/services/user_world.rs`
  - 已有完整的用户/群聊/会话/消息/事件能力，但消息域默认是“本机数据库内闭环”。

结论：**UI 层可快速解除隐藏，但跨机器通信需要新增“发现 + 传输 + 同步”子系统。**

---

## 3. 对 nwt 的借鉴与取舍

参考目录：`D:\BaiduNetdiskDownload\nwt\nwt`。

### 3.1 可借鉴点

1. UDP 广播发现（hello/heartbeat/probe 思路）。
2. 手工配置网段（CIDR）并支持网段黑名单。
3. “已知联系人”本地持久化（离线也可展示历史联系人）。

### 3.2 不建议直接照搬点（需规避）

1. **安全薄弱**：发现包和消息缺少强认证，容易被伪造。
2. **可靠性不足**：缺少消息 ack/retry/幂等去重。
3. **黑名单判断过粗**：`isBlockedRange` 实现并不严谨（仅按地址点判断）。
4. **会话端口信息存在歧义风险**：部分路径对 `peer.listenPort` 与连接端口边界不清。

结论：借鉴发现与配置交互思路；协议、安全、可靠性需按 wunder 标准重做。

---

## 4. 总体架构（无中心服务端）

新增一个 **Desktop LAN Mesh 子系统**（仅 Desktop 本地模式可启用）：

1. **发现平面（Discovery Plane）**
   - UDP 广播/定向探测（按网段）。
   - 维护在线节点目录（在线/离线/最后心跳）。

2. **传输平面（Transport Plane）**
   - 节点间优先使用 **WebSocket 长连接**（符合“WS优先”原则）。
   - 断连时降级为 HTTP push 重试队列（兜底）。

3. **数据平面（Data Plane）**
   - 与现有 `user_world` 打通：
     - 单聊：远端节点映射为虚拟用户。
     - 群聊：通过全局群组ID做跨节点同步。

4. **控制平面（Control Plane）**
   - 系统设置读写 LAN 参数。
   - 本地 API 提供“节点列表/拉黑/连通状态”。

---

## 5. 配置模型设计（desktop.settings.json 扩展）

在 `DesktopSettingsFile/DesktopSettings` 增加：

```json
{
  "lan_mesh": {
    "enabled": false,
    "node_id": "auto-generated-stable-uuid",
    "display_name": "",
    "listen_host": "0.0.0.0",
    "listen_port": 19123,
    "discovery_port": 19124,
    "heartbeat_interval_sec": 15,
    "peer_ttl_sec": 45,
    "allowed_subnets": ["192.168.1.0/24"],
    "blocked_subnets": [],
    "blocked_peers": [],
    "shared_secret": "",
    "auto_accept_group_sync": true
  }
}
```

说明：

- `enabled=false` 默认关闭，避免影响现有用户。
- `node_id` 首次生成后持久化，不随用户名变化。
- `shared_secret` 可空：
  - 空 = 开放 LAN（低安全，弹窗提示风险）；
  - 非空 = 启用 HMAC 验签（推荐）。

---

## 6. 存储模型设计（新增表）

> 不改旧表语义，新增 LAN 辅助表，降低回归风险。

1. `desktop_lan_peers`
   - `peer_id`(pk), `display_name`, `last_ip`, `last_port`, `online`, `last_seen_at`, `capabilities`, `blocked`

2. `desktop_lan_group_links`
   - `global_group_id`(pk), `local_group_id`, `local_conversation_id`, `revision`, `updated_at`

3. `desktop_lan_outbox`
   - `envelope_id`(pk), `peer_id`, `kind`, `payload`, `status`, `retry_count`, `next_retry_at`, `last_error`

4. `desktop_lan_inbox_dedupe`
   - `envelope_id`(pk), `from_peer_id`, `received_at`

SQLite/Postgres 均实现（符合 wunder 双存储实现习惯，虽 desktop 主用 sqlite）。

---

## 7. 协议设计（节点间）

### 7.1 发现报文（UDP）

报文类型：`hello | heartbeat | goodbye | probe`

核心字段：

- `version`
- `node_id`
- `display_name`
- `listen_port`
- `ts`
- `nonce`
- `sig`（可选，HMAC-SHA256）

接收端过滤顺序：

1. 丢弃自己；
2. 丢弃黑名单节点；
3. 丢弃命中黑名单网段来源IP；
4. 若配置密钥，验签失败丢弃；
5. 时间窗超限（防重放）丢弃。

### 7.2 业务信封（WS/HTTP）

统一 Envelope：

- `envelope_id`（ULID）
- `kind`：`dm.send` / `group.send` / `group.upsert` / `group.announcement` / `ack`
- `from_peer_id`
- `to_peer_id`
- `ts`
- `payload`
- `sig`

可靠性：

- 每条业务信封必须回 `ack`。
- 未 ack 进入 outbox 重试（指数退避 + 抖动）。
- `inbox_dedupe` 去重，保证幂等。

---

## 8. 与现有 user_world 的融合策略

### 8.1 单聊（优先落地）

- 远端节点映射虚拟用户ID：`lan:{peer_id}`。
- 联系人列表合并：
  - 本地用户联系人（原逻辑）
  - LAN 节点联系人（来自 `desktop_lan_peers`）
- 发消息路径：
  1. 本地先写入 user_world（保持 UI 即时反馈）；
  2. 异步投递到目标 peer；
  3. 对端入站后映射为 `sender_user_id = lan:{from_peer_id}` 写入本地 user_world。

### 8.2 群聊（第二阶段）

- 引入 `global_group_id` 做跨节点统一标识。
- 本地群组仍保留现有 `group_id/conversation_id`，通过 `desktop_lan_group_links` 映射。
- `group.upsert` 用于跨节点同步群名、成员、公告版本。
- 群消息 fanout 给所有在线成员节点；离线节点靠 outbox 补投。

---

## 9. 前端改造点

1. `MessengerView.vue`
   - 去掉本地模式对 `users/groups` 的过滤逻辑。

2. 系统设置新增“内网通信”页签（Desktop）
   - 位置：现有 `desktop-models`、`desktop-remote` 同级新增 `desktop-lan`。
   - 内容：
     - 启用开关
     - 网段列表（允许）
     - 网段黑名单
     - 节点黑名单
     - 共享密钥（可选）
     - 当前发现节点列表（在线状态、最后心跳、拉黑按钮）

3. i18n 文案新增中英双语键（`zh-CN.ts/en-US.ts`）。

---

## 10. 后端/桌面端改造点

1. `src/api/desktop.rs`
   - settings GET/PUT 扩展 `lan_mesh` 字段。

2. `wunder-desktop/runtime.rs`
   - 启动时根据 `lan_mesh.enabled` 拉起/关闭 LAN Mesh runtime。

3. 新增模块（建议）
   - `src/services/desktop_lan/`：
     - `settings.rs`
     - `discovery.rs`
     - `peer_registry.rs`
     - `transport_ws.rs`
     - `outbox.rs`
     - `sync.rs`

4. `src/services/user_world.rs`
   - 扩展联系人聚合与 LAN 入站写库。

5. `src/storage/{mod,sqlite,postgres}.rs`
   - 增加 LAN 元数据表及读写接口。

---

## 11. 黑名单策略细化

优先级：**节点黑名单 > 网段黑名单 > 允许网段**。

- 节点黑名单：按 `peer_id`，立即断开连接 + 清理待投递。
- 网段黑名单：按 CIDR，禁止发现、禁止连入、禁止连出。
- 允许网段：
  - 非空时只在允许网段内探测与通信；
  - 为空时默认使用本机探测到的 IPv4 网段。

输入校验：

- 支持 `ip/prefix` 和裸IP（自动补默认 `/24`；IPv6 默认 `/64`）。
- 统一归一化为 network address，去重后保存。

---

## 12. 安全策略

1. 默认 localhost bridge 不改，LAN 走独立监听端口，避免暴露全量 `/wunder/*`。
2. 可选共享密钥签名（推荐默认引导用户配置）。
3. 防重放：`ts + nonce` 窗口校验。
4. 限流：按 IP/peer 做握手与消息速率限制。
5. 最大包体限制与 JSON schema 校验，防止内存放大攻击。

---

## 13. 实施节点（里程碑）

### M0：UI 解封与配置骨架

- 目标：本地模式显示用户/群聊；设置页可保存 `lan_mesh`。
- 改动：前端导航过滤移除；desktop settings schema 扩展。
- 验收：
  - 本地模式可看到用户/群聊页签；
  - 设置保存后重启仍保留 LAN 参数。

### M1：发现服务（只发现，不发消息）

- 目标：开启 LAN 后可发现同网段节点。
- 改动：UDP hello/heartbeat/probe + peer registry + 黑名单生效。
- 验收：
  - 两台机器互相出现在线节点；
  - 命中黑名单后节点立即消失且不再重现。

### M2：单聊跨节点（可收发）

- 目标：`users` 列表可直接与 LAN 节点单聊。
- 改动：WS 连接、envelope、ack/retry/dedupe、入站写 user_world。
- 验收：
  - 双端互发文本消息，断网重连后可恢复；
  - 重复投递不会重复入库。

### M3：群聊跨节点同步

- 目标：支持跨节点群聊创建、收发、公告同步。
- 改动：`global_group_id` + `group.upsert` + 群消息 fanout。
- 验收：
  - A 建群（含 B/C）后 B/C 自动出现该群；
  - 群消息与公告在三端一致。

### M4：安全加固

- 目标：完成共享密钥验签、防重放、限流。
- 验收：
  - 密钥不一致节点无法发现/通信；
  - 重放旧包被拒绝。

### M5：稳定性与可观测

- 目标：10+ 节点长时间运行稳定。
- 改动：outbox 指标、连接状态面板、故障日志。
- 验收：
  - 24h 压测无崩溃；
  - 弱网下消息最终可达率达标（可配置阈值）。

---

## 14. 测试清单（必须覆盖）

1. 基础：节点发现、上线/离线抖动。
2. 黑名单：网段/节点实时生效。
3. 单聊：文本、附件、重复包、乱序包。
4. 群聊：建群、发消息、公告同步、离线补投。
5. 安全：错误签名、过期时间戳、重放 nonce。
6. 回归：远端模式、普通本地模式、channels/workspace 等不受影响。

---

## 15. 文档联动要求（落地时）

本方案实施代码后，需要同步更新：

- `docs/设计方案.md`
- `docs/API文档.md`
- `docs/系统介绍.md`
- `docs/测试大纲.md`

并持续通过 `scripts/update_feature_log.py` 写入 `docs/功能迭代.md`。

---

## 16. 一句话结论

建议采用“**UDP发现 + WS主链路 + user_world融合 + 黑名单/签名/重试机制**”的 Desktop LAN Mesh 方案：
**先解封入口和配置，再分阶段上线单聊、群聊、安全与稳定性能力**，可在不引入中心服务端的前提下实现可维护的内网通体验。
