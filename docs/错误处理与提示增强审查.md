# 错误处理与提示增强审查（Rust 后端）

日期：2026-02-05

范围：仅覆盖 `src/` Rust 后端与运行时（不含 `frontend/` 与 `app/`）。

目标：减少上线后的“奇怪问题”、提高错误可诊断性、并通过冗余处理避免单点失败导致的不可用。


## 总体观察

- 多处采用 `unwrap_or_default()` / `let _ = ...` / `.ok()` 忽略错误，导致“表面成功、实际失败”的隐性问题。
- 错误响应格式不统一，且大量内部错误被以 `400 BAD_REQUEST` 返回，难以区分客户端问题与服务端问题。
- 重要链路（存储、流式事件、任务队列）缺少“失败可追踪”的冗余机制与告警提示。
- 用户侧提示多为“message 字符串”，缺少 error code、可重试标识与可操作建议。


## 建议统一的错误响应与提示规范（建议先做基础规范，再落地各模块）

- 统一 error envelope：
  - `error.code`（稳定错误码）、`error.message`（i18n 文案）、`error.request_id`、`error.retryable`、`error.detail`（仅 admin 或 debug）。
- SSE/WS 也应发送统一格式的 `error` 事件，确保前端与日志可一致解析。
- 对外提示避免泄露内部细节；对内日志记录完整错误链与上下文（user_id/session_id/tool_name）。
- 对可重试错误（网络、依赖服务不可用）提供“建议重试/稍后再试”的提示。

参考落点：`src/api/chat.rs:1654`、`src/api/core.rs:628`、`src/main.rs:393`。


## 重点问题与改进清单（按优先级）

### P0：高风险（影响可用性/一致性/稳定性）

1) 配置持久化失败被吞掉
- 现状：`ConfigStore::persist` 在创建目录/写文件失败时仅 `warn` 或忽略错误，`update` 仍返回成功。
- 风险：配置表面更新成功，但实际未落盘，重启后丢失。
- 建议：
  - 让 `persist` 返回错误并向上抛出；在 API 层返回明确失败。
  - 失败时可写入临时备份路径并记录告警。
- 定位：`src/core/config_store.rs:64`、`src/core/config_store.rs:69`、`src/core/config_store.rs:74`。

2) 存储初始化失败被忽略
- 现状：`WorkspaceManager::new` 调用 `ensure_initialized()` 但忽略结果。
- 风险：存储不可用时仍继续运行，后续读写异常难定位。
- 建议：初始化失败应显式报错并拒绝启动，或降级到只读/内存模式并暴露健康状态。
- 定位：`src/services/workspace.rs:200`。

3) 流式事件持久化错误不记录
- 现状：`append_stream_event/delete_stream_events_before` 的错误被完全吞掉。
- 风险：SSE/WS 断线恢复时缺事件；事件丢失无法追踪。
- 建议：
  - 记录错误次数与最后错误；严重时触发告警。
  - 写失败时允许退回到内存缓冲或二次重试。
- 定位：`src/orchestrator/event_stream.rs:266`、`src/orchestrator/event_stream.rs:268`、`src/orchestrator/event_stream.rs:272`、`src/orchestrator/event_stream.rs:274`。

4) 写入聊天/工具日志错误被忽略
- 现状：append chat/tool/artifact 失败时直接忽略。
- 风险：日志与监控丢失，难以追溯问题；可能造成上下文压缩/回放异常。
- 建议：
  - 记录失败原因与数量；必要时触发降级或重试。
  - 对关键日志（如工具执行结果）可引入同步或“失败重放队列”。
- 定位：`src/orchestrator/tool_exec.rs:154`、`src/orchestrator/tool_exec.rs:199`、`src/orchestrator/tool_exec.rs:273`。

5) 会话锁续租/释放失败无反馈
- 现状：锁续租与释放均忽略错误。
- 风险：锁长期占用，用户会话“永久忙碌”。
- 建议：记录失败并在后台进行锁清理/重建；错误计数触发告警。
- 定位：`src/orchestrator/limiter.rs:59`、`src/orchestrator/limiter.rs:71`。


### P1：中风险（诊断困难/提示不清/误判错误类型）

6) LLM 响应解析失败被吞掉
- 现状：`response.json().await.unwrap_or(Value::Null)` 直接吞解析错误。
- 风险：上游返回非 JSON 时，错误信息丢失，表现为“空响应”。
- 建议：
  - 失败时保留原始 body 并返回结构化错误；仅在 debug 时暴露 detail。
  - 对流式响应，若未收到 `[DONE]` 应返回 `stream_incomplete` 错误或标记。
- 定位：`src/services/llm.rs:127`、`src/services/llm.rs:171`、`src/services/llm.rs:403`。

7) LLM 失败统一映射为 INTERNAL_ERROR
- 现状：重试用尽后统一 `internal`，丢失“超时/不可用/认证”等分类。
- 风险：前端无法判断是否可重试；用户提示不准确。
- 建议：按错误类型细分为 `LLM_UNAVAILABLE` / `LLM_TIMEOUT` / `LLM_BAD_REQUEST` 等，并在 i18n 提示中给出可操作建议。
- 定位：`src/orchestrator/llm.rs:486`。

8) API 层把内部错误当作 BAD_REQUEST
- 现状：`map_orchestrator_error` 默认 `400`，内部错误也落 `BAD_REQUEST`。
- 风险：客户端误判为参数问题；告警层无法区分 4xx/5xx。
- 建议：内部错误统一返回 5xx，并携带 `error.code` 与 `request_id`。
- 定位：`src/api/core.rs:628`、`src/api/chat.rs:1633`。

9) 历史记录加载失败直接返回空
- 现状：`load_history(...).unwrap_or_default()`。
- 风险：聊天历史“突然消失”，用户体验差且难追踪。
- 建议：记录日志并返回错误提示或在响应中标记 `history_incomplete`。
- 定位：`src/api/chat.rs:287`、`src/api/chat.rs:288`。

10) Agent 队列任务拉取失败被忽略
- 现状：`spawn_blocking` join 失败时默认空列表，不记录错误。
- 风险：队列“静默停摆”。
- 建议：至少记录错误并触发自恢复（重启 loop、标记 unhealthy）。
- 定位：`src/services/agent_runtime.rs:503`、`src/services/agent_runtime.rs:505`。

11) Memory 模块写入失败无提示
- 现状：`set_enabled`、`upsert_task_log` 等写入失败直接忽略。
- 风险：记忆功能随机失效，UI 无明确反馈。
- 建议：返回 Result 并在 API 层提示；写入失败也应记录 `memory_error` 事件。
- 定位：`src/services/memory.rs:127`、`src/services/memory.rs:311`。

12) LSP 读消息失败不记录
- 现状：`read_message` 返回 `None` 即断开，无详细日志。
- 风险：LSP 服务异常时难定位具体原因（stderr/协议错误）。
- 建议：记录原始读失败与解析失败；必要时自动重启。
- 定位：`src/lsp/mod.rs:955`。

13) Sandbox 响应解析失败信息不足
- 现状：读取响应失败时 `unwrap_or_default`，丢失 detail。
- 风险：Sandbox 不可用时难以排查（网络/协议/权限）。
- 建议：保留 response body/状态码并返回结构化 error；设置 retry/backoff。
- 定位：`src/sandbox/mod.rs:351`、`src/sandbox/mod.rs:358`。

14) 渠道消息写入失败被忽略
- 现状：保存媒体与消息入库失败仅 `.ok()`。
- 风险：多渠道消息丢失但没有任何告警。
- 建议：记录失败并把错误落到 outbox/monitor 事件中，便于追踪。
- 定位：`src/channels/service.rs:171`、`src/channels/service.rs:185`、`src/channels/service.rs:187`。

15) i18n 消息加载失败静默降级
- 现状：i18n 文件解析失败直接返回 None，无告警。
- 风险：线上提示退化为 key 字符串，用户难理解。
- 建议：记录错误并暴露健康状态；可在启动阶段校验 i18n 文件。
- 定位：`src/core/i18n.rs:318`、`src/core/i18n.rs:323`、`src/core/i18n.rs:325`。


## 建议的落地顺序

1) 统一错误响应格式 + request_id（全链路）
2) 修复 P0 中“吞错”路径（配置、流式事件、日志写入、锁续租）
3) LLM 与工具执行错误分类 + 可重试提示
4) 队列/存储/历史读写的“失败可见性”
5) LSP/Sandbox/Channels 的错误日志与告警增强


## 备注

- 建议先补充“错误日志 + request_id + error.code”三件套，再做深层次的重试/熔断。
- 对外提示尽量简洁明确；对内日志保留完整细节与上下文。

