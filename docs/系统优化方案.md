# 系统优化方案

本方案面向 wunder 的长期稳定运行、工具调用可靠性、上下文压缩可控性与高并发性能，参考成熟系统实践（如 codex-main）进行系统级重构与优化。后续按该方案持续推进，不以阶段性询问为阻断，节点完成即落地与验证测试。

## 目标与原则

### 目标
- 保障智能体在高并发、长会话场景下稳定运行 10 年以上，性能与内存可控。
- 让工具调用与上下文压缩可预测、可审计、可恢复，减少异常与漂移。
- 构建可迭代的系统分层，便于长期重构与功能扩展。

### 原则
- 正确性优先于性能优化，性能优化必须有指标与回归验证。
- 统一模型输入、工具执行、历史持久化与事件流的核心抽象。
- 所有关键路径都要有熔断、超时、降级与观测。
- 配置与行为保持一致性，降低隐式逻辑分叉。

## 现状痛点与差距概览

- 工具执行仍以串行和单工具为主，缺乏并行/取消/失败重试策略。
- 上下文压缩与 token 统计基于近似估算与历史累加，无法反映真实上下文占用量。
- 流式事件与历史持久化存在顺序与一致性风险，出现中断时状态恢复不稳定。
- 命令执行与沙箱策略缺少统一的审批与策略管理（仅 allowlist 难以覆盖复杂场景）。
- MCP 工具命名、schema 适配与缓存机制不足，导致模型工具可用性与稳定性弱。
- 观测体系粒度不够，难以定位长期性能与稳定性退化的根因。

## 路线图与阶段目标

### P0：基础稳定与一致性（先做）
目标：保证上下文、工具、事件三条关键链路的准确性与可恢复性。

- **上下文与 token 计数统一**
  - 引入 ContextManager 概念，规范化历史项（tool call/output 配对、摘要项、系统项）。
  - 将“上下文占用量”与“调用消耗量”拆分记录，避免只靠 usage.total。
  - 在 compaction 前后统一使用实际 prompt 预算估算。
- **工具执行体系重构**
  - 支持同一回合多工具调用，允许并行执行（可配置）。
  - 引入工具级超时、取消、重试策略与可观测事件。
  - 工具输出统一截断与结构化元数据（exit code、duration、truncation）。
- **流式事件一致性**
  - 事件队列与持久化写入的顺序与幂等性优化。
  - 流式中断后的事件补偿与恢复机制。

交付物与验收：
- 关键指标：长会话 compaction 成功率 > 99%，工具调用失败率 < 1%（非业务失败）。
- 事件流在断连重连后不丢失关键事件，能正确回放 final/compaction/tool_result。

### P1：安全治理与隔离
目标：引入统一审批与策略管理，降低不安全调用风险。

- **执行策略与审批链路**
  - 类似 exec policy 的规则系统，覆盖命令类工具与高风险文件变更。
  - 对审批做“会话级缓存”，减少重复确认。
- **沙箱与权限模型**
  - 统一 sandbox 选择与降级逻辑（失败重试可配置）。
  - 明确网络、文件、进程权限边界与日志记录。
- **MCP 工具规范化**
  - 规范工具名（安全字符、长度限制、冲突去重）。
  - MCP tool schema 缓存与刷新策略，提升稳定性。

交付物与验收：
- 审批与执行策略有可视化记录与回放。
- 危险命令在默认策略下拒绝或需审批，且日志可追溯。

### P2：性能与可观测体系
目标：提升吞吐与稳定性，建立长期观测能力。

- **性能优化**
  - prompt/工具描述缓存、工作区树缓存、MCP 工具缓存优化。
  - 工具调用与 LLM 请求并行化和连接复用。
  - 关键 I/O 路径引入批量写入与队列化处理。
- **可观测性**
  - 统一埋点：请求延迟、工具耗时、失败率、token 占用、上下文压缩比例。
  - 引入分层日志级别与结构化日志字段（trace_id/session_id/tool）。

交付物与验收：
- 高并发下 p95 延迟下降、吞吐稳定无明显抖动。
- 观测面板能定位 80% 以上的性能与稳定性问题。

### P3：架构完善与长期演进
目标：减少耦合、提高扩展性。

- **调度与多智能体能力**
  - A2A 任务调度与回收机制，支持多级协作与状态同步。
  - 智能体线程与用户管理隔离、资源配额控制。
- **模块化与 API 收敛**
  - 提炼 ToolOrchestrator/ContextManager/PromptPipeline 等核心模块。
  - API 文档、系统介绍与设计方案同步更新。
- **长期维护机制**
  - 引入回归测试与压测基线，防止性能退化。
  - 文档与功能迭代日志强制更新。

交付物与验收：
- 架构层级清晰，可在不破坏核心链路的前提下扩展。
- 新功能上线后回归测试覆盖率与稳定性达标。

## 关键节点（里程碑拆解）

| 节点 | 目标 | 关键交付 | 验收 | 状态 |
| --- | --- | --- | --- | --- |
| M0 | 上下文与 token 统一 | ContextManager + token 统计拆分 + compaction 改造 | 长会话无溢出，token 统计误差可控 | 已完成 |
| M1 | 工具执行体系升级 | 多工具/并行/取消/超时/输出截断 | 工具执行成功率显著提升 | 已完成 |
| M2 | 事件与历史一致性 | SSE 事件可靠回放 + 持久化策略优化 | 断连恢复无关键事件丢失 | 已完成 |
| M3 | 安全治理落地 | 审批 + exec policy + sandbox 统一 | 高风险操作可控 | 已完成 |
| M4 | 性能与观测 | 缓存优化 + 指标体系 + 观测面板 | p95 延迟下降且可追踪 | 已完成 |
| M5 | 架构演进 | 模块化与接口收敛 + 文档同步 | 可持续迭代与维护 | 已完成 |

## 验证与测试策略

- 单元测试：工具解析、token 估算、compaction 规则、MCP 命名规范。
- 集成测试：流式任务、A2A 调度、长上下文对话、断连恢复。
- 性能测试：高并发工具调用、长会话上下文压缩、MCP 工具列表拉取。
- 安全测试：命令策略、文件越权、沙箱隔离。

## 风险与应对

- **重构期间稳定性下降**：采用渐进切换与双轨对比（旧/新链路并行对照）。
- **工具调用兼容风险**：兼容旧协议并提供迁移层，避免模型工具失效。
- **上下文压缩误差**：引入多层回退策略（裁剪 + 直接总结 + 最小可用上下文）。
- **性能优化回归**：所有优化需绑定指标与对比报告。

## 执行与协作方式

- 不在中途停下来询问，按节点落地并验证测试。
- 每个节点完成后更新 `docs/功能迭代.md`，必要时同步 `docs/设计方案.md`、`docs/API文档.md`、`docs/系统介绍.md`。
- 所有改动必须记录关键指标与回归结果。

## 深入分析与总体优化方案（追加）

### 深入分析：结构性差距与瓶颈

- **协议与事件层缺乏版本化与幂等语义**：/wunder 的事件与工具协议仍以内嵌实现为主，缺少独立 schema 与明确的回放/兼容策略，容易导致前后端升级后回放不一致。
- **工具执行缺少统一治理**：目前工具超时/并行/重试/熔断等策略不统一，且资源预算更多集中在命令类工具，外部 MCP/Skills 等缺少同等级约束。
- **调度链路耦合**：Prompt 构建、上下文压缩、工具调度、事件写入交织，难以做性能隔离与责任拆分，重构成本高。
- **并发控制偏局部**：已有会话锁保障单 user_id 互斥，但对跨用户突发流量、跨模型调用的公平调度与背压不足，p95/p99 易抖动。
- **观测体系未形成全链路闭环**：已有吞吐/性能采样，但与线上链路缺少统一的 trace/metrics 口径，难以做长期回归对比。
- **数据生命周期治理不足**：事件、历史、产物、监控的生命周期策略与归档路径不清晰，长期增长会侵蚀性能与成本。

### 总体优化方案（分域治理）

#### 1. 协议与事件层（系统对外稳定性）
- 统一 /wunder 与 /a2a 的事件模型，建立版本化 schema 与字段兼容策略。
- 为事件与工具结果引入序列号与幂等键，明确断连重放规则。
- 维护协议转换层，保证旧客户端可用、新客户端可升级。

#### 2. 调度与上下文链路（系统核心稳定性）
- 抽离 PromptPipeline / ContextManager / ToolOrchestrator 三大模块，形成清晰的责任边界。
- 上下文预算、工具注入、压缩触发规则统一化并可配置化。
- Compaction 引入多策略 fallback（裁剪/摘要/最小可用），并记录可解释日志。

#### 3. 工具治理与执行（系统可靠性）
- 构建工具注册中心：schema 校验、版本锁定、健康检查与短 TTL 缓存。
- 工具执行统一策略：超时/重试/熔断/并行度/输出截断/结构化元信息。
- 全工具引入资源预算（CPU/内存/IO/网络）与风险级别分层。

#### 4. 沙箱与安全策略（系统安全性）
- exec_policy 从“命令类工具”扩展到“全工具权限矩阵”，统一审批/豁免策略。
- 建立策略命中与审批日志，支持会话级缓存与可追溯回放。

#### 5. 存储与数据生命周期（系统可持续性）
- 事件流采用 append-only + 周期快照 + 历史归档。
- 核心表按 user_id/time 分区，历史数据可冷存储。
- 大对象产物拆分独立表或对象存储，避免挤压主链路。

#### 6. 性能与资源调度（系统吞吐）
- 引入全局队列与公平调度，支持 per-user/per-model 限流与背压。
- 关键 I/O 与模型调用引入连接池、批量写入与缓存复用。
- 对高成本链路设置性能预算与自动告警阈值。

#### 7. 观测与运维（系统可运营）
- 统一 trace_id/session_id/tool_id，并接入结构化日志与 OTEL。
- 关键指标：失败率、p95/p99、工具耗时、压缩命中率、token 占用量。
- 观测面板与告警阈值绑定 SLO，形成闭环迭代。

#### 8. 质量与演进机制（系统可维护）
- 基于事件流的回放测试 + 压测基线 + 性能预算。
- 分阶段灰度与开关治理，支持快速回滚。
- 新增/变更 API 必须同步更新 docs/ 与功能迭代记录。

### 持续推进节点（M6+）

| 节点 | 目标 | 关键交付 | 验收 | 状态 |
| --- | --- | --- | --- | --- |
| M6 | 协议与事件标准化 | 版本化 schema + 事件序列号/幂等键 + 兼容层 | 断连回放一致性 > 99% | 待开始 |
| M7 | 调度链路模块化 | PromptPipeline/ContextManager/ToolOrchestrator 抽离 | 关键链路解耦，压缩与调度可独立回归 | 待开始 |
| M8 | 工具治理与执行统一 | 工具注册中心 + 统一执行策略 | 工具失败率下降，日志可追溯 | 待开始 |
| M9 | 安全策略矩阵 | 全工具 exec_policy + 审批缓存 | 高风险调用可审计、可拦截 | 待开始 |
| M10 | 数据生命周期治理 | 事件快照/归档 + 分区表设计 | 历史查询性能稳定 | 待开始 |
| M11 | 资源调度与性能 | 全局队列 + 限流/背压 | 高并发 p95 稳定下降 | 待开始 |
| M12 | 观测与 SLO | 统一指标/trace + 告警阈值 | 80% 以上问题可定位 | 待开始 |
| M13 | 质量与回归体系 | 回放测试 + 压测基线 + 灰度方案 | 发布回归可量化 | 待开始 |

### 推进规则（必须遵守）

- 每个节点拆解为可交付子任务，完成后才进入下一节点。
- 每次合入变更必须绑定指标对比与回归结果。
- 任一节点涉及系统结构变更时同步更新 `docs/设计方案.md`、`docs/API文档.md`、`docs/系统介绍.md`。

## 可行性与落地评估

### 可行性结论
- **总体可行**：P0-P5 已完成，说明当前团队具备核心链路改造能力；M6+ 更多是规范化与工程治理，可通过增量演进落地。
- **成功前提**：必须建立稳定的“基线指标 + 回归测试 + 变更开关”三件套，否则优化会被性能回归抵消。
- **主要风险**：跨模块改造导致历史兼容问题，需要明确协议兼容层与双轨运行期。

### 其他人可执行性的保障机制
- **统一交付模板**：每个节点提交统一的设计说明、变更清单、数据迁移方案、测试计划、回滚策略。
- **模块边界清晰化**：先定义接口与输入/输出契约，再实施迁移，避免“边做边定义”。
- **变更最小化策略**：优先通过特性开关、影子流量、读写双轨实现，降低一次性切换风险。

### 实现后的效果评估
- **稳定性**：事件回放一致性、工具失败率、长会话 compaction 命中率可显著提升。
- **性能**：在高并发下 p95/p99 延迟稳定下降，系统抖动收敛。
- **可维护性**：模块职责明确，故障定位与性能回归定位成本下降。

## 节点落地模板与细化清单

### 通用交付模板（所有节点必须具备）
- 目标与范围（影响面、非目标）
- 设计说明（协议/接口/数据结构变更）
- 兼容策略（旧/新版本并行期规则）
- 实现清单（模块拆分、关键路径）
- 测试计划（回放/回归/性能/安全）
- 观测与告警（新增指标、阈值、面板）
- 回滚方案（开关、回退路径、数据恢复）

### M6-M13 细化工作包

#### M6：协议与事件标准化
- 产出 `event_schema` 与 `tool_result_schema` 的版本号与兼容矩阵。
- 为事件写入加入序列号与幂等键，补齐断连回放测试。
- 更新 SSE 与存储层字段映射，并同步文档。

#### M7：调度链路模块化
- 抽离 `PromptPipeline/ContextManager/ToolOrchestrator` 的接口与生命周期。
- 明确“上下文预算/压缩触发/工具注入”的配置入口与默认值。
- 引入影子调用对照，保证新旧链路输出一致。

#### M8：工具治理与执行统一
- 工具注册中心落地：schema 校验、缓存、健康检查、版本锁定。
- 工具执行统一策略：超时/重试/熔断/并行度控制。
- 工具结果统一输出格式，保证事件与审计可追溯。

#### M9：安全策略矩阵
- exec_policy 扩展为“工具级权限矩阵 + 风险等级”。
- 会话级审批缓存与审计日志打通，支持追溯。
- 建立默认策略与例外策略的配置模板。

#### M10：数据生命周期治理
- 事件流快照与归档方案落地，明确保留周期与冷存储策略。
- 核心表分区策略与索引规范。
- 产物/附件拆分存储，避免拖慢主链路查询。

#### M11：资源调度与性能
- 引入全局队列与公平调度，支持 per-user/per-model 限流。
- 关键 I/O 与模型调用连接池、批量写入与缓存复用。
- 性能预算与告警阈值挂钩，避免无约束扩张。

#### M12：观测与 SLO
- 统一 trace_id/session_id/tool_id 的传播与日志字段。
- 核心指标统一为“失败率/延迟/占用/压缩/工具耗时”。
- SLO 绑定告警阈值，形成“监测->定位->回归”的闭环。

#### M13：质量与回归体系
- 基于事件回放的回归测试集，覆盖关键路径。
- 压测基线与性能预算表，作为发布门槛。
- 灰度策略与回滚演练常态化。

## 效果指标与验收矩阵（建议目标）

| 领域 | 指标 | 建议目标 |
| --- | --- | --- |
| 协议与事件 | 断连回放一致性 | > 99% |
| 工具治理 | 非业务失败率 | < 1% |
| 上下文压缩 | compaction 命中率 | > 99% |
| 性能 | 高并发 p95 延迟 | 持续下降且无明显抖动 |
| 观测与运维 | 关键问题定位成功率 | > 80% |

## 节点任务拆解与责任分配（补充）

### 任务拆解规则
- 单个节点拆成 3-6 个任务卡，每张卡完成周期建议 1-2 周。
- 任务卡必须可独立交付与回滚，避免跨节点强耦合。
- 所有任务卡必须关联“指标/测试/开关”三件套的最小闭环。

### 任务卡模板（填写后执行）
- 任务名称：
- 负责人：
- 时间窗：
- 依赖：
- 交付物：
- 验收标准：
- 监控指标：
- 风险与回滚：

### M6-M13 任务卡拆解（建议）

#### M6：协议与事件标准化
- 任务：事件/工具结果 schema 版本化与兼容矩阵；负责人/时间窗：待定。
- 任务：事件序列号与幂等键落库，补齐断连回放；负责人/时间窗：待定。
- 任务：SSE/存储字段映射与兼容层；负责人/时间窗：待定。
- 任务：协议与事件文档同步更新；负责人/时间窗：待定。

#### M7：调度链路模块化
- 任务：抽象 PromptPipeline 接口与最小实现；负责人/时间窗：待定。
- 任务：抽象 ContextManager（预算/压缩/历史）；负责人/时间窗：待定。
- 任务：抽象 ToolOrchestrator（调用/并行/事件）；负责人/时间窗：待定。
- 任务：影子链路对照与一致性测试；负责人/时间窗：待定。

#### M8：工具治理与执行统一
- 任务：工具注册中心（schema 校验 + 缓存 + 版本锁定）；负责人/时间窗：待定。
- 任务：统一执行策略（超时/重试/熔断/并行度）；负责人/时间窗：待定。
- 任务：统一工具结果格式与审计字段；负责人/时间窗：待定。
- 任务：工具健康检查与降级策略；负责人/时间窗：待定。

#### M9：安全策略矩阵
- 任务：工具风险等级与权限矩阵定义；负责人/时间窗：待定。
- 任务：策略命中/审批缓存/审计日志链路打通；负责人/时间窗：待定。
- 任务：默认策略模板与例外策略落地；负责人/时间窗：待定。

#### M10：数据生命周期治理
- 任务：事件快照与归档方案（保留周期/冷存储）；负责人/时间窗：待定。
- 任务：核心表分区与索引规范；负责人/时间窗：待定。
- 任务：产物/附件拆分存储；负责人/时间窗：待定。

#### M11：资源调度与性能
- 任务：全局队列与公平调度落地；负责人/时间窗：待定。
- 任务：per-user/per-model 限流与背压；负责人/时间窗：待定。
- 任务：连接池/批量写入/缓存复用；负责人/时间窗：待定。
- 任务：性能预算阈值与告警挂钩；负责人/时间窗：待定。

#### M12：观测与 SLO
- 任务：trace_id/session_id/tool_id 贯通；负责人/时间窗：待定。
- 任务：指标采集统一与面板建设；负责人/时间窗：待定。
- 任务：SLO 阈值与告警联动；负责人/时间窗：待定。

#### M13：质量与回归体系
- 任务：事件回放回归测试集；负责人/时间窗：待定。
- 任务：压测基线与性能预算表；负责人/时间窗：待定。
- 任务：灰度与回滚演练常态化；负责人/时间窗：待定。

## 发布门槛三件套（基线指标/回放测试/灰度开关）

### 基线指标
- 定义统一指标口径（失败率/p95/p99/工具耗时/压缩命中率/上下文占用）。
- 固化基线窗口（建议 7-14 天），形成“基线报告 + 阈值区间”。
- 每次发布对比基线，超出阈值需阻断或降级。

### 回放测试
- 基于真实事件流生成回放集，覆盖核心路径与高风险工具链路。
- 断言粒度以“事件序列 + 关键字段”而非文本一致为主，避免模型随机性干扰。
- 回放通过才能进入灰度阶段，失败必须回滚或修复。

### 灰度开关
- 所有跨模块改造必须有开关（配置/环境变量/策略开关）。
- 灰度必须可按 user_id/租户/比例逐步放量。
- 允许新旧链路双轨并行，支持一键回退。

### 发布闸门（必过清单）
- 基线指标对比通过。
- 回放测试全绿。
- 灰度开关已接入且可回退验证。


