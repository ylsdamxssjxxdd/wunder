# 系统优化方案

本方案面向 wunder 的长期稳定运行、工具调用可靠性、上下文压缩可控性与高并发性能，参考成熟系统实践（如 codex-main）进行系统级重构与优化。后续按该方案持续推进，不以阶段性询问为阻断，节点完成即落地与验证测试。

## 目标与原则

### 目标
- 保障智能体在高并发、长会话场景下稳定运行 10 年以上，性能与内存可控。
- 让工具调用与上下文压缩可预测、可审计、可恢复，减少异常与漂移。
- 构建可迭代的系统分层，便于长期重构与功能扩展。

### 原则
- 正确性优先于性能优化，性能优化必须有指标与回归验证。
- 统一模型输入、工具执行、历史持久化与事件流的核心抽象。
- 所有关键路径都要有熔断、超时、降级与观测。
- 配置与行为保持一致性，降低隐式逻辑分叉。

## 现状痛点与差距概览

- 工具执行仍以串行和单工具为主，缺乏并行/取消/失败重试策略。
- 上下文压缩与 token 统计基于近似估算与历史累加，无法反映真实上下文占用量。
- 流式事件与历史持久化存在顺序与一致性风险，出现中断时状态恢复不稳定。
- 命令执行与沙箱策略缺少统一的审批与策略管理（仅 allowlist 难以覆盖复杂场景）。
- MCP 工具命名、schema 适配与缓存机制不足，导致模型工具可用性与稳定性弱。
- 观测体系粒度不够，难以定位长期性能与稳定性退化的根因。

## 路线图与阶段目标

### P0：基础稳定与一致性（先做）
目标：保证上下文、工具、事件三条关键链路的准确性与可恢复性。

- **上下文与 token 计数统一**
  - 引入 ContextManager 概念，规范化历史项（tool call/output 配对、摘要项、系统项）。
  - 将“上下文占用量”与“调用消耗量”拆分记录，避免只靠 usage.total。
  - 在 compaction 前后统一使用实际 prompt 预算估算。
- **工具执行体系重构**
  - 支持同一回合多工具调用，允许并行执行（可配置）。
  - 引入工具级超时、取消、重试策略与可观测事件。
  - 工具输出统一截断与结构化元数据（exit code、duration、truncation）。
- **流式事件一致性**
  - 事件队列与持久化写入的顺序与幂等性优化。
  - 流式中断后的事件补偿与恢复机制。

交付物与验收：
- 关键指标：长会话 compaction 成功率 > 99%，工具调用失败率 < 1%（非业务失败）。
- 事件流在断连重连后不丢失关键事件，能正确回放 final/compaction/tool_result。

### P1：安全治理与隔离
目标：引入统一审批与策略管理，降低不安全调用风险。

- **执行策略与审批链路**
  - 类似 exec policy 的规则系统，覆盖命令类工具与高风险文件变更。
  - 对审批做“会话级缓存”，减少重复确认。
- **沙箱与权限模型**
  - 统一 sandbox 选择与降级逻辑（失败重试可配置）。
  - 明确网络、文件、进程权限边界与日志记录。
- **MCP 工具规范化**
  - 规范工具名（安全字符、长度限制、冲突去重）。
  - MCP tool schema 缓存与刷新策略，提升稳定性。

交付物与验收：
- 审批与执行策略有可视化记录与回放。
- 危险命令在默认策略下拒绝或需审批，且日志可追溯。

### P2：性能与可观测体系
目标：提升吞吐与稳定性，建立长期观测能力。

- **性能优化**
  - prompt/工具描述缓存、工作区树缓存、MCP 工具缓存优化。
  - 工具调用与 LLM 请求并行化和连接复用。
  - 关键 I/O 路径引入批量写入与队列化处理。
- **可观测性**
  - 统一埋点：请求延迟、工具耗时、失败率、token 占用、上下文压缩比例。
  - 引入分层日志级别与结构化日志字段（trace_id/session_id/tool）。

交付物与验收：
- 高并发下 p95 延迟下降、吞吐稳定无明显抖动。
- 观测面板能定位 80% 以上的性能与稳定性问题。

### P3：架构完善与长期演进
目标：减少耦合、提高扩展性。

- **调度与多智能体能力**
  - A2A 任务调度与回收机制，支持多级协作与状态同步。
  - 智能体线程与用户管理隔离、资源配额控制。
- **模块化与 API 收敛**
  - 提炼 ToolOrchestrator/ContextManager/PromptPipeline 等核心模块。
  - API 文档、系统介绍与设计方案同步更新。
- **长期维护机制**
  - 引入回归测试与压测基线，防止性能退化。
  - 文档与功能迭代日志强制更新。

交付物与验收：
- 架构层级清晰，可在不破坏核心链路的前提下扩展。
- 新功能上线后回归测试覆盖率与稳定性达标。

## 关键节点（里程碑拆解）

| 节点 | 目标 | 关键交付 | 验收 | 状态 |
| --- | --- | --- | --- | --- |
| M0 | 上下文与 token 统一 | ContextManager + token 统计拆分 + compaction 改造 | 长会话无溢出，token 统计误差可控 | 已完成 |
| M1 | 工具执行体系升级 | 多工具/并行/取消/超时/输出截断 | 工具执行成功率显著提升 | 已完成 |
| M2 | 事件与历史一致性 | SSE 事件可靠回放 + 持久化策略优化 | 断连恢复无关键事件丢失 | 已完成 |
| M3 | 安全治理落地 | 审批 + exec policy + sandbox 统一 | 高风险操作可控 | 已完成 |
| M4 | 性能与观测 | 缓存优化 + 指标体系 + 观测面板 | p95 延迟下降且可追踪 | 已完成 |
| M5 | 架构演进 | 模块化与接口收敛 + 文档同步 | 可持续迭代与维护 | 已完成 |

## 验证与测试策略

- 单元测试：工具解析、token 估算、compaction 规则、MCP 命名规范。
- 集成测试：流式任务、A2A 调度、长上下文对话、断连恢复。
- 性能测试：高并发工具调用、长会话上下文压缩、MCP 工具列表拉取。
- 安全测试：命令策略、文件越权、沙箱隔离。

## 风险与应对

- **重构期间稳定性下降**：采用渐进切换与双轨对比（旧/新链路并行对照）。
- **工具调用兼容风险**：兼容旧协议并提供迁移层，避免模型工具失效。
- **上下文压缩误差**：引入多层回退策略（裁剪 + 直接总结 + 最小可用上下文）。
- **性能优化回归**：所有优化需绑定指标与对比报告。

## 执行与协作方式

- 不在中途停下来询问，按节点落地并验证测试。
- 每个节点完成后更新 `docs/功能迭代.md`，必要时同步 `docs/设计方案.md`、`docs/API文档.md`、`docs/系统介绍.md`。
- 所有改动必须记录关键指标与回归结果。


