# 阶段1-3优化执行清单

> 目标：围绕“关键链路去阻塞（阶段1）/监控生命周期与可靠性（阶段2）/工程治理与质量基线（阶段3）”完成一轮可落地改造。

## 阶段1：关键路径去阻塞（Storage 同步调用降噪）

- [x] S1-1 在鉴权中间件中将 token 鉴权与组织查询改为 `spawn_blocking` 执行，避免阻塞 Tokio worker。
- [x] S1-2 在 `resolve_user` 热路径中将 token 鉴权与用户查询改为非阻塞桥接（`spawn_blocking`）。
- [x] S1-3 在网关握手链路中将节点 token 更新改为后台阻塞任务执行，避免 WS 事件循环被同步 I/O 拉长。

**验收标准**

- 关键 async 热路径不再直接执行同步存储调用。
- 行为保持兼容：鉴权逻辑、返回结构、权限判定不变。

## 阶段2：监控数据生命周期与可靠性

- [x] S2-1 新增“最近监控记录”存储接口，支持按 `updated_time` 倒序限量读取。
- [x] S2-2 `warm_history` 改为“限量预热”策略，避免启动/冷加载全表扫描。
- [x] S2-3 监控写队列在满队列时由“直接丢弃”改为“同步回退写入 + 告警计数”，优先保障关键记录不丢失。

**验收标准**

- 监控冷启动与历史加载不再默认全量读取。
- 队列拥塞时仍可持久化关键监控记录（允许性能退化，不允许静默丢数据）。

## 阶段3：工程治理与质量基线

- [x] S3-1 修复当前 clippy 报警（`collapsible_if`、`needless_borrow`、`items_after_test_module`、`too_many_arguments`、测试中的 `useless_conversion`）。
- [x] S3-2 保持 `cargo fmt`、`cargo test --all-targets`、`cargo clippy --all-targets -- -D warnings` 通过。

**验收标准**

- 质量门禁命令全部通过。
- 行为一致，无新增回归测试失败。

## 实施记录

- 状态：已完成
- 负责人：Codex
- 开始日期：2026-02-08
- 完成日期：2026-02-08
