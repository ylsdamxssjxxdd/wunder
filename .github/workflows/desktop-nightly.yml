name: Desktop Nightly

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: wunder-desktop-nightly
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_date: ${{ steps.meta.outputs.build_date }}
      nightly_version: ${{ steps.meta.outputs.nightly_version }}
    steps:
      - uses: actions/checkout@v4

      - id: meta
        shell: bash
        run: |
          set -euo pipefail
          build_date="$(date -u +'%Y%m%d')"
          build_stamp="$(date -u +'%Y%m%d%H%M%S')"
          base_version="$(python -c 'import json, pathlib; print(json.loads(pathlib.Path("wunder-desktop-electron/package.json").read_text(encoding="utf-8"))["version"])')"
          base_core="${base_version%%-*}"
          IFS='.' read -r major minor patch <<<"$base_core"
          if [[ -z "${major:-}" || -z "${minor:-}" || -z "${patch:-}" ]]; then
            echo "Invalid base version: $base_version" >&2
            exit 1
          fi
          nightly_patch=$((patch + 1))
          nightly_version="${major}.${minor}.${nightly_patch}-nightly.${build_stamp}"
          echo "build_date=${build_date}" >> "$GITHUB_OUTPUT"
          echo "nightly_version=${nightly_version}" >> "$GITHUB_OUTPUT"

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            wunder-desktop-electron/package-lock.json

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build frontend
        working-directory: frontend
        shell: pwsh
        run: |
          npm ci
          npm run build

      - name: Build bridge and package Electron (Windows x64)
        shell: pwsh
        run: |
          cargo build --release --bin wunder-desktop-bridge
          $bridge = Join-Path $env:GITHUB_WORKSPACE "target\release\wunder-desktop-bridge.exe"
          $nightlyVersion = "${{ needs.prepare.outputs.nightly_version }}"
          if (-not (Test-Path $bridge)) { throw "Bridge not found: $bridge" }
          $outDir = Join-Path $env:GITHUB_WORKSPACE "target\nightly\windows-x64"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          Push-Location (Join-Path $env:GITHUB_WORKSPACE "wunder-desktop-electron")
          npm ci
          $env:WUNDER_BRIDGE_BIN = $bridge
          npm run prepare:resources
          npx electron-builder --win --x64 --publish=never --config.directories.output="$outDir" "--config.extraMetadata.version=$nightlyVersion"
          Pop-Location

      - name: Rename Windows artifacts
        shell: pwsh
        run: |
          $date = "${{ needs.prepare.outputs.build_date }}"
          $dist = Join-Path $env:GITHUB_WORKSPACE "target\nightly\windows-x64"
          $out = Join-Path $env:GITHUB_WORKSPACE "release-assets\windows"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $installer = Get-ChildItem -Path $dist -File -Filter "*.exe" | Sort-Object Length -Descending | Select-Object -First 1
          if (-not $installer) { throw "No Windows installer found in $dist" }
          Copy-Item $installer.FullName (Join-Path $out $installer.Name)
          Copy-Item $installer.FullName (Join-Path $out "Wunder-Desktop-win-x64-$date.exe")

          $latest = Join-Path $dist "latest.yml"
          if (Test-Path $latest) {
            Copy-Item $latest (Join-Path $out "latest.yml")
          } else {
            throw "latest.yml not found in $dist"
          }

          $blockmap = Join-Path $dist "$($installer.Name).blockmap"
          if (Test-Path $blockmap) {
            Copy-Item $blockmap (Join-Path $out "$($installer.Name).blockmap")
          }

      - uses: actions/upload-artifact@v4
        with:
          name: nightly-windows
          path: release-assets/windows/*
          if-no-files-found: error
          retention-days: 7

  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            wunder-desktop-electron/package-lock.json

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build frontend
        working-directory: frontend
        shell: bash
        run: |
          npm ci
          npm run build

      - name: Build bridge and package Electron (macOS)
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --bin wunder-desktop-bridge
          bridge="$GITHUB_WORKSPACE/target/release/wunder-desktop-bridge"
          if [ ! -x "$bridge" ]; then
            echo "Bridge not found: $bridge" >&2
            exit 1
          fi
          out_dir="$GITHUB_WORKSPACE/target/nightly/macos"
          mkdir -p "$out_dir"
          cd "$GITHUB_WORKSPACE/wunder-desktop-electron"
          npm ci
          WUNDER_BRIDGE_BIN="$bridge" npm run prepare:resources
          CSC_IDENTITY_AUTO_DISCOVERY=false \
            npx electron-builder --mac --x64 --arm64 --publish=never --config.directories.output="$out_dir" \
              --config.extraMetadata.version="${{ needs.prepare.outputs.nightly_version }}"

      - name: Rename macOS artifacts
        shell: bash
        run: |
          set -euo pipefail
          DATE="${{ needs.prepare.outputs.build_date }}"
          DIST="$GITHUB_WORKSPACE/target/nightly/macos"
          OUT="$GITHUB_WORKSPACE/release-assets/macos"
          mkdir -p "$OUT"

          shopt -s nullglob
          for dmg in "$DIST"/*.dmg; do
            name="$(basename "$dmg")"
            arch="universal"
            if [[ "$name" == *arm64* ]]; then
              arch="arm64"
            elif [[ "$name" == *x64* ]]; then
              arch="x64"
            fi
            cp "$dmg" "$OUT/Wunder-Desktop-macos-${arch}-${DATE}.dmg"
          done

          for zip in "$DIST"/*.zip; do
            cp "$zip" "$OUT/$(basename "$zip")"
          done

          for yml in "$DIST"/latest*.yml; do
            cp "$yml" "$OUT/$(basename "$yml")"
          done

          for blockmap in "$DIST"/*.blockmap; do
            cp "$blockmap" "$OUT/$(basename "$blockmap")"
          done

          count=$(find "$OUT" -maxdepth 1 -type f -name "*.dmg" | wc -l | tr -d ' ')
          if [ "$count" -eq 0 ]; then
            echo "No macOS dmg found in $DIST" >&2
            exit 1
          fi
          zip_count=$(find "$OUT" -maxdepth 1 -type f -name "*.zip" | wc -l | tr -d ' ')
          if [ "$zip_count" -eq 0 ]; then
            echo "No macOS zip found in $DIST" >&2
            exit 1
          fi
          yml_count=$(find "$OUT" -maxdepth 1 -type f -name "latest*.yml" | wc -l | tr -d ' ')
          if [ "$yml_count" -eq 0 ]; then
            echo "No macOS update yml found in $DIST" >&2
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: nightly-macos
          path: release-assets/macos/*
          if-no-files-found: error
          retention-days: 7

  build-linux-x64:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            .cargo/x86-20-ci/registry
            .cargo/x86-20-ci/git
            target/x86-20-ci
            .npm-cache/linux-x64
          key: ${{ runner.os }}-desktop-linux-x64-${{ hashFiles('Cargo.lock', 'frontend/package-lock.json', 'wunder-desktop-electron/package-lock.json', 'docker-extra/scripts/ci_build_linux_electron.sh', 'docker-extra/Dockerfile.ubuntu20-x86') }}
          restore-keys: |
            ${{ runner.os }}-desktop-linux-x64-

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker-extra/Dockerfile.ubuntu20-x86
          platforms: linux/amd64
          tags: wunder-x86-20-ci:latest
          load: true
          cache-from: type=gha,scope=wunder-linux-x64-image
          cache-to: type=gha,mode=max,scope=wunder-linux-x64-image

      - name: Build bridge and package Electron (Linux x64 on Ubuntu20 base)
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/app" \
            -w /app \
            -e ARCH=x64 \
            -e CARGO_HOME=/app/.cargo/x86-20-ci \
            -e CARGO_TARGET_DIR=/app/target/x86-20-ci \
            -e NPM_CONFIG_CACHE=/app/.npm-cache/linux-x64 \
            -e OUTPUT_DIR=/app/target/nightly/linux-x64 \
            -e NIGHTLY_VERSION=${{ needs.prepare.outputs.nightly_version }} \
            wunder-x86-20-ci:latest \
            bash /app/docker-extra/scripts/ci_build_linux_electron.sh

      - name: Rename Linux x64 artifact
        shell: bash
        run: |
          set -euo pipefail
          DATE="${{ needs.prepare.outputs.build_date }}"
          DIST="$GITHUB_WORKSPACE/target/nightly/linux-x64"
          OUT="$GITHUB_WORKSPACE/release-assets/linux-x64"
          mkdir -p "$OUT"
          APPIMAGE="$(find "$DIST" -maxdepth 1 -type f -name "*.AppImage" | head -n 1 || true)"
          if [ -z "$APPIMAGE" ]; then
            echo "No Linux x64 AppImage found in $DIST" >&2
            exit 1
          fi
          cp "$APPIMAGE" "$OUT/$(basename "$APPIMAGE")"
          cp "$APPIMAGE" "$OUT/Wunder-Desktop-linux-x86_64-${DATE}.AppImage"
          shopt -s nullglob
          yml_count=0
          for yml in "$DIST"/latest*.yml; do
            cp "$yml" "$OUT/$(basename "$yml")"
            yml_count=$((yml_count + 1))
          done
          for blockmap in "$DIST"/*.blockmap; do
            cp "$blockmap" "$OUT/$(basename "$blockmap")"
          done
          if [ "$yml_count" -eq 0 ]; then
            echo "No Linux x64 update yml found in $DIST" >&2
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: nightly-linux-x64
          path: release-assets/linux-x64/*
          if-no-files-found: error
          retention-days: 7

  build-linux-arm64:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            .cargo/arm64-20-ci/registry
            .cargo/arm64-20-ci/git
            target/arm64-20-ci
            .npm-cache/linux-arm64
          key: ${{ runner.os }}-desktop-linux-arm64-${{ hashFiles('Cargo.lock', 'frontend/package-lock.json', 'wunder-desktop-electron/package-lock.json', 'docker-extra/scripts/ci_build_linux_electron.sh', 'docker-extra/Dockerfile.ubuntu20-arm') }}
          restore-keys: |
            ${{ runner.os }}-desktop-linux-arm64-

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker-extra/Dockerfile.ubuntu20-arm
          platforms: linux/arm64
          tags: wunder-arm-20-ci:latest
          load: true
          cache-from: type=gha,scope=wunder-linux-arm64-image
          cache-to: type=gha,mode=max,scope=wunder-linux-arm64-image

      - name: Build bridge and package Electron (Linux arm64 on Ubuntu20 base)
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm --platform linux/arm64 \
            -v "$GITHUB_WORKSPACE:/app" \
            -w /app \
            -e ARCH=arm64 \
            -e CARGO_HOME=/app/.cargo/arm64-20-ci \
            -e CARGO_TARGET_DIR=/app/target/arm64-20-ci \
            -e NPM_CONFIG_CACHE=/app/.npm-cache/linux-arm64 \
            -e OUTPUT_DIR=/app/target/nightly/linux-arm64 \
            -e NIGHTLY_VERSION=${{ needs.prepare.outputs.nightly_version }} \
            wunder-arm-20-ci:latest \
            bash /app/docker-extra/scripts/ci_build_linux_electron.sh

      - name: Rename Linux arm64 artifact
        shell: bash
        run: |
          set -euo pipefail
          DATE="${{ needs.prepare.outputs.build_date }}"
          DIST="$GITHUB_WORKSPACE/target/nightly/linux-arm64"
          OUT="$GITHUB_WORKSPACE/release-assets/linux-arm64"
          mkdir -p "$OUT"
          APPIMAGE="$(find "$DIST" -maxdepth 1 -type f -name "*.AppImage" | head -n 1 || true)"
          if [ -z "$APPIMAGE" ]; then
            echo "No Linux arm64 AppImage found in $DIST" >&2
            exit 1
          fi
          cp "$APPIMAGE" "$OUT/$(basename "$APPIMAGE")"
          cp "$APPIMAGE" "$OUT/Wunder-Desktop-linux-arm64-${DATE}.AppImage"
          shopt -s nullglob
          yml_count=0
          for yml in "$DIST"/latest*.yml; do
            cp "$yml" "$OUT/$(basename "$yml")"
            yml_count=$((yml_count + 1))
          done
          for blockmap in "$DIST"/*.blockmap; do
            cp "$blockmap" "$OUT/$(basename "$blockmap")"
          done
          if [ "$yml_count" -eq 0 ]; then
            echo "No Linux arm64 update yml found in $DIST" >&2
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: nightly-linux-arm64
          path: release-assets/linux-arm64/*
          if-no-files-found: error
          retention-days: 7

  release-nightly:
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-linux-x64
      - build-linux-arm64
    if: >-
      ${{ always() && (
        needs.build-windows.result == 'success' ||
        needs.build-macos.result == 'success' ||
        needs.build-linux-x64.result == 'success' ||
        needs.build-linux-arm64.result == 'success'
      ) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          pattern: nightly-*
          path: release-assets
          merge-multiple: true

      - name: Move nightly tag to current commit
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa nightly -m "Nightly build ${GITHUB_SHA}" "${GITHUB_SHA}"
          git push origin refs/tags/nightly --force

      - name: Remove old nightly assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if gh release view nightly --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            assets="$(gh release view nightly --repo "${GITHUB_REPOSITORY}" --json assets -q '.assets[].name' || true)"
            if [ -n "${assets}" ]; then
              while IFS= read -r asset; do
                [ -z "${asset}" ] && continue
                gh release delete-asset nightly "${asset}" --repo "${GITHUB_REPOSITORY}" -y || true
              done <<< "${assets}"
            fi
          fi

      - name: Publish nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Wunder Desktop Nightly
          target_commitish: ${{ github.sha }}
          prerelease: true
          make_latest: false
          overwrite_files: true
          files: |
            release-assets/*
          body: |
            Build date (UTC): ${{ needs.prepare.outputs.build_date }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
