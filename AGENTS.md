# 仓库指南

- wunder 是一个面向组织或用户的智能体调度系统，wunder拥有三种运行形态：server（服务，云端）、cli（命令行，本地）、desktop（桌面，本地），三种形态可各自独立运行或分发。server是项目核心，支持多租户、用户与单位管理、智能体应用构建与发布、网关统一接入与调度，并内置工具链、知识库与长期记忆能力。cli与desktop基于server构建。
- 核心理念是对开发者来说一切都是接口，对大模型来说一切皆工具
- 基于 Rust Axum 最终暴露出 /wunder端口 需要用户id和用户问题，可流式返回中间过程和最终回复
- wunder内置了一组必要的工具链用于基本操作，例如读文件，写文件，编辑文件，搜索内容，列出文件，替换内容，执行命令，ptc等工具
- wunder可供多人并发访问，系统会为不同id用户开辟一块空间作为工作区，这些工作区将持久化
- 注意保持优雅的项目结构和模块组成
- 始终要考虑系统的运行效率，速度要快，内存占用要低
- 每次完成任务，将实现内容写入 `docs/功能迭代.md` 的分类区块，使用 `python scripts/update_feature_log.py --type <类型> --scope <范围> ...`；类型仅限：新增/变更/修复/性能/文档/重构/安全/工程/测试/移除/弃用。
- 如果系统结构或重要的部分有变化要及时更新docs/设计方案.md和docs/API文档.md和docs/系统介绍.md等文档。
- 不要尝试创建git分支或提交，这些交给用户
- 不要主动使用git除非必须，你git diff时可能会遇到出现了不是你修改的内容，没关系那是用户自己改的不用管他
- 当前开发处于原型阶段，数据库等不需要考虑对之前的兼容性，老旧的代码直接删除即可
- 注意系统中对token的统计，记录的是token占用量即实际的上下文占用而不是总的消耗量。
- 确保系统能流畅稳定运行10年以上
- python后端即app目录现在只用来支持沙盒运行，不必再维护，只维护src下的rust代码即可
- 文件统一使用 UTF-8 编码保存，避免 ANSI/GBK 混用导致中文乱码
- 注意data目录是临时的不要在里面存东西
- wunder-server 系统使用postgres作为数据库，sqlite3只做测试用，不需要优化
- 区分用户侧前端（frontend目录，vue3实现） 管理员侧前端（web目录，html实现）
- 智能体线程的创建用户（可以是任意虚构的名称）和实际注册用户（用户管理页面控制）注意区分开，确保/wunder接口可以顺畅调用，传入的用户id不需要是已注册的用户
- frontend中有大量的依赖库，搜索时会返回大量内容，一定要做好限制，不要直接搜索frontend的根目录
- 前端不要使用backdrop-filter样式，这在老的浏览器中会很卡
- 用户侧前端维护了浅/深两套主题，在修改界面时注意整体考虑页面搭配，避免颜色不适配的情况
- 会话轮次拆分为“用户轮次/模型轮次”：用户每发送一条消息记 1 轮用户轮次；模型每执行一次动作（模型调用、工具调用或最终回复）记 1 轮模型轮次；一次会话可包含多轮用户轮次，每轮用户轮次可包含多轮模型轮次。
- 各种通讯的实现以WebSocket为先，SSE作为兜底
- 可以参考skills/wunder-agent-dev进行wunder系统的开发工作，并且在每次你彻底完成用户的任务后，可以将你任务有价值，技能里没有记载但对后期开发有必要的文字和脚本等资源补充进来。
- 你在开发的过程中，其他开发者也会在修改文件，如果你遇到了不是你修改的文件，不必理会

## Rust 开发提示

- format! 中可以内联变量时使用 `{var}`，避免额外参数。
- 能合并的 if 语句请合并（clippy::collapsible_if）。
- 能用方法引用时优先用方法引用，减少多余闭包（clippy::redundant_closure_for_method_calls）。
- 测试中优先对完整对象做 `assert_eq!`，避免逐字段对比。
- Rust 代码变更完成后记得运行 `cargo check` 要消除所有错误和告警，必要时运行 `cargo clippy`。
